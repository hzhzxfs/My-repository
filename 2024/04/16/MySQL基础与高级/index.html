<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="MySQL," />





  <link rel="alternate" href="/atom.xml" title="XHJ" type="application/atom+xml" />






<meta name="description" content="目录[TOC] Mysql基础数据库相关概念数据库的好处 持久化数据到本地 可以实现结构化查询，方便管理  数据库常见名词解释 DB：数据库，保存一组有组织的数据的容器 DBMS：数据库管理系统，又称为数据库软件（产品），用于管理DB中的数据 SQL:结构化查询语言，用于和DBMS通信的语言，不是某个数据库软件特有的，而是几乎所有的主流数据库软件通用的语言  数据库存储数据的特点 将数据放到表中，">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL基础与高级">
<meta property="og:url" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/index.html">
<meta property="og:site_name" content="XHJ">
<meta property="og:description" content="目录[TOC] Mysql基础数据库相关概念数据库的好处 持久化数据到本地 可以实现结构化查询，方便管理  数据库常见名词解释 DB：数据库，保存一组有组织的数据的容器 DBMS：数据库管理系统，又称为数据库软件（产品），用于管理DB中的数据 SQL:结构化查询语言，用于和DBMS通信的语言，不是某个数据库软件特有的，而是几乎所有的主流数据库软件通用的语言  数据库存储数据的特点 将数据放到表中，">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200710152909978.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200710165318361.png">
<meta property="og:image" content="https://img.jbzj.com/file_images/article/201412/Visual_SQL_JOINS_small.jpg">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200710225810242.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200711073654105.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200711073725523.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200711073826886.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/249993/201705/249993-20170517160113541-995629282.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/249993/201705/249993-20170518153741385-231278940.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200711122028372.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200711155821807.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200711160310180.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200711160340474.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200711160906372.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200711180610660.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200711234355239.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200712000621185.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713112111054.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713112217844.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713113310184.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713115753385.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713121235428.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713121959283.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713123647170.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713132540818.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713120608468.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200712222235244.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200712222156186.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200712230254020.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713101850899.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713104521260.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713104937740.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200714003335546.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200714011629886.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200714093801832.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200714105046057.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200714105419116.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200714111915664.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200714125910179.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200714152756130.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200714154245129.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200714154322988.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200714154508848.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200714160456238.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200714161847506.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200714163036965.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200714162953374.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200714165832912.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/706569-20180630100101056-666555235.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/706569-20180630103727168-1004774476.png">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/706569/201806/706569-20180630111240913-127840494.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200714190044468.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200714190451967.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL基础.assets/image-20200714190547373.png">
<meta property="og:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7.assets/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9ZcmV6eGNraFlPeHcya3MxQ2xOSzNqM21JUElqOVB5SEJYUHZiSFd3R0toWkV5dzd6YWpQejdpYkw0M2wyQ3BaVm9laWNRTVdMaWFLeENpY2I1b09EazZLU1EvNjQw">
<meta property="article:published_time" content="2024-04-16T13:30:38.000Z">
<meta property="article:modified_time" content="2024-06-01T07:16:04.101Z">
<meta property="article:author" content="xhj">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/MySQL%E5%9F%BA%E7%A1%80.assets/image-20200710152909978.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/2024/04/16/MySQL基础与高级/"/>





  <title>MySQL基础与高级 | XHJ</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">XHJ</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XHJ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MySQL基础与高级</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-04-16T21:30:38+08:00">
                2024-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Database/" itemprop="url" rel="index">
                    <span itemprop="name">Database</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2024/04/16/MySQL基础与高级/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  28.3k
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><p>[TOC]</p>
<h1 id="Mysql基础"><a href="#Mysql基础" class="headerlink" title="Mysql基础"></a>Mysql基础</h1><h2 id="数据库相关概念"><a href="#数据库相关概念" class="headerlink" title="数据库相关概念"></a>数据库相关概念</h2><h3 id="数据库的好处"><a href="#数据库的好处" class="headerlink" title="数据库的好处"></a>数据库的好处</h3><ol>
<li>持久化数据到本地</li>
<li>可以实现结构化查询，方便管理</li>
</ol>
<h3 id="数据库常见名词解释"><a href="#数据库常见名词解释" class="headerlink" title="数据库常见名词解释"></a>数据库常见名词解释</h3><ol>
<li>DB：数据库，保存一组有组织的数据的容器</li>
<li>DBMS：数据库管理系统，又称为数据库软件（产品），用于管理DB中的数据</li>
<li>SQL:结构化查询语言，用于和DBMS通信的语言，不是某个数据库软件特有的，而是几乎所有的主流数据库软件通用的语言</li>
</ol>
<h3 id="数据库存储数据的特点"><a href="#数据库存储数据的特点" class="headerlink" title="数据库存储数据的特点"></a>数据库存储数据的特点</h3><ol>
<li>将数据放到表中，表再放到库中</li>
<li>一个数据库中可以有多个表，每个表都有一个的名字，用来标识自己。表名具有唯一性。</li>
<li>表具有一些特性，这些特性定义了数据在表中如何存储，类似java中 “类”的设计。</li>
<li>表由列组成，我们也称为字段。所有表都是由一个或多个列组成的，每一列类似java 中的”属性”</li>
<li>表中的数据是按行存储的，每一行类似于java中的“对象”。</li>
</ol>
<h3 id="常见数据库"><a href="#常见数据库" class="headerlink" title="常见数据库"></a>常见数据库</h3><p>mysql、oracle、db2、sqlserver</p>
<h2 id="MySQL产品的介绍和安装"><a href="#MySQL产品的介绍和安装" class="headerlink" title="MySQL产品的介绍和安装"></a>MySQL产品的介绍和安装</h2><h3 id="MySQL背景"><a href="#MySQL背景" class="headerlink" title="MySQL背景"></a>MySQL背景</h3><p>前身属于瑞典的一家公司，MySQL AB<br>08年被sun公司收购<br>09年sun被oracle收购</p>
<h3 id="MySQL的优点"><a href="#MySQL的优点" class="headerlink" title="MySQL的优点"></a>MySQL的优点</h3><p>1、开源、免费、成本低<br>2、性能高、移植性也好<br>3、体积小，便于安装</p>
<h3 id="Windows上使用"><a href="#Windows上使用" class="headerlink" title="Windows上使用"></a>Windows上使用</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>如果之前没有安装的mysql，则可以直接在官网上下载，使用exe安装。建议下载版本mysql5.5</p>
<p><a target="_blank" rel="noopener" href="https://downloads.mysql.com/archives/community/">下载网址</a></p>
<h4 id="MySQL数据库管理系统的卸载"><a href="#MySQL数据库管理系统的卸载" class="headerlink" title="MySQL数据库管理系统的卸载"></a>MySQL数据库管理系统的卸载</h4><p>如果以前安装过mysql，虽然卸载了，但是安装时出现问题，尝试按下面步骤</p>
<ol>
<li>卸载程序</li>
<li>删除安装目录</li>
<li>删除C:/ProgramData目录下mysql文件夹</li>
<li>卸载服务<ol>
<li>删除注册表中以下文件夹，如果没有相关的注册表信息可以直接忽略<br>HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Eventlog\Application\MySQL文件夹；HKEY_LOCAL_MACHINE\SYSTEM\ControlSet002\Services\Eventlog\Application\MySQL文件夹。HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Eventlog\Application\MySQL的文件夹。</li>
<li>卸载服务<ol>
<li>win7系统，以管理员方式，执行命令 sc delete 服务名</li>
<li>win10系统，删除注册表中 HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services 目录下对应服务名文件夹</li>
</ol>
</li>
<li>重启电脑</li>
</ol>
</li>
</ol>
<h4 id="MySQL服务的启动和停止"><a href="#MySQL服务的启动和停止" class="headerlink" title="MySQL服务的启动和停止"></a>MySQL服务的启动和停止</h4><ul>
<li>计算机——右击管理——服务</li>
<li>通过<strong>管理员身份</strong>运行<br>​    net start 服务名（启动服务）<br>​    net stop 服务名（停止服务）</li>
</ul>
<h4 id="登录和退出"><a href="#登录和退出" class="headerlink" title="登录和退出"></a>登录和退出</h4><ul>
<li>通过mysql自带的客户端<pre><code>只限于root用户
</code></pre>
</li>
<li>通过windows自带的客户端</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">登录：参数后面没有空格</span><br><span class="line">mysql 【-h主机名 -P端口号 】-u用户名 -p密码</span><br><span class="line"></span><br><span class="line">退出：</span><br><span class="line">exit或ctrl+C</span><br></pre></td></tr></table></figure>



<h4 id="自定义MySQL的配置"><a href="#自定义MySQL的配置" class="headerlink" title="自定义MySQL的配置"></a>自定义MySQL的配置</h4><p>修改MySQL安装目录下的my.ini文件，并重启服务</p>
<p>常见的配置有字符集</p>
<h3 id="Linux上使用"><a href="#Linux上使用" class="headerlink" title="Linux上使用"></a>Linux上使用</h3><p>以Centos7举例</p>
<h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><p><strong>检查是否安装过mysql</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa|grep mysql</span><br><span class="line">rpm -qa|grep mariadb</span><br></pre></td></tr></table></figure>

<p>默认 Linux（CentOS7） 在安装的时候， 自带了 mariadb(mysql 完全开源版本)相关的组件。</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200710152909978.png" alt="image-20200710152909978"></p>
<p><strong>如果系统中存在软件，强制卸载</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -e --nodeps mysql-libs  </span><br><span class="line">rpm -e --nodeps mariadb-libs</span><br></pre></td></tr></table></figure>

<p><strong>更改/tmp文件夹权限</strong></p>
<p>mysql安装时，会通过mysql用户在/tmp目录下新建一个tmp_db文件，所以需要给/tmp文件夹赋予更大的权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod -R 777 /tmp</span><br></pre></td></tr></table></figure>

<p><strong>下载rpm安装包到/opt目录下</strong></p>
<p>建议下载版本mysql5.5，注意linux是32位还是64位</p>
<p><a target="_blank" rel="noopener" href="https://downloads.mysql.com/archives/community/">下载网址</a></p>
<p><strong>在/opt目录下执行安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 客户端和服务端</span></span><br><span class="line">rpm -ivh MySQL-client-5.5.54-1.linux2.6.x86_64.rpm</span><br><span class="line">rpm -ivh MySQL-server-5.5.54-1.linux2.6.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p><strong>检查是否安装成功</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin --version</span><br></pre></td></tr></table></figure>

<p><strong>设置mysql密码</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/user/bin/mysqladmin –u root password 123456</span><br></pre></td></tr></table></figure>

<p><strong>查看安装目录</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef|grep mysql</span><br></pre></td></tr></table></figure>

<img src="MySQL基础.assets/image-20200710165318361.png" alt="image-20200710165318361" style="zoom:67%;" />

<h4 id="启动和关闭服务"><a href="#启动和关闭服务" class="headerlink" title="启动和关闭服务"></a>启动和关闭服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看服务状态</span></span><br><span class="line">service mysql status</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动服务</span></span><br><span class="line">service mysql start</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止服务</span></span><br><span class="line">service mysql stop</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启服务</span></span><br><span class="line">service mysql restart</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开机自启动</span></span><br><span class="line">chkconfig mysql on</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭开启自启动</span></span><br><span class="line">ntsysv</span><br><span class="line">使用空格键取消，使用Enter键确认</span><br></pre></td></tr></table></figure>



<h4 id="登录和退出-1"><a href="#登录和退出-1" class="headerlink" title="登录和退出"></a>登录和退出</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 登录</span></span><br><span class="line">mysql -uroot -p123456</span><br><span class="line"><span class="meta">#</span><span class="bash"> 退出</span></span><br><span class="line">exit或ctrl+C</span><br></pre></td></tr></table></figure>



<h4 id="自定义Mysql配置"><a href="#自定义Mysql配置" class="headerlink" title="自定义Mysql配置"></a>自定义Mysql配置</h4><p>在/usr/share/mysql/ 中找到 my-huge.cnf 的配置文件， 拷贝到 /etc/ 并命名为 my.cnf ，mysql优先选择/etc/下的配置文件。 添加以下内容后再重启服务。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">default-character-set&#x3D;utf8</span><br><span class="line">[mysqld]</span><br><span class="line">character_set_server&#x3D;utf8</span><br><span class="line">character_set_client&#x3D;utf8</span><br><span class="line">collation-server&#x3D;utf8_general_ci</span><br><span class="line">[mysql]</span><br><span class="line">default-character-set&#x3D;utf8</span><br></pre></td></tr></table></figure>

<p>注意： <strong>已经创建的数据库</strong>的设定不会发生变化， 参数修改只对新建的数据库有效！  </p>
<p><strong>修改已创建库、 表字符集</strong><br>修改数据库的字符集</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter database mydb character set &#39;utf8&#39;;</span><br></pre></td></tr></table></figure>

<p>修改数据表的字符集</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table mytbl convert to character set &#39;utf8&#39;;  </span><br></pre></td></tr></table></figure>

<p><strong>修改已经乱码数据</strong></p>
<p>无论是修改 mysql 配置文件或是修改库、 表字符集， 都<strong>无法改变</strong>已经变成乱码的数据。<br>只能删除数据重新插入或更新数据才可以完全解决  </p>
<h3 id="MySQL的常见命令"><a href="#MySQL的常见命令" class="headerlink" title="MySQL的常见命令"></a>MySQL的常见命令</h3><pre><code>1.查看当前所有的数据库
show databases;
mysql:保存用户信息(身份信息,自定义函数、存储过程)
information_schema:保存元数据信息
test:测试信息
performance_schema:监控mysql内部运行情况

2.打开指定的库
use 库名

3.查看当前库的所有表
show tables;

4.查看其它库的所有表
show tables from 库名;

5.创建表
create table 表名(

    列名 列类型,
    列名 列类型，
    。。。
);

6.查看表结构
desc 表名;

7.查看服务器的版本
方式一：登录到mysql服务端
select version();
方式二：没有登录到mysql服务端
mysql --version
或
mysql --V
</code></pre>
<h3 id="MySQL的语法规范"><a href="#MySQL的语法规范" class="headerlink" title="MySQL的语法规范"></a>MySQL的语法规范</h3><ol>
<li>不区分大小写,但建议关键字大写，表名、列名小写</li>
<li>每条命令最好用分号结尾</li>
<li>每条命令根据需要，可以进行缩进 或换行</li>
<li>注释<ol>
<li>单行注释：#注释文字</li>
<li>单行注释：– 注释文字</li>
<li>多行注释：/* 注释文字  */</li>
</ol>
</li>
</ol>
<p>​    </p>
<h3 id="SQL的语言分类"><a href="#SQL的语言分类" class="headerlink" title="SQL的语言分类"></a>SQL的语言分类</h3><p>​    DQL（Data Query Language）：数据查询语言<br>​        select<br>​    DML(Data Manipulate Language):数据操作语言<br>​        insert 、update、delete<br>​    DDL（Data Define Languge）：数据定义语言<br>​        create、drop、alter<br>​    TCL（Transaction Control Language）：事务控制语言<br>​        commit、rollback<br>​    </p>
<h3 id="SQL的常见命令"><a href="#SQL的常见命令" class="headerlink" title="SQL的常见命令"></a>SQL的常见命令</h3><pre><code>show databases； 查看所有的数据库
use 库名； 打开指定 的库
show tables ; 显示库中的所有表
show tables from 库名;显示指定库中的所有表
create table 表名(
    字段名 字段类型,    
    字段名 字段类型
); 创建表

desc 表名; 查看指定表的结构
select * from 表名;显示表中的所有数据
</code></pre>
<h2 id="DQL语言的学习"><a href="#DQL语言的学习" class="headerlink" title="DQL语言的学习"></a>DQL语言的学习</h2><p>Database Query Language</p>
<h3 id="进阶1：基础查询"><a href="#进阶1：基础查询" class="headerlink" title="进阶1：基础查询"></a>进阶1：基础查询</h3><p><strong>语法</strong></p>
<ul>
<li>SELECT 要查询的东西 FROM 表名;</li>
<li>类似于Java中 :System.out.println(要打印的东西);</li>
</ul>
<p><strong>特点</strong></p>
<ol>
<li>通过select查询完的结果，是一个虚拟的表格，不是真实存在</li>
<li>要查询的东西 可以是常量值、可以是表达式、可以是字段、可以是函数</li>
</ol>
<p>==建议再编写sql脚本时，在最前面先写上切换库命令 USE myDataBase==</p>
<p><strong>示例</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">1、查询单个字段</span><br><span class="line">	select 字段名 from 表名;</span><br><span class="line">2、查询多个字段</span><br><span class="line">	select 字段名，字段名 from 表名;</span><br><span class="line">3、查询所有字段</span><br><span class="line">	select * from 表名</span><br><span class="line">4、查询常量</span><br><span class="line">	select 常量值;</span><br><span class="line">	注意：字符型和日期型的常量值必须用单引号引起来，数值型不需要</span><br><span class="line">5、查询函数</span><br><span class="line">	select 函数名(实参列表);</span><br><span class="line">6、查询表达式</span><br><span class="line">	select 100&#x2F;1234;</span><br><span class="line">7、起别名</span><br><span class="line">	as</span><br><span class="line">	空格</span><br><span class="line">8、去重distinct</span><br><span class="line">	select distinct 字段名 from 表名;</span><br><span class="line">9、+</span><br><span class="line">	作用：做加法运算</span><br><span class="line">	select 数值+数值 直接运算</span><br><span class="line">	select 字符+数值 先试图将字符转换成数值，如果转换成功，则继续运算；否则转换成0，再做运算</span><br><span class="line">	select null+值  结果都为null</span><br><span class="line">10、concat函数</span><br><span class="line">	功能：拼接字符</span><br><span class="line">	select concat(字符1，字符2，字符3,...);</span><br><span class="line">11、ifnull函数</span><br><span class="line">	功能：判断某字段或表达式是否为null，如果为null 返回指定的值，否则返回原本的值</span><br><span class="line">	select ifnull(commission_pct,0) from employees;</span><br><span class="line">12、isnull函数</span><br><span class="line">	功能：判断某字段或表达式是否为null，如果是，则返回1，否则返回0</span><br></pre></td></tr></table></figure>



<h3 id="进阶2：条件查询"><a href="#进阶2：条件查询" class="headerlink" title="进阶2：条件查询"></a>进阶2：条件查询</h3><p>条件查询：根据条件过滤原始表的数据，查询到想要的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">	select </span><br><span class="line">		要查询的字段|表达式|常量值|函数</span><br><span class="line">	from </span><br><span class="line">		表</span><br><span class="line">	where </span><br><span class="line">		条件 ;</span><br><span class="line"></span><br><span class="line">一、条件表达式</span><br><span class="line">	条件运算符：</span><br><span class="line">		&gt; &lt; &gt;&#x3D; &lt;&#x3D; &#x3D; !&#x3D; &lt;&gt;</span><br><span class="line">			a &gt;&#x3D; 100</span><br><span class="line">		between...and...  表示[left,right] 等价于 &gt;&#x3D;left&amp;&lt;&#x3D;right</span><br><span class="line">			id between left and right </span><br><span class="line">		in</span><br><span class="line">			id in(&#39;item1&#39;,&#39;item2&#39;,...)</span><br><span class="line">			列表中元素类型一致(相同或者兼容)</span><br><span class="line">			元素不能使用通配符</span><br><span class="line">		exists</span><br><span class="line">		is null&#x2F;is not null</span><br><span class="line">		&lt;&#x3D;&gt;</span><br><span class="line">			兼容了&#x3D;和is null</span><br><span class="line">二、逻辑表达式</span><br><span class="line">	示例：salary&gt;10000 &amp;&amp; salary&lt;20000</span><br><span class="line">	逻辑运算符：</span><br><span class="line">		and（&amp;&amp;）:两个条件如果同时成立，结果为true，否则为false</span><br><span class="line">		or(||)：两个条件只要有一个成立，结果为true，否则为false</span><br><span class="line">		not(!)：如果条件成立，则not后为false，否则为true</span><br><span class="line">三、模糊查询</span><br><span class="line">	支持正则表达式</span><br><span class="line">		last_name like &#39;%a%&#39;</span><br><span class="line">	自定义转义字符</span><br><span class="line">		last_name like &#39;$%a%&#39; ESCAPE &#39;$&#39;</span><br></pre></td></tr></table></figure>



<h3 id="进阶3：排序查询"><a href="#进阶3：排序查询" class="headerlink" title="进阶3：排序查询"></a>进阶3：排序查询</h3><pre><code>语法：
select
    要查询的东西
from
    表
where 
    条件
order by 
    排序的字段|表达式|函数|别名 【asc升序|desc降序】
    
SELECT * FORM Employee order by LENGTH(last_name) DESC;
</code></pre>
<p>案例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 查询员工的姓名、部门号和年薪，按年薪降序，按姓名升序</span><br><span class="line"><span class="keyword">SELECT</span> last_name,department_id,salary<span class="operator">*</span><span class="number">12</span><span class="operator">*</span>(IFNULL(commission_pct,<span class="number">0</span>)) 年薪 <span class="keyword">FROM</span> employees <span class="keyword">ORDER</span> <span class="keyword">BY</span> 年薪 <span class="keyword">DESC</span>,last_name <span class="keyword">ASC</span>;</span><br><span class="line"># 选择工资不在<span class="number">8000</span>到<span class="number">170000</span>的员工姓名和工资，按工资降序</span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="number">8000</span> <span class="keyword">AND</span> <span class="number">17000</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>;</span><br><span class="line"># 查询邮箱中包含e的员工信息，并先按邮箱的字节数降序，再按部门号升序</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> email <span class="keyword">like</span> <span class="string">&#x27;%e%&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> LENGTH(email) <span class="keyword">DESC</span>,department_id <span class="keyword">ASC</span>;</span><br></pre></td></tr></table></figure>



<h3 id="进阶4：常见函数"><a href="#进阶4：常见函数" class="headerlink" title="进阶4：常见函数"></a>进阶4：常见函数</h3><p>使用函数时，首先要保证有数据，如果没有数据，函数不会执行了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 这里查询了一条不能存在的数据,由于数据不存在,所以即使salary为<span class="keyword">null</span>,最终结果还是<span class="keyword">null</span>,因为函数就没执行</span><br><span class="line">    <span class="keyword">select</span> ifnull(salary,<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">from</span> employees</span><br><span class="line">    <span class="keyword">where</span> employee_id<span class="operator">=</span><span class="number">-1</span></span><br></pre></td></tr></table></figure>



<h4 id="单行函数"><a href="#单行函数" class="headerlink" title="单行函数"></a>单行函数</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、字符函数</span><br><span class="line">	length 获取字节个数</span><br><span class="line">	concat(a,b)拼接</span><br><span class="line">	substr</span><br><span class="line">		substr(str,index)截取从index开始的子串,mysql字符串索引从<span class="number">1</span>开始</span><br><span class="line">		substr(str,startIndex,endIndex)</span><br><span class="line">	upper转换成大写</span><br><span class="line">	lower转换成小写</span><br><span class="line">	trim去前后指定的空格和字符</span><br><span class="line">		<span class="built_in">trim</span>(特定字符串 <span class="keyword">FROM</span> 原始串)去除原始串前后的特定字符串</span><br><span class="line">	ltrim去左边空格</span><br><span class="line">	rtrim去右边空格</span><br><span class="line">	replace替换</span><br><span class="line">	lpad左填充</span><br><span class="line">		lpad(原始串,目标长度,填充串)</span><br><span class="line">	rpad右填充</span><br><span class="line">	instr返回子串第一次出现的索引</span><br><span class="line">	ascii(ch)获取ch的ascii码值</span><br><span class="line">	<span class="type">char</span>(num)根据ascii码值获取字符</span><br><span class="line">	<span class="built_in">cast</span> (expression <span class="keyword">AS</span> data_type) 数据类型转换函数</span><br><span class="line"><span class="number">2</span>、数学函数</span><br><span class="line">	round 四舍五入</span><br><span class="line">	rand 随机数[<span class="number">0</span>,<span class="number">1</span>) 生成[a,b]<span class="operator">=</span><span class="built_in">floor</span>(a<span class="operator">+</span>(b<span class="operator">-</span>a<span class="operator">+</span><span class="number">1</span>)<span class="operator">*</span>rand())</span><br><span class="line">	floor向下取整</span><br><span class="line">	ceil向上取整</span><br><span class="line">	mod取余</span><br><span class="line">	<span class="keyword">truncate</span>截断</span><br><span class="line">		<span class="keyword">truncate</span>(num,len) num取小数点后len位</span><br><span class="line"><span class="number">3</span>、日期函数</span><br><span class="line">	now当前系统日期<span class="operator">+</span>时间</span><br><span class="line">	curdate当前系统日期</span><br><span class="line">	curtime当前系统时间</span><br><span class="line">	<span class="keyword">year</span> 从时间中解析出年</span><br><span class="line">	<span class="keyword">month</span></span><br><span class="line">	...</span><br><span class="line">	str_to_date 将字符转换成日期</span><br><span class="line">		str_to_date(str,format)</span><br><span class="line">	date_format将日期转换成字符</span><br><span class="line">	datediff(time1,time2)计算日期之差</span><br><span class="line"><span class="number">4</span>、流程控制函数</span><br><span class="line">	if 处理双分支</span><br><span class="line">		if(条件表达式，表达式<span class="number">1</span>，表达式<span class="number">2</span>)：如果条件表达式成立，返回表达式<span class="number">1</span>，否则返回表达式<span class="number">2</span></span><br><span class="line">	<span class="keyword">case</span>语句 处理多分支</span><br><span class="line">    	情况<span class="number">1</span>：处理等值判断</span><br><span class="line">            <span class="keyword">case</span> 变量或表达式</span><br><span class="line">            <span class="keyword">when</span> 常量<span class="number">1</span> <span class="keyword">then</span> 值<span class="number">1</span><span class="operator">|</span>语句<span class="number">1</span></span><br><span class="line">            <span class="keyword">when</span> 常量<span class="number">2</span> <span class="keyword">then</span> 值<span class="number">2</span><span class="operator">|</span>语句<span class="number">2</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">else</span> 值n<span class="operator">|</span>语句n</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            	举例</span><br><span class="line">                <span class="keyword">select</span> salary 原始工资,department_id, </span><br><span class="line">                <span class="keyword">case</span> department_id</span><br><span class="line">                <span class="keyword">when</span> <span class="number">30</span> <span class="keyword">then</span> salary<span class="operator">*</span><span class="number">1.1</span></span><br><span class="line">                <span class="keyword">when</span> <span class="number">40</span> <span class="keyword">then</span> salary<span class="operator">*</span><span class="number">1.2</span></span><br><span class="line">                <span class="keyword">else</span> salary</span><br><span class="line">                <span class="keyword">end</span> <span class="keyword">as</span> 新工资</span><br><span class="line">                <span class="keyword">from</span> employees;</span><br><span class="line">            </span><br><span class="line">		情况<span class="number">2</span>：处理多分支</span><br><span class="line">            <span class="keyword">case</span> </span><br><span class="line">            <span class="keyword">when</span> 条件<span class="number">1</span> <span class="keyword">then</span> 值<span class="number">1</span><span class="operator">|</span>语句<span class="number">1</span></span><br><span class="line">            <span class="keyword">when</span> 条件<span class="number">2</span> <span class="keyword">then</span> 值<span class="number">2</span><span class="operator">|</span>语句<span class="number">2</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">else</span> 值n<span class="operator">|</span>语句n</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            	<span class="keyword">select</span> salary,</span><br><span class="line">            	<span class="keyword">case</span></span><br><span class="line">            	<span class="keyword">when</span> salary<span class="operator">&gt;</span><span class="number">20000</span> <span class="keyword">then</span> <span class="string">&#x27;A&#x27;</span></span><br><span class="line">            	<span class="keyword">when</span> salary<span class="operator">&gt;</span><span class="number">15000</span> <span class="keyword">then</span> <span class="string">&#x27;B&#x27;</span></span><br><span class="line">            	<span class="keyword">else</span> <span class="string">&#x27;C&#x27;</span></span><br><span class="line">            	<span class="keyword">end</span> <span class="keyword">as</span> 级别</span><br><span class="line">            	<span class="keyword">from</span> employee;</span><br><span class="line">            </span><br><span class="line"><span class="number">5</span>、其他函数</span><br><span class="line">    version 当前数据库服务器的版本</span><br><span class="line">    database 当前打开的数据库</span><br><span class="line">    <span class="keyword">user</span>当前连接用户</span><br><span class="line">    password(<span class="string">&#x27;字符&#x27;</span>)：返回该字符的密码形式</span><br><span class="line">    md5(<span class="string">&#x27;字符&#x27;</span>):返回该字符的md5加密形式</span><br></pre></td></tr></table></figure>

<p><strong>日期格式化取值范围</strong></p>
<table>
<thead>
<tr>
<th></th>
<th>值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>秒</td>
<td>%S、%s</td>
<td>两位数字形式的秒（ 00,01, …, 59）</td>
</tr>
<tr>
<td>分</td>
<td>%I、%i</td>
<td>两位数字形式的分（ 00,01, …, 59）</td>
</tr>
<tr>
<td>小时</td>
<td>%H</td>
<td>24小时制，两位数形式小时（00,01, …,23）</td>
</tr>
<tr>
<td></td>
<td>%h</td>
<td>两位数形式小时（00,01, …,12）</td>
</tr>
<tr>
<td></td>
<td>%k</td>
<td>24小时制，数形式小时（0,1, …,23）</td>
</tr>
<tr>
<td></td>
<td>%l(L小写)</td>
<td>12小时制，数形式小时（0,1, …,12）</td>
</tr>
<tr>
<td></td>
<td>%T</td>
<td>24小时制，时间形式（HH:mm:ss）</td>
</tr>
<tr>
<td></td>
<td>%r</td>
<td>12小时制，时间形式（hh:mm:ss AM 或 PM）</td>
</tr>
<tr>
<td></td>
<td>%p</td>
<td>AM上午或PM下午</td>
</tr>
<tr>
<td>周</td>
<td>%W</td>
<td>一周中每一天的名称（Sunday,Monday, …,Saturday）</td>
</tr>
<tr>
<td></td>
<td>%a</td>
<td>一周中每一天名称的缩写（Sun,Mon, …,Sat</td>
</tr>
<tr>
<td></td>
<td>%w</td>
<td>以数字形式标识周（0=Sunday,1=Monday, …,6=Saturday）</td>
</tr>
<tr>
<td></td>
<td>%U</td>
<td>数字表示周数，星期天为周中第一天</td>
</tr>
<tr>
<td></td>
<td>%u</td>
<td>数字表示周数，星期一为周中第一天</td>
</tr>
<tr>
<td>天</td>
<td>%d</td>
<td>两位数字表示月中天数（01,02, …,31）</td>
</tr>
<tr>
<td></td>
<td>%e</td>
<td>数字表示月中天数（1,2, …,31）</td>
</tr>
<tr>
<td></td>
<td>%D</td>
<td>英文后缀表示月中天数（1st,2nd,3rd …）</td>
</tr>
<tr>
<td></td>
<td>%j</td>
<td>以三位数字表示年中天数（001,002, …,366）</td>
</tr>
<tr>
<td>月</td>
<td>%M</td>
<td>英文月名（January,February, …,December）</td>
</tr>
<tr>
<td></td>
<td>%b</td>
<td>英文缩写月名（Jan,Feb, …,Dec）</td>
</tr>
<tr>
<td></td>
<td>%m</td>
<td>两位数字表示月份（01,02, …,12）</td>
</tr>
<tr>
<td></td>
<td>%c</td>
<td>数字表示月份（1,2, …,12）</td>
</tr>
<tr>
<td>年</td>
<td>%Y</td>
<td>四位数字表示的年份（2015,2016…）</td>
</tr>
<tr>
<td></td>
<td>%y</td>
<td>两位数字表示的年份（15,16…）</td>
</tr>
<tr>
<td>文字输出</td>
<td>文字</td>
<td>直接输出文字内容</td>
</tr>
</tbody></table>
<h4 id="多行函数"><a href="#多行函数" class="headerlink" title="多行函数"></a>多行函数</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sum 求和</span><br><span class="line">	<span class="built_in">sum</span>(item)</span><br><span class="line">max 最大值</span><br><span class="line">min 最小值</span><br><span class="line">avg 平均值</span><br><span class="line">count 计数</span><br><span class="line">	<span class="built_in">count</span>(字段):统计表中该字段非空的行数</span><br><span class="line">	<span class="built_in">count</span>(<span class="operator">*</span>):统计表的行数</span><br><span class="line">	<span class="built_in">count</span>(常量):就相当于在表中加了一列常量，返回的就是表的行数，常用<span class="built_in">count</span>(<span class="number">1</span>)</span><br><span class="line">	MYISAM存储引擎下，<span class="built_in">count</span>(<span class="operator">*</span>)的效率高</span><br><span class="line">	INNODB存储引擎下，<span class="built_in">count</span>(<span class="operator">*</span>)和<span class="built_in">count</span>(<span class="number">1</span>)的效率差不多，都比<span class="built_in">count</span>(字段)效率高</span><br><span class="line"></span><br><span class="line">特点：</span><br><span class="line"><span class="number">1</span>、以上五个分组函数都忽略<span class="keyword">null</span>值，除了<span class="built_in">count</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="number">2</span>、sum和avg一般用于处理数值型</span><br><span class="line">    max、min、count可以处理任何数据类型</span><br><span class="line"><span class="number">3</span>、都可以搭配<span class="keyword">distinct</span>使用，用于统计去重后的结果</span><br><span class="line">    <span class="built_in">sum</span>(<span class="keyword">distinct</span> salary)</span><br></pre></td></tr></table></figure>

<p>案例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、查询公司员工工资的最大值、最小值、平均值、总和</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(salary) max_salary,<span class="built_in">min</span>(salary) min_salary,round(<span class="built_in">avg</span>(salary)) avg_salary,<span class="built_in">sum</span>(salary) sum_salary <span class="keyword">from</span> employees;</span><br><span class="line"><span class="number">2</span>、查询员工表中的最大入职时间和最小入职时间的相差天数</span><br><span class="line"><span class="keyword">select</span> datediff(<span class="built_in">max</span>(hiredate),<span class="built_in">min</span>(hiredate)) diffrence <span class="keyword">from</span> employees;</span><br></pre></td></tr></table></figure>



<h3 id="进阶5：分组查询"><a href="#进阶5：分组查询" class="headerlink" title="进阶5：分组查询"></a>进阶5：分组查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">	<span class="keyword">select</span> 分组后依然存在的字段，分组函数</span><br><span class="line">	<span class="keyword">from</span> 表</span><br><span class="line">	[<span class="keyword">where</span> 筛选条件]</span><br><span class="line">	<span class="keyword">group</span> <span class="keyword">by</span> 分组依据字段</span><br><span class="line">	[<span class="keyword">order</span> <span class="keyword">by</span> 分组后依然存在的字段]</span><br><span class="line">执行顺序：</span><br><span class="line">	<span class="keyword">from</span><span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">where</span><span class="operator">-</span><span class="operator">&gt;</span><span class="keyword">group</span> <span class="keyword">by</span><span class="operator">-</span><span class="operator">&gt;</span><span class="keyword">having</span><span class="operator">-</span><span class="operator">&gt;</span><span class="keyword">select</span><span class="operator">-</span><span class="operator">&gt;</span><span class="keyword">order</span> <span class="keyword">by</span>(针对分组后的数据进行排序)</span><br><span class="line"></span><br><span class="line">特点：</span><br><span class="line"><span class="number">1</span>、可以按单个字段分组</span><br><span class="line"><span class="number">2</span>、和分组函数一同查询的字段最好是分组依据字段</span><br><span class="line"><span class="number">3</span>、分组筛选</span><br><span class="line">			针对的表			位置				关键字</span><br><span class="line">分组前筛选：	原始表				<span class="keyword">group</span> <span class="keyword">by</span>的前面		<span class="keyword">where</span></span><br><span class="line">分组后筛选：	分组后的结果集		<span class="keyword">group</span> <span class="keyword">by</span>的后面		<span class="keyword">having</span></span><br><span class="line">分组函数做筛选条件，肯定是分组后筛选</span><br><span class="line">优先使用分组前筛选，避免两次数据处理</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、可以按多个字段分组，字段之间用逗号隔开</span><br><span class="line"><span class="number">5</span>、可以支持排序</span><br><span class="line"><span class="number">6</span>、<span class="keyword">having</span>后可以支持别名</span><br></pre></td></tr></table></figure>

<p>案例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、查询每个部门中邮箱包含<span class="string">&#x27;a&#x27;</span>的员工数</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>),department_id</span><br><span class="line"><span class="keyword">from</span> employees</span><br><span class="line"><span class="keyword">where</span> email <span class="keyword">like</span> <span class="string">&#x27;%a%&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> department_id</span><br><span class="line"><span class="number">2</span>、查询部门中员工数量大于<span class="number">2</span>的部门</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>),department_id</span><br><span class="line"><span class="keyword">from</span> employees</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> department_id</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">count</span>(<span class="operator">*</span>)<span class="operator">&gt;</span><span class="number">2</span></span><br><span class="line"><span class="number">3</span>、查询领导编号<span class="operator">&gt;</span><span class="number">102</span>的每个领导手下的最低工资<span class="operator">&gt;</span><span class="number">5000</span>的领导编号，以及其最低工资</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">min</span>(salary),manager_id</span><br><span class="line"><span class="keyword">from</span> empolyees</span><br><span class="line"><span class="keyword">where</span> manager_id<span class="operator">&gt;</span><span class="number">102</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> manager_id</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">min</span>(salary)<span class="operator">&gt;</span><span class="number">5000</span></span><br></pre></td></tr></table></figure>



<h3 id="进阶6：多表连接查询"><a href="#进阶6：多表连接查询" class="headerlink" title="进阶6：多表连接查询"></a>进阶6：多表连接查询</h3><p>连接类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">内连接</span><br><span class="line">    等值</span><br><span class="line">    非等值</span><br><span class="line">    自连接</span><br><span class="line">外连接</span><br><span class="line">    左外</span><br><span class="line">    右外</span><br><span class="line">    全外</span><br><span class="line">交叉连接</span><br></pre></td></tr></table></figure>

<p>一、传统模式下的连接 ：等值连接——非等值连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>等值连接的结果 <span class="operator">=</span> 多个表的交集</span><br><span class="line"><span class="number">2.</span>n表连接，至少需要n<span class="number">-1</span>个连接条件</span><br><span class="line"><span class="number">3.</span>多个表不分主次，没有顺序要求</span><br><span class="line"><span class="number">4.</span>一般为表起别名，提高阅读性和性能</span><br></pre></td></tr></table></figure>

<p>案例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 查询有奖金的每个部门的部门名和部门的领导编号和该部门的最低工资</span><br><span class="line"><span class="keyword">select</span> department_name,dept.manager_id,<span class="built_in">min</span>(salary)</span><br><span class="line"><span class="keyword">from</span> departments dept,employees emp</span><br><span class="line"><span class="keyword">where</span> dept.department_id<span class="operator">=</span>emp.department_id</span><br><span class="line"><span class="keyword">and</span> commission <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> department_name,dept.manager_id;</span><br><span class="line"></span><br><span class="line"># 查询每个工种的工种名和员工数量，并且按员工数量降序</span><br><span class="line"><span class="keyword">select</span> job_title,<span class="built_in">count</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">from</span> employees e,jobs j</span><br><span class="line"><span class="keyword">where</span> e.job_id<span class="operator">=</span>j.job_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line"># 已知 表student(id,name,gradeId),表grade(id,name),表<span class="keyword">result</span>(id,score,studentId)</span><br><span class="line"># 查询所有学生姓名、年级名、成绩</span><br><span class="line"><span class="keyword">select</span> s.name 姓名,g.name 年级名,r.score 成绩</span><br><span class="line"><span class="keyword">from</span> student s,grade g,<span class="keyword">result</span> r</span><br><span class="line"><span class="keyword">where</span> s.gradeId<span class="operator">=</span>g.id</span><br><span class="line"><span class="keyword">and</span> s.id<span class="operator">=</span>r.studentId</span><br></pre></td></tr></table></figure>

<p>二、sql92语法和sql99语法(使用join关键字实现连接)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">sql92：</span><br><span class="line">    等值</span><br><span class="line">    非等值</span><br><span class="line">    自连接</span><br><span class="line">也支持一部分外连接（用于oracle、sqlserver，mysql不支持）</span><br><span class="line"></span><br><span class="line">sql99【推荐使用】</span><br><span class="line">    内连接</span><br><span class="line">        等值</span><br><span class="line">        非等值</span><br><span class="line">        自连接</span><br><span class="line">    外连接</span><br><span class="line">        左外</span><br><span class="line">        右外</span><br><span class="line">        全外（mysql不支持）</span><br><span class="line">    交叉连接</span><br><span class="line"></span><br><span class="line">语法：</span><br><span class="line">    <span class="keyword">select</span> 字段，...</span><br><span class="line">    <span class="keyword">from</span> 表名 别名</span><br><span class="line">    【<span class="keyword">inner</span><span class="operator">|</span><span class="keyword">left</span> <span class="keyword">outer</span><span class="operator">|</span><span class="keyword">right</span> <span class="keyword">outer</span><span class="operator">|</span><span class="keyword">cross</span>】 <span class="keyword">join</span> 表<span class="number">2</span> <span class="keyword">on</span>  连接条件</span><br><span class="line">    【<span class="keyword">inner</span><span class="operator">|</span><span class="keyword">left</span> <span class="keyword">outer</span><span class="operator">|</span><span class="keyword">right</span> <span class="keyword">outer</span><span class="operator">|</span><span class="keyword">cross</span>】 <span class="keyword">join</span> 表<span class="number">3</span> <span class="keyword">on</span>  连接条件</span><br><span class="line">    【<span class="keyword">where</span> 筛选条件】</span><br><span class="line">    【<span class="keyword">group</span> <span class="keyword">by</span> 分组字段】</span><br><span class="line">    【<span class="keyword">having</span> 分组后的筛选条件】</span><br><span class="line">    【<span class="keyword">order</span> <span class="keyword">by</span> 排序的字段或表达式】</span><br><span class="line">    【limit 返回条件】</span><br><span class="line"></span><br><span class="line">好处：语句上，连接条件和筛选条件实现了分离，简洁明了！</span><br></pre></td></tr></table></figure>

<p>三、自连接</p>
<p>案例：查询员工名和直接上级的名称</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># sql92</span><br><span class="line"><span class="keyword">SELECT</span> e.last_name,m.last_name</span><br><span class="line"><span class="keyword">FROM</span> employees e,employees m </span><br><span class="line"><span class="keyword">WHERE</span> e.manager_id<span class="operator">=</span>m.employee_id;</span><br><span class="line"></span><br><span class="line"># sql99</span><br><span class="line"><span class="keyword">SELECT</span> e.last_name,m.last_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> employees m <span class="keyword">ON</span> e.manager_id<span class="operator">=</span>m.employee_id;</span><br></pre></td></tr></table></figure>

<p>四、外连接</p>
<img src="https://img.jbzj.com/file_images/article/201412/Visual_SQL_JOINS_small.jpg" alt="Visual_SQL_JOINS_small.jpg"  />

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 外连接<span class="operator">=</span>内连接<span class="operator">+</span>主表中有而从表中没有的记录，一般用于查询除了交集部分的剩余的不匹配的行（A<span class="operator">-</span>A∩B）</span><br><span class="line"># <span class="keyword">left</span> <span class="keyword">join</span> 左边的就是主表</span><br><span class="line"># <span class="keyword">right</span> <span class="keyword">join</span> 右边的就是主表</span><br><span class="line"># <span class="keyword">full</span> <span class="keyword">join</span> 两边都是主表(mysql不支持)</span><br></pre></td></tr></table></figure>

<p>案例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 查询没有员工的部门</span><br><span class="line"><span class="keyword">select</span> department.<span class="operator">*</span>,employee_id</span><br><span class="line"><span class="keyword">from</span> departments</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> employees</span><br><span class="line"><span class="keyword">on</span> department.department_id<span class="operator">=</span>employees.department_id</span><br><span class="line"><span class="keyword">where</span> employees.employee_id <span class="keyword">is</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>



<h3 id="进阶7：子查询"><a href="#进阶7：子查询" class="headerlink" title="进阶7：子查询"></a>进阶7：子查询</h3><p>含义：</p>
<pre><code>一条查询语句中又嵌套了另一条完整的select语句，其中被嵌套的select语句，称为子查询或内查询
在外面的查询语句，称为主查询或外查询
</code></pre>
<p>特点：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、子查询都放在小括号内</span><br><span class="line"><span class="number">2</span>、子查询可以放在<span class="keyword">from</span>后面、<span class="keyword">select</span>后面、<span class="keyword">where</span>后面、<span class="keyword">having</span>后面，但一般放在条件的右侧</span><br><span class="line"><span class="number">3</span>、子查询优先于主查询执行，主查询使用了子查询的执行结果</span><br><span class="line"><span class="number">4</span>、子查询分类</span><br><span class="line">根据查询结果的行数不同分为以下两类：</span><br><span class="line">    单行子查询</span><br><span class="line">        结果集只有一行</span><br><span class="line">        细分为：</span><br><span class="line">            标量子查询(结果集只有一行一列)</span><br><span class="line">            行子查询(结果集一行多列)</span><br><span class="line">        一般搭配单行操作符使用：<span class="operator">&gt;</span> <span class="operator">&lt;</span> <span class="operator">=</span> <span class="operator">&lt;&gt;</span> <span class="operator">&gt;=</span> <span class="operator">&lt;=</span> </span><br><span class="line">        非法使用子查询的情况：</span><br><span class="line">        a、子查询的结果为一组值</span><br><span class="line">        b、子查询的结果为空</span><br><span class="line"></span><br><span class="line">    多行子查询</span><br><span class="line">        结果集有多行</span><br><span class="line">        细分为：</span><br><span class="line">            列子查询(结果集一列多行)</span><br><span class="line">            表子查询(结果集多行多列)</span><br><span class="line">        一般搭配多行操作符使用：<span class="keyword">any</span>、<span class="keyword">all</span>、<span class="keyword">in</span>、<span class="keyword">not</span> <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">in</span><span class="operator">|</span><span class="keyword">not</span> <span class="keyword">in</span> : 等于列表中任意一个<span class="operator">|</span>不在列表中</span><br><span class="line">        	先执行子查询，再执行主查询</span><br><span class="line">        <span class="keyword">any</span><span class="operator">|</span><span class="keyword">some</span> : 条件满足列表中任意一项即可</span><br><span class="line">        	salary<span class="operator">&gt;</span><span class="keyword">any</span>(<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;15&#x27;</span>,<span class="string">&#x27;20&#x27;</span>)</span><br><span class="line">        <span class="keyword">all</span> : 条件必须对于列表中所有元素成立</span><br><span class="line">        <span class="keyword">any</span><span class="operator">|</span><span class="keyword">some</span>和<span class="keyword">all</span>都不常用，因为可以使用标量子查询来替换这些多行查询</span><br><span class="line">        	salary<span class="operator">&gt;</span><span class="keyword">any</span>(<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;15&#x27;</span>,<span class="string">&#x27;20&#x27;</span>)  <span class="operator">&lt;=</span><span class="operator">=</span><span class="operator">&gt;</span> salary<span class="operator">&gt;</span>(<span class="built_in">min</span>(salary))</span><br><span class="line">        	salary<span class="operator">&gt;</span><span class="keyword">all</span>(<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;15&#x27;</span>,<span class="string">&#x27;20&#x27;</span>)  <span class="operator">&lt;=</span><span class="operator">=</span><span class="operator">&gt;</span> salary<span class="operator">&gt;</span>(<span class="built_in">max</span>(salary))</span><br><span class="line">根据子查询出现的位置</span><br><span class="line">	<span class="keyword">select</span>后面：</span><br><span class="line">		标量子查询</span><br><span class="line">    <span class="keyword">from</span>后面：</span><br><span class="line">    	表子查询 将结果集作为新表,新表必须起别名★</span><br><span class="line">    <span class="keyword">where</span>或<span class="keyword">having</span>后面(重要)：</span><br><span class="line">    	标量子查询(单行子查询)</span><br><span class="line">    	列子查询(多行子查询)</span><br><span class="line">    	行子查询</span><br><span class="line">    <span class="keyword">exists</span>后面</span><br><span class="line">   		表子查询，先执行主查询，再执行子查询</span><br><span class="line">根据查询的数据耦合情况分为</span><br><span class="line">	嵌套子查询：查询语句的执行不依赖外部的查询,执行顺序：子查询<span class="operator">-</span><span class="operator">&gt;</span>主查询</span><br><span class="line">	相关子查询：查询语句的执行依赖外部的查询,执行顺序：主查询<span class="operator">-</span><span class="operator">&gt;</span>子查询<span class="operator">-</span><span class="operator">&gt;</span>主查询</span><br></pre></td></tr></table></figure>

<h4 id="in和exists的区别"><a href="#in和exists的区别" class="headerlink" title="in和exists的区别"></a>in和exists的区别</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wqc19920906/article/details/79800374?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-4.nonecase&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-4.nonecase">参考网址</a></p>
<ol>
<li>从表小，主表大且又有索引时应该用in</li>
<li>主表小，从表大且又有索引时使用exists</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> employees emp1</span><br><span class="line"><span class="keyword">where</span> emp1 <span class="keyword">in</span>(</span><br><span class="line">    <span class="keyword">select</span> emp1.id</span><br><span class="line">    <span class="keyword">from</span> employees emp2</span><br><span class="line">    <span class="keyword">where</span> emp1.id<span class="operator">&gt;</span>emp2.id</span><br><span class="line">)</span><br><span class="line">执行顺序:</span><br><span class="line">	<span class="number">1</span>、执行子查询</span><br><span class="line">		将结果与主表进行笛卡尔积</span><br><span class="line">	<span class="number">2</span>、执行主查询</span><br><span class="line"><span class="comment">------------------------</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> employees emp1</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> emp1.id</span><br><span class="line">    <span class="keyword">from</span> employees emp2</span><br><span class="line">    <span class="keyword">where</span> emp1.id<span class="operator">&gt;</span>emp2.id</span><br><span class="line">)</span><br><span class="line">执行顺序:</span><br><span class="line">	<span class="number">1</span>、执行主查询</span><br><span class="line">		<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees</span><br><span class="line">		将结果与子表进行笛卡尔积</span><br><span class="line">	<span class="number">2</span>、执行子查询</span><br><span class="line">		<span class="keyword">exists</span>(</span><br><span class="line">            <span class="keyword">select</span> emp1.id</span><br><span class="line">            <span class="keyword">from</span> employees emp2</span><br><span class="line">            <span class="keyword">where</span> emp1.id<span class="operator">&gt;</span>emp2.id</span><br><span class="line">        )</span><br><span class="line"><span class="comment">--------------------------</span></span><br><span class="line"><span class="keyword">not</span> <span class="keyword">in</span> 和<span class="keyword">not</span> <span class="keyword">exists</span></span><br><span class="line">	如果查询语句使用了<span class="keyword">not</span> <span class="keyword">in</span> 那么内外表都进行全表扫描，且没有用到索引；而<span class="keyword">not</span> extsts 的子查询依然能用到表上的索引。</span><br><span class="line">	所以无论那个表大，用<span class="keyword">not</span> <span class="keyword">exists</span>都比<span class="keyword">not</span> <span class="keyword">in</span>要快。</span><br></pre></td></tr></table></figure>

<p>案例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"># <span class="comment">--------------------标量子查询--------------------</span></span><br><span class="line"># 查询<span class="number">141</span>号员工的job_id </span><br><span class="line"># 查询<span class="number">143</span>号员工的salary</span><br><span class="line"># 查询员工的姓名，job_id和工资，要求job_id<span class="operator">=</span><span class="number">141</span>号员工的job_id，salary<span class="operator">&gt;</span><span class="number">143</span>号员工的salary</span><br><span class="line"><span class="keyword">select</span> last_name,job_id,salary</span><br><span class="line"><span class="keyword">from</span> employees</span><br><span class="line"><span class="keyword">where</span> job_id<span class="operator">=</span>(</span><br><span class="line">	<span class="keyword">select</span> job_id</span><br><span class="line">    <span class="keyword">from</span> employees</span><br><span class="line">    <span class="keyword">where</span> employee_id<span class="operator">=</span><span class="number">141</span></span><br><span class="line">) <span class="keyword">and</span> salary<span class="operator">&gt;</span>(</span><br><span class="line">	<span class="keyword">select</span> salary</span><br><span class="line">    <span class="keyword">from</span> employees</span><br><span class="line">    <span class="keyword">where</span> employee_id<span class="operator">=</span><span class="number">143</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># 返回公司工资最少的员工last_name,job_id,salary</span><br><span class="line"><span class="keyword">select</span> last_name,job_id,salary</span><br><span class="line"><span class="keyword">from</span> employees</span><br><span class="line"><span class="keyword">where</span> salary<span class="operator">=</span>(</span><br><span class="line">	<span class="keyword">select</span> <span class="built_in">min</span>(salary)</span><br><span class="line">    <span class="keyword">from</span> employees</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># 查询最低工资大于<span class="number">50</span>号部门最低工资的部门id,最低工资</span><br><span class="line"><span class="keyword">select</span> department_id,<span class="built_in">min</span>(salary)</span><br><span class="line"><span class="keyword">from</span> departments</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> department_id</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">min</span>(salary)<span class="operator">&gt;</span>(</span><br><span class="line">	<span class="keyword">select</span> <span class="built_in">min</span>(salary)</span><br><span class="line">    <span class="keyword">from</span> departments</span><br><span class="line">    <span class="keyword">where</span> department_id<span class="operator">=</span><span class="number">50</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># <span class="comment">--------------------------列子查询--------------</span></span><br><span class="line"># 查询location_id是<span class="number">1400</span>或<span class="number">1700</span>的部门编号</span><br><span class="line"><span class="keyword">select</span> last_name</span><br><span class="line"><span class="keyword">from</span> departments</span><br><span class="line"><span class="keyword">where</span> location_id <span class="keyword">in</span> (</span><br><span class="line">	<span class="keyword">select</span> <span class="keyword">distinct</span> department_id</span><br><span class="line">    <span class="keyword">from</span> departments</span><br><span class="line">    <span class="keyword">where</span> location_id <span class="keyword">in</span>(<span class="number">1400</span>,<span class="number">1700</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># 返回其他部门中比job_id为<span class="string">&#x27;IT_PROG&#x27;</span>部门任意工资低的员工的员工号、姓名、job_id、salary</span><br><span class="line"><span class="keyword">select</span> last_name,employees,job_id,salary</span><br><span class="line"><span class="keyword">from</span> employees</span><br><span class="line"><span class="keyword">where</span> salary<span class="operator">&lt;</span>(</span><br><span class="line">	<span class="keyword">select</span> <span class="built_in">max</span>(salary)</span><br><span class="line">    <span class="keyword">from</span> employees</span><br><span class="line">    <span class="keyword">where</span> job_id<span class="operator">=</span><span class="string">&#x27;IT_PROG&#x27;</span></span><br><span class="line">) <span class="keyword">and</span> job_id<span class="operator">&lt;&gt;</span><span class="string">&#x27;IT_PROG&#x27;</span>;</span><br><span class="line"></span><br><span class="line"># <span class="comment">--------------------------表子查询----------------</span></span><br><span class="line"># <span class="keyword">from</span>后面</span><br><span class="line"># 查询学生id为<span class="number">001</span>的选课名单及各科成绩</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line"><span class="keyword">from</span>(</span><br><span class="line">	<span class="keyword">select</span> student.id,sc</span><br><span class="line">)</span><br><span class="line"># exsits</span><br><span class="line"># 查询有员工的部门名</span><br><span class="line"><span class="keyword">select</span> department_name</span><br><span class="line"><span class="keyword">from</span> departments dept</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span>(</span><br><span class="line">	<span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line">    <span class="keyword">from</span> employees emp</span><br><span class="line">    <span class="keyword">where</span> dept.department_id<span class="operator">=</span>emp.department_id</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查询工资最低的员工信息last_name、salary</span><br><span class="line"><span class="keyword">select</span> last_name,salary</span><br><span class="line"><span class="keyword">from</span> employees</span><br><span class="line"><span class="keyword">where</span> salary<span class="operator">=</span>(</span><br><span class="line">	<span class="keyword">select</span> <span class="built_in">min</span>(salary)</span><br><span class="line">    <span class="keyword">from</span> employees</span><br><span class="line">)</span><br><span class="line">等价于<span class="comment">------</span></span><br><span class="line"><span class="keyword">select</span> last_name,salary</span><br><span class="line"><span class="keyword">from</span> employees</span><br><span class="line"><span class="keyword">where</span> salary<span class="operator">=</span><span class="built_in">min</span>(salary)</span><br><span class="line"></span><br><span class="line"># 查询平均工资最低的部门信息</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> departments</span><br><span class="line"><span class="keyword">having</span> department_id <span class="operator">=</span> (</span><br><span class="line">    # 最小平均工资的部门</span><br><span class="line">	<span class="keyword">select</span> department_id</span><br><span class="line">    <span class="keyword">from</span> departments</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> department_id</span><br><span class="line">    <span class="keyword">having</span> <span class="built_in">avg</span>(salary) <span class="operator">=</span> (</span><br><span class="line">        # 最小平均工资</span><br><span class="line">        <span class="keyword">select</span> <span class="built_in">min</span>(avg_salary) min_avg_salary</span><br><span class="line">        <span class="keyword">from</span> (</span><br><span class="line">            # 平均工资</span><br><span class="line">            <span class="keyword">select</span> <span class="built_in">avg</span>(salary) avg_salary,department_id</span><br><span class="line">            <span class="keyword">from</span> employees</span><br><span class="line">            <span class="keyword">group</span> <span class="keyword">by</span> department_id</span><br><span class="line">        ) avg_department</span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line">等价于<span class="comment">------</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> departments</span><br><span class="line"><span class="keyword">where</span> department_id <span class="operator">=</span> (</span><br><span class="line">	<span class="keyword">select</span> department_id</span><br><span class="line">    <span class="keyword">from</span> employees</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> department_id</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> <span class="built_in">avg</span>(salary) <span class="keyword">asc</span></span><br><span class="line">    limit <span class="number">1</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 查询平均工资最低的部门信息和该部门的平均工资</span><br><span class="line"><span class="keyword">select</span> departments.<span class="operator">*</span>,avg_dept</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> department_id,<span class="built_in">avg</span>(salary)</span><br><span class="line">    <span class="keyword">from</span> employees</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> department_id</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> <span class="built_in">avg</span>(salary) <span class="keyword">asc</span></span><br><span class="line">    limit <span class="number">1</span></span><br><span class="line">) <span class="keyword">as</span> avg_dept</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> departments </span><br><span class="line"><span class="keyword">on</span> avg_dept.department_id <span class="operator">=</span> departments.department_id</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="进阶8：分页查询"><a href="#进阶8：分页查询" class="headerlink" title="进阶8：分页查询"></a>进阶8：分页查询</h3><p>应用场景：</p>
<pre><code>实际的web项目中需要根据用户的需求提交对应的分页查询的sql语句
</code></pre>
<p>语法：</p>
<pre><code>select 字段|表达式,...
from 表
【where 条件】
【group by 分组字段】
【having 条件】
【order by 排序的字段】
limit 【起始的条目索引，】条目数;
条目数=-1表示遍历到结束
</code></pre>
<p>特点：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>起始条目索引从<span class="number">0</span>开始</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>limit子句放在查询语句的最后</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>公式：<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>  表 limit （page<span class="number">-1</span>）<span class="operator">*</span>sizePerPage,sizePerPage</span><br><span class="line">假如:</span><br><span class="line">每页显示条目数sizePerPage</span><br><span class="line">要显示的页数 page</span><br></pre></td></tr></table></figure>

<p>==mysql 中，limit 后面不能带运算符，只能是常量==</p>
<p>案例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"># 一、查询每个专业的学生人数</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">FROM</span> major</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> majorid</span><br><span class="line"># 二、查询参加考试的学生中，每个学生的平均分、最高分</span><br><span class="line"><span class="keyword">SELECT</span> studentno,<span class="built_in">AVG</span>(score),<span class="built_in">MAX</span>(score)</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">result</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> studentno</span><br><span class="line"># 三、查询姓张的学生中，最低分大于<span class="number">60</span>的学生的学号、姓名</span><br><span class="line"><span class="keyword">SELECT</span> newStudent.studentno 学号,newStudent.studentname 姓名,<span class="built_in">MIN</span>(score) 平均成绩</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> studentno,studentname</span><br><span class="line">	<span class="keyword">FROM</span> student</span><br><span class="line">	<span class="keyword">WHERE</span> studentname <span class="keyword">LIKE</span> <span class="string">&#x27;张%&#x27;</span></span><br><span class="line">) newStudent</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> <span class="keyword">result</span> <span class="keyword">on</span> newStudent.studentno<span class="operator">=</span>result.studentno</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> newStudent.studentno</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">MIN</span>(score)<span class="operator">&gt;</span><span class="number">60</span></span><br><span class="line"># 四、查询生日在“<span class="number">1988</span><span class="number">-1</span><span class="number">-1</span>”后的学生姓名、专业名称</span><br><span class="line"><span class="keyword">SELECT</span> ns.studentname,borndate,ns.majorid,mj.majorname</span><br><span class="line"><span class="keyword">FROM</span>(</span><br><span class="line">	<span class="keyword">SELECT</span> studentname,majorid,borndate</span><br><span class="line">	<span class="keyword">FROM</span> student</span><br><span class="line">	<span class="keyword">WHERE</span> borndate<span class="operator">&gt;</span><span class="string">&#x27;1988-1-1&#x27;</span></span><br><span class="line">) ns</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> major mj <span class="keyword">on</span> ns.majorid<span class="operator">=</span>mj.majorid</span><br><span class="line"></span><br><span class="line"># 五、查询每个专业的男生人数和女生人数分别是多少</span><br><span class="line"><span class="comment">-- SELECT majorid,sex,COUNT(*) 人数</span></span><br><span class="line"><span class="comment">-- FROM student</span></span><br><span class="line"><span class="comment">-- GROUP BY majorid,sex</span></span><br><span class="line"><span class="keyword">SELECT</span> majorid,</span><br><span class="line">(<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> majorid<span class="operator">=</span>stu.majorid <span class="keyword">and</span> sex<span class="operator">=</span><span class="string">&#x27;男&#x27;</span>) 男,</span><br><span class="line">(<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> majorid<span class="operator">=</span>stu.majorid <span class="keyword">and</span> sex<span class="operator">=</span><span class="string">&#x27;女&#x27;</span>) 女</span><br><span class="line"><span class="keyword">FROM</span> student <span class="keyword">as</span> stu</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> majorid</span><br><span class="line"># 六、查询专业和张翠山一样的学生的最低分</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MIN</span>(score)</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">result</span></span><br><span class="line"><span class="keyword">WHERE</span> studentno <span class="keyword">in</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> studentno</span><br><span class="line">	<span class="keyword">FROM</span> student</span><br><span class="line">	<span class="keyword">WHERE</span> majorid <span class="operator">=</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> majorid</span><br><span class="line">		<span class="keyword">from</span> student</span><br><span class="line">		<span class="keyword">WHERE</span> studentname<span class="operator">=</span><span class="string">&#x27;张翠山&#x27;</span></span><br><span class="line">	)</span><br><span class="line">)</span><br><span class="line"># 七、查询大于<span class="number">60</span>分的学生的姓名、密码、专业名</span><br><span class="line"><span class="keyword">SELECT</span> studentname 姓名,loginpwd 密码,</span><br><span class="line">(<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> majorname <span class="keyword">FROM</span> major <span class="keyword">WHERE</span> major.majorid<span class="operator">=</span>stu.majorid) 专业名</span><br><span class="line"><span class="keyword">from</span> student stu</span><br><span class="line"><span class="keyword">WHERE</span> studentno <span class="keyword">in</span>(</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> studentno</span><br><span class="line">	<span class="keyword">FROM</span> <span class="keyword">result</span></span><br><span class="line">	<span class="keyword">WHERE</span> score<span class="operator">&gt;</span><span class="number">60</span></span><br><span class="line">)</span><br><span class="line"># 八、按邮箱位数分组，查询每组的学生个数</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) 人数,LENGTH(email) 邮箱位数</span><br><span class="line"><span class="keyword">FROM</span> student</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> LENGTH(email)</span><br><span class="line"># 九、查询学生名、专业名、分数</span><br><span class="line"><span class="keyword">SELECT</span> studentname,majorname,score</span><br><span class="line"><span class="keyword">FROM</span> student</span><br><span class="line"><span class="keyword">JOIN</span> major <span class="keyword">on</span> student.majorid<span class="operator">=</span>major.majorid</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> <span class="keyword">result</span> <span class="keyword">on</span> student.studentno<span class="operator">=</span>result.studentno</span><br><span class="line"># 十、查询哪个专业没有学生，分别用左连接和右连接实现</span><br><span class="line"><span class="keyword">SELECT</span> majorname,studentno</span><br><span class="line"><span class="keyword">FROM</span> major</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> student <span class="keyword">on</span> major.majorid<span class="operator">=</span>student.majorid</span><br><span class="line"><span class="keyword">WHERE</span> studentno <span class="keyword">is</span> <span class="keyword">NULL</span></span><br><span class="line"># 十一、查询没有成绩的学生人数</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">FROM</span> student</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> <span class="keyword">result</span> <span class="keyword">on</span> student.studentno<span class="operator">=</span>result.studentno</span><br><span class="line"><span class="keyword">WHERE</span> score <span class="keyword">is</span> <span class="keyword">NULL</span></span><br></pre></td></tr></table></figure>



<h3 id="进阶9：联合查询"><a href="#进阶9：联合查询" class="headerlink" title="进阶9：联合查询"></a>进阶9：联合查询</h3><p>引入：<br>    union 联合、合并</p>
<p>语法：</p>
<pre><code>select 字段|常量|表达式|函数 【from 表】 【where 条件】 union 【all】
select 字段|常量|表达式|函数 【from 表】 【where 条件】 union 【all】
select 字段|常量|表达式|函数 【from 表】 【where 条件】 union  【all】
.....
select 字段|常量|表达式|函数 【from 表】 【where 条件】
</code></pre>
<p>特点：</p>
<pre><code>1、多条查询语句的查询的列数必须是一致的
2、多条查询语句的查询的列的类型几乎相同
3、union代表去重，union all代表不去重
4、最终结果表的字段名是第一条查询的字段名
</code></pre>
<p>案例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 查询部门编号<span class="operator">&gt;</span><span class="number">90</span>或邮箱包含a的员工信息</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> email <span class="keyword">like</span> <span class="string">&#x27;%a%&#x27;</span> <span class="keyword">or</span> departmentId<span class="operator">&gt;</span><span class="number">90</span></span><br><span class="line"><span class="operator">&lt;=</span><span class="operator">=</span><span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> email <span class="keyword">like</span> <span class="string">&#x27;%a%&#x27;</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> departmentId<span class="operator">&gt;</span><span class="number">90</span></span><br><span class="line"></span><br><span class="line"># 查询中国用户中男性信息和外国用户中男性信息</span><br><span class="line"><span class="keyword">select</span> id,cname <span class="keyword">from</span> t_ca <span class="keyword">where</span> csex<span class="operator">=</span><span class="string">&#x27;男&#x27;</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> t_id,tname <span class="keyword">from</span> t_ua <span class="keyword">where</span> usex<span class="operator">=</span><span class="string">&#x27;male&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="单引号和双引号的区别"><a href="#单引号和双引号的区别" class="headerlink" title="单引号和双引号的区别"></a>单引号和双引号的区别</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yulinlewis/p/9404508.html">参考网址</a></p>
<h2 id="DML语言"><a href="#DML语言" class="headerlink" title="DML语言"></a>DML语言</h2><p>Database Manipulation Language</p>
<h3 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">方式一：</span><br><span class="line">	insert into 表名(字段名,...) values(值1,...),(值1,...),...;</span><br><span class="line">	支持子查询</span><br><span class="line">		insert into 表名(字段名,...)</span><br><span class="line">		select 字段名,...</span><br><span class="line">		from 任意表名</span><br><span class="line">		where ...</span><br><span class="line">	支持多条数据插入</span><br><span class="line">		insert into 表名(字段名,...) values(值1,...),(值1,...),...;</span><br><span class="line">方式二：</span><br><span class="line">	insert into 表明 set 列名&#x3D;值,列名&#x3D;值</span><br></pre></td></tr></table></figure>

<p>特点：</p>
<pre><code>1、字段类型和值类型一致或兼容，而且一一对应
2、可以为空的字段，可以不用插入值，或用null填充
3、不可以为空的字段，必须插入值
4、字段个数和值的个数必须一致
5、字段可以省略，但默认所有字段，并且顺序和表中的存储顺序一致
</code></pre>
<h3 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h3><p>修改单表语法：</p>
<pre><code>update 表名 set 列名=新值,列名=新值
【where 条件】
# 修改满足条件的数据的字段
</code></pre>
<p>修改多表语法：</p>
<pre><code>update 表1 别名1 
join|left join|right join|cross 表2 别名2
on 连接条件
set 字段=新值，字段=新值
where 筛选条件;

# 修改张无忌的女朋友的手机号为114
update boys bo
inner join  beauty be on bo.id=be.boyfriend_id
set be.phone=&#39;114&#39;
where bo.boyName=&#39;张无忌&#39;
</code></pre>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>方式1：delete语句：清空表或数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">单表的删除： ★</span><br><span class="line">	delete from 表名 【where 筛选条件】</span><br><span class="line"></span><br><span class="line">多表的删除：</span><br><span class="line">	delete 别名1(删除表1中的数据)，别名2(删除表2中的数据)</span><br><span class="line">	from 表1 别名1 </span><br><span class="line">	join|left join|right join|cross 表2 别名2</span><br><span class="line">	on 连接条件</span><br><span class="line">	where 筛选条件;</span><br></pre></td></tr></table></figure>


<p>方式2：truncate语句：清空表</p>
<pre><code>truncate table 表名
</code></pre>
<p>两种方式的区别【面试题】<br>    #1.truncate不能加where条件，而delete可以加where条件</p>
<pre><code>#2.truncate的效率高一丢丢

#3.truncate 删除带自增长的列的表后，如果再插入数据，数据从1开始
# delete 删除带自增长列的表后，如果再插入数据，数据从上一次的断点处开始

#4.truncate删除没有返回值
# delete删除会返回数据的行数

#4.truncate删除不能回滚，delete删除可以回滚
</code></pre>
<p><strong>注意</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">delete from Person </span><br><span class="line">where id not in (</span><br><span class="line">    select min(Id) id from Person group by Email having count(Email) &gt; 1</span><br><span class="line">) or Email not in (</span><br><span class="line">    select Email from Person group by Email having count(Email) &#x3D; 1</span><br><span class="line">)</span><br></pre></td></tr></table></figure>


<p>执行这条语句时会报错：You can’t specify target table ‘Person’ for update in FROM clause</p>
<p>这是因为==MySQL不允许同时查询和删除一张表==(MSSQL和Oracle不会出现此问题)，我们可以通过子查询的方式包装一下即可避免这个报错</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> Person </span><br><span class="line"><span class="keyword">where</span> id <span class="keyword">not</span> <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> id <span class="keyword">from</span> (</span><br><span class="line">    	<span class="keyword">select</span> <span class="built_in">min</span>(Id) id <span class="keyword">from</span> Person <span class="keyword">group</span> <span class="keyword">by</span> Email <span class="keyword">having</span> <span class="built_in">count</span>(Email) <span class="operator">&gt;</span> <span class="number">1</span></span><br><span class="line">    ) a</span><br><span class="line">) <span class="keyword">and</span> Email <span class="keyword">not</span> <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> Email <span class="keyword">from</span> (</span><br><span class="line">    	<span class="keyword">select</span> Email <span class="keyword">from</span> Person <span class="keyword">group</span> <span class="keyword">by</span> Email <span class="keyword">having</span> <span class="built_in">count</span>(Email) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    ) b</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h2 id="DDL语言"><a href="#DDL语言" class="headerlink" title="DDL语言"></a>DDL语言</h2><p>Database Definition Language</p>
<h3 id="定义数据库和表"><a href="#定义数据库和表" class="headerlink" title="定义数据库和表"></a>定义数据库和表</h3><p>库的定义</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">一、创建库</span><br><span class="line"><span class="keyword">create</span> database 库名</span><br><span class="line">二、删除库</span><br><span class="line"><span class="keyword">drop</span> database [if <span class="keyword">exists</span>] 库名</span><br><span class="line">三、修改库的字符集</span><br><span class="line"><span class="keyword">alter</span> database 库名 <span class="type">character</span> <span class="keyword">set</span> 字符集类型;</span><br></pre></td></tr></table></figure>
<p>表的定义    </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">1.</span>创建表</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> stuinfo(</span><br><span class="line">	stuId <span class="type">INT</span>,</span><br><span class="line">	stuName <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">	gender <span class="type">CHAR</span>,</span><br><span class="line">	bornDate DATTIME</span><br><span class="line">	);</span><br><span class="line"># 显示表结构</span><br><span class="line"><span class="keyword">desc</span> stuinfo;</span><br><span class="line">#<span class="number">2.</span>修改表 <span class="keyword">alter</span></span><br><span class="line">	<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 <span class="keyword">ADD</span><span class="operator">|</span><span class="keyword">DROP</span><span class="operator">|</span>RENAME<span class="operator">|</span>CHANGE<span class="operator">|</span>MODIFY <span class="keyword">COLUMN</span> 字段名 【字段类型，字段约束】;</span><br><span class="line">        #添加字段</span><br><span class="line">        <span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> 字段名 字段类型 【字段约束】;</span><br><span class="line">        	<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> studentinfo <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> email <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">first</span>;</span><br><span class="line">        #删除字段</span><br><span class="line">        <span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 <span class="keyword">DROP</span> <span class="keyword">COLUMN</span> 字段名;</span><br><span class="line">        	<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> studentinfo <span class="keyword">DROP</span> <span class="keyword">COLUMN</span> email;</span><br><span class="line">        #修改表名</span><br><span class="line">        <span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 RENAME [<span class="keyword">TO</span>]  新表名;</span><br><span class="line">        	<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> stuinfo RENAME [<span class="keyword">TO</span>]  studentinfo;</span><br><span class="line">        #修改字段名</span><br><span class="line">        <span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 CHANGE <span class="keyword">COLUMN</span> 旧字段名 新字段名 字段类型;</span><br><span class="line">        	<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> studentinfo CHANGE <span class="keyword">COLUMN</span> sex gender <span class="type">CHAR</span>;</span><br><span class="line">        #修改字段类型和列级约束</span><br><span class="line">        <span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 MODIFY <span class="keyword">COLUMN</span> 字段名 新字段类型 【字段约束】;</span><br><span class="line">        	<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> studentinfo MODIFY <span class="keyword">COLUMN</span> borndate <span class="type">DATE</span>;</span><br><span class="line">#<span class="number">3.</span>删除表</span><br><span class="line">	<span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> studentinfo;</span><br><span class="line">#<span class="number">4.</span>复制表结构</span><br><span class="line">	<span class="keyword">create</span> <span class="keyword">table</span> 新表名 <span class="keyword">like</span> 旧表名</span><br><span class="line">#<span class="number">5.</span>复制表结构和数据</span><br><span class="line">	复制全部数据</span><br><span class="line">        <span class="keyword">create</span> <span class="keyword">table</span> 库名.新表名</span><br><span class="line">        <span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line">        <span class="keyword">from</span> 库名.旧表名</span><br><span class="line">    复制部分数据</span><br><span class="line">    	<span class="keyword">create</span> <span class="keyword">table</span> 库名.新表名</span><br><span class="line">    	<span class="keyword">select</span> 字段<span class="number">1</span>,字段<span class="number">2</span>,...</span><br><span class="line">    	<span class="keyword">from</span> 库名.旧表名</span><br><span class="line">    	<span class="keyword">where</span> ...</span><br><span class="line">    复制部分表结构，且不要数据</span><br><span class="line">    	<span class="keyword">create</span> <span class="keyword">table</span> 库名.新表名</span><br><span class="line">    	<span class="keyword">select</span> 字段<span class="number">1</span>,字段<span class="number">2</span>,...</span><br><span class="line">    	<span class="keyword">from</span> 库名.旧表名</span><br><span class="line">    	<span class="keyword">where</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>


<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">整型：</span><br><span class="line">	tinyint、<span class="type">smallint</span>、mediumint、<span class="type">int</span><span class="operator">/</span><span class="type">integer</span>、<span class="type">bigint</span></span><br><span class="line">    <span class="number">1</span>B         <span class="number">2</span>        <span class="number">3</span>          <span class="number">4</span>            <span class="number">8</span></span><br><span class="line"></span><br><span class="line">    特点：</span><br><span class="line">    ①都可以设置无符号和有符号，默认有符号，通过unsigned设置无符号</span><br><span class="line">    ②如果超出了范围，会报<span class="keyword">out</span> <span class="keyword">or</span> <span class="keyword">range</span>异常，插入临界值</span><br><span class="line">    ③长度可以不指定，默认会有一个长度</span><br><span class="line">     长度代表显示的最小宽度，如果不够则左边用<span class="number">0</span>填充，但需要搭配zerofill，使用zerofill类型默认为无符号整型</span><br><span class="line">    	id <span class="type">int</span>(<span class="number">7</span>) zerofill <span class="operator">&lt;=</span><span class="operator">=</span><span class="operator">&gt;</span> id <span class="type">int</span>(<span class="number">7</span>) zerofill unsigned</span><br><span class="line">小数：</span><br><span class="line">    定点数：<span class="type">decimal</span>(M,D)</span><br><span class="line">    浮点数:</span><br><span class="line">        <span class="type">float</span>(M,D)   <span class="number">4</span></span><br><span class="line">        <span class="keyword">double</span>(M,D)  <span class="number">8</span></span><br><span class="line">    特点：</span><br><span class="line">    ①M代表整数部位<span class="operator">+</span>小数部位的个数，D代表小数部位</span><br><span class="line">    ②如果超出范围，则报<span class="keyword">out</span> <span class="keyword">or</span> <span class="keyword">range</span>异常，并且插入临界值</span><br><span class="line">    ③M和D都可以省略，但对于定点数，M默认为<span class="number">10</span>，D默认为<span class="number">0</span></span><br><span class="line">    ④如果精度要求较高，则优先考虑使用定点数</span><br><span class="line">字符型：</span><br><span class="line">    较短的文本:<span class="type">char</span>、<span class="type">varchar</span>、<span class="type">binary</span>(较短的二进制)、<span class="type">varbinary</span>、enum、<span class="keyword">set</span></span><br><span class="line">    	<span class="type">char</span>：固定长度的字符，写法为<span class="type">char</span>(M)，最大长度不能超过M，其中M可以省略，默认为<span class="number">1</span>。</span><br><span class="line">    		最终存储的长度<span class="operator">=</span>M。效率相对高。对于一些长度固定的数据，使用<span class="type">char</span></span><br><span class="line">    	<span class="type">varchar</span>：可变长度的字符，写法为<span class="type">varchar</span>(M)，最大长度不能超过M，其中M不可以省略。</span><br><span class="line">    		最终存储的长度<span class="operator">=</span>字符数。效率相对低。对于一些长度不固定的数据，使用<span class="type">varchar</span></span><br><span class="line">        Enum:</span><br><span class="line">            <span class="keyword">create</span> <span class="keyword">table</span> person(</span><br><span class="line">                sex ENUM(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>)</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">insert</span> <span class="keyword">into</span> person(sex) <span class="keyword">values</span>(<span class="string">&#x27;男&#x27;</span>)</span><br><span class="line">        <span class="keyword">Set</span>:</span><br><span class="line">        	<span class="keyword">create</span> <span class="keyword">table</span> book(</span><br><span class="line">        		type <span class="keyword">SET</span>(<span class="string">&#x27;动作&#x27;</span>,<span class="string">&#x27;喜剧&#x27;</span>,<span class="string">&#x27;悬疑&#x27;</span>,<span class="string">&#x27;爱情&#x27;</span>)</span><br><span class="line">        	)</span><br><span class="line">        	<span class="keyword">insert</span> <span class="keyword">into</span> book(type) <span class="keyword">values</span>(<span class="string">&#x27;动作,喜剧&#x27;</span>)</span><br><span class="line">    较长的文本:text()、<span class="type">blob</span>(较大的二进制,图片) 	</span><br><span class="line">日期型：</span><br><span class="line">	<span class="keyword">year</span>年</span><br><span class="line">    <span class="type">date</span>日期</span><br><span class="line">    <span class="type">time</span>时间</span><br><span class="line">    datetime 日期<span class="operator">+</span>时间          <span class="number">8</span>      </span><br><span class="line">    <span class="type">timestamp</span> 日期<span class="operator">+</span>时间         <span class="number">4</span>   比较容易受时区、语法模式、版本的影响，更能反映当前时区的真实时间,范围较小(<span class="number">1970</span><span class="number">-2038</span>)</span><br><span class="line">    	<span class="keyword">create</span> <span class="keyword">table</span> tab_date(</span><br><span class="line">        	t1 datetime,</span><br><span class="line">            t2 <span class="type">timestamp</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">insert</span> <span class="keyword">into</span> tab_date <span class="keyword">values</span>(now(),now());</span><br><span class="line">        <span class="keyword">set</span> time_zone<span class="operator">=</span><span class="string">&#x27;+9:00&#x27;</span> #设置为东<span class="number">9</span>区,<span class="type">timestamp</span>类型的数据就会受到影响，自动加一个小时</span><br><span class="line"><span class="type">Blob</span>类型：</span><br></pre></td></tr></table></figure>



<h3 id="常见约束"><a href="#常见约束" class="headerlink" title="常见约束"></a>常见约束</h3><p><strong>六种约束类型</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NOT NULL：非空，该字段的值必填</span><br><span class="line">UNIQUE：唯一，该字段的值不可重复，可以为空，自动添加索引</span><br><span class="line">DEFAULT：默认，该字段的值不用手动插入有默认值</span><br><span class="line">CHECK：检查，mysql不支持</span><br><span class="line">PRIMARY KEY：主键，该字段的值不可重复并且非空  unique+not null</span><br><span class="line">FOREIGN KEY：外键，该字段的值引用了另外的表的字段</span><br></pre></td></tr></table></figure>

<p>可以分为：</p>
<ul>
<li>列级约束：除了外键的所有约束</li>
<li>表级约束：除了非空和默认的所有约束，可以给约束命名(主键除外，主键命名固定为PRIMARY)</li>
</ul>
<p>==唯一，主键，外键都是键，创建后会自动添加索引==</p>
<p><strong>注意</strong></p>
<p>主键与唯一键的异同</p>
<table>
<thead>
<tr>
<th></th>
<th>是否唯一</th>
<th>是否允许为空</th>
<th>表中键的数量</th>
<th>是否允许组合键</th>
</tr>
</thead>
<tbody><tr>
<td>主键</td>
<td>是</td>
<td>否</td>
<td>至多1个</td>
<td>是</td>
</tr>
<tr>
<td>唯一键</td>
<td>是</td>
<td>是</td>
<td>没有限制</td>
<td>是</td>
</tr>
</tbody></table>
<p>外键</p>
<ol>
<li><p>用于限制两个表的关系，从表的字段值引用了主表的某字段值</p>
</li>
<li><p>外键列和主表的被引用列要求类型一致，意义一样，名称无要求</p>
</li>
<li><p>主表的被引用列要求是一个key（一般就是主键）</p>
</li>
<li><p>插入删除时存在规则</p>
<ol>
<li><p>插入数据，先插入主表</p>
</li>
<li><p>删除数据，先删除从表</p>
<p>可以通过以下两种方式来删除主表的记录<br>级联删除</p>
<pre><code> ALTER TABLE stuinfo ADD CONSTRAINT fk_stu_major FOREIGN KEY(majorid) REFERENCES major(id) ON DELETE CASCADE;
</code></pre>
<p>级联置空</p>
<pre><code> ALTER TABLE stuinfo ADD CONSTRAINT fk_stu_major FOREIGN KEY(majorid) REFERENCES major(id) ON DELETE SET NULL;
</code></pre>
</li>
</ol>
</li>
</ol>
<h3 id="定义约束"><a href="#定义约束" class="headerlink" title="定义约束"></a>定义约束</h3><p><strong>创建表时添加约束</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">推荐写法</span><br><span class="line">    <span class="keyword">create</span> <span class="keyword">table</span> 表名(</span><br><span class="line">        字段名 字段类型 <span class="keyword">not</span> <span class="keyword">null</span>,#非空</span><br><span class="line">        字段名 字段类型 <span class="keyword">primary</span> key,#主键</span><br><span class="line">        字段名 字段类型 <span class="keyword">unique</span>,#唯一</span><br><span class="line">        字段名 字段类型 <span class="keyword">default</span> 值,#默认</span><br><span class="line">        [<span class="keyword">constraint</span> 约束名] <span class="keyword">foreign</span> key(字段名,推荐fk_表<span class="number">1</span>_表<span class="number">2</span>) <span class="keyword">references</span> 主表（被引用列）</span><br><span class="line">    )</span><br><span class="line">	</span><br><span class="line">添加列级约束</span><br><span class="line">    <span class="keyword">create</span> <span class="keyword">table</span> student(</span><br><span class="line">        id <span class="type">int</span> <span class="keyword">primary</span> key,#主键</span><br><span class="line">        name <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span>,#非空</span><br><span class="line">        gender <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">check</span>(gender<span class="operator">=</span><span class="string">&#x27;男&#x27;</span> <span class="keyword">or</span> gender<span class="operator">=</span><span class="string">&#x27;女&#x27;</span>),#检查</span><br><span class="line">        seat <span class="type">int</span> <span class="keyword">unique</span>,#唯一</span><br><span class="line">        age <span class="type">int</span> <span class="keyword">default</span> <span class="number">18</span>,#默认</span><br><span class="line">        majorid <span class="type">int</span> <span class="keyword">references</span> major(id)#外键,并没有添加外键，外键必须由表级约束添加，并且对于外键添加的约束都无效</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">create</span> <span class="keyword">table</span> major(</span><br><span class="line">        id <span class="type">int</span> <span class="keyword">primary</span> key,</span><br><span class="line">        majorname <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line">    )</span><br><span class="line">添加表级约束</span><br><span class="line">    <span class="keyword">create</span> <span class="keyword">table</span> student(</span><br><span class="line">        id <span class="type">int</span>,</span><br><span class="line">        name <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">        gender <span class="type">char</span>(<span class="number">1</span>),</span><br><span class="line">        seat <span class="type">int</span>,</span><br><span class="line">        age <span class="type">int</span>,</span><br><span class="line">        majorid <span class="type">int</span>,</span><br><span class="line">        # <span class="keyword">constraint</span> <span class="keyword">PRIMARY</span> <span class="keyword">primary</span> key(id),</span><br><span class="line">        <span class="keyword">constraint</span> <span class="keyword">PRIMARY</span> <span class="keyword">primary</span> key(id,name),#组合主键</span><br><span class="line">        <span class="keyword">constraint</span> uq <span class="keyword">unique</span>(seat),</span><br><span class="line">        <span class="keyword">constraint</span> ck <span class="keyword">check</span>(gender<span class="operator">=</span><span class="string">&#x27;男&#x27;</span> <span class="keyword">or</span> gender<span class="operator">=</span><span class="string">&#x27;女&#x27;</span>),</span><br><span class="line">        <span class="keyword">constraint</span> fk_student_major <span class="keyword">foreign</span> key(majorid) <span class="keyword">references</span> major(id)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p><strong>修改表时添加或删除约束</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、非空</span><br><span class="line">添加非空(列级约束)</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 modify <span class="keyword">column</span> 字段名 字段类型 <span class="keyword">not</span> <span class="keyword">null</span>;</span><br><span class="line">删除非空</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 modify <span class="keyword">column</span> 字段名 字段类型 ;</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、默认</span><br><span class="line">添加默认(列级约束)</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 modify <span class="keyword">column</span> 字段名 字段类型 <span class="keyword">default</span> 值;</span><br><span class="line">删除默认</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 modify <span class="keyword">column</span> 字段名 字段类型 ;</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、主键</span><br><span class="line">添加主键</span><br><span class="line">	列级约束</span><br><span class="line">		<span class="keyword">alter</span> <span class="keyword">table</span> 表名 modify <span class="keyword">column</span> 字段名 类型 <span class="keyword">primary</span> key;</span><br><span class="line">	表级约束</span><br><span class="line">		<span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">add</span>【 <span class="keyword">constraint</span> 约束名】 <span class="keyword">primary</span> key(字段名);</span><br><span class="line">删除主键</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">drop</span> <span class="keyword">primary</span> key;</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、唯一</span><br><span class="line">添加唯一</span><br><span class="line">	列级约束</span><br><span class="line">		<span class="keyword">alter</span> <span class="keyword">table</span> 表名 modify <span class="keyword">column</span> 字段名 类型 <span class="keyword">unique</span>;</span><br><span class="line">	表级约束</span><br><span class="line">		<span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">add</span>【 <span class="keyword">constraint</span> 约束名】 <span class="keyword">unique</span>(字段名);</span><br><span class="line">删除唯一</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">drop</span> index 索引名;</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、外键</span><br><span class="line">添加外键(表级约束)</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">add</span>【 <span class="keyword">constraint</span> 约束名】 <span class="keyword">foreign</span> key(字段名) <span class="keyword">references</span> 主表（被引用列）;</span><br><span class="line">删除外键</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">drop</span> <span class="keyword">foreign</span> key 约束名;</span><br></pre></td></tr></table></figure>

<h3 id="自增长列"><a href="#自增长列" class="headerlink" title="自增长列"></a>自增长列</h3><ol>
<li>不用手动插入值，可以自动提供序列值，默认从1开始，步长为1<pre><code>auto_increment_increment步长
auto_increment_offset起始值(mysql中不能修改)
如果要更改起始值：第一次插入时，手动插入值
如果要更改步长：更改系统变量
    set auto_increment_increment=值;
</code></pre>
</li>
<li>一个表<strong>至多有一个自增长列</strong></li>
<li>自增长列只能支持<strong>数值型</strong></li>
<li>==自增长列必须为一个key==</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">一、创建表时设置自增长列</span><br><span class="line">    <span class="keyword">create</span> <span class="keyword">table</span> 表(</span><br><span class="line">        字段名 字段类型 约束 auto_increment</span><br><span class="line">    )</span><br><span class="line">二、修改表时设置自增长列</span><br><span class="line">	<span class="keyword">alter</span> <span class="keyword">table</span> 表 modify <span class="keyword">column</span> 字段名 字段类型 约束 auto_increment</span><br><span class="line">三、删除自增长列</span><br><span class="line">	<span class="keyword">alter</span> <span class="keyword">table</span> 表 modify <span class="keyword">column</span> 字段名 字段类型 约束 </span><br></pre></td></tr></table></figure>



<h2 id="DTL语言"><a href="#DTL语言" class="headerlink" title="DTL语言"></a>DTL语言</h2><p>Database Transaction Language</p>
<h3 id="含义"><a href="#含义" class="headerlink" title="含义"></a>含义</h3><p>​    通过一组逻辑操作单元（一组DML-sql语句），将数据从一种状态切换到另外一种状态</p>
<h3 id="特点-ACID"><a href="#特点-ACID" class="headerlink" title="特点(ACID)"></a>特点(ACID)</h3><ul>
<li>原子性(Atomicity)：要么都执行，要么都回滚</li>
<li>一致性(Consistency)：保证数据的状态操作前和操作后保持一致(保证数据准确)</li>
<li>隔离性(Isolation)：多个事务同时操作相同数据库的同一个数据时，一个事务的执行不受另外一个事务的干扰</li>
<li>持久性(Durability)：一个事务一旦提交，则数据将持久化到本地，除非其他事务对其进行修改</li>
</ul>
<p>相关步骤：</p>
<pre><code>1、开启事务
2、编写事务的一组逻辑操作单元（多条sql语句）
3、提交事务或回滚事务
</code></pre>
<h3 id="事务的分类"><a href="#事务的分类" class="headerlink" title="事务的分类"></a>事务的分类</h3><p>隐式事务，没有明显的开启和结束事务的标志</p>
<pre><code>insert、update、delete语句本身就是一个事务
</code></pre>
<p>显式事务，具有明显的开启和结束事务的标志</p>
<pre><code>1、禁用自动提交事务的功能,开启事务
    set autocommit=0;# 只针对当前事务
    start transaction;# 也可以不写
2、编写事务的一组逻辑操作单元（select,insert,update,delete）
    DDL并不是事务
3、提交事务或回滚事务(回滚操作不能单纯在mysql上使用,必须结合实际应用,如jdbc)
    commit;
    rollback;
</code></pre>
<h3 id="使用到的关键字"><a href="#使用到的关键字" class="headerlink" title="使用到的关键字"></a>使用到的关键字</h3><pre><code>set autocommit=0;
start transaction;
commit;
rollback;

savepoint  断点
commit to 断点
rollback to 断点
</code></pre>
<h3 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h3><p>事务并发问题如何发生？</p>
<pre><code>当多个事务同时操作同一个数据库的相同数据时
</code></pre>
<p>事务的并发问题有哪些？</p>
<pre><code>丢失更新：多个事务对相同数据操作时，最后的更新覆盖了由其他事务所做的更新
（事务1开启事务，事务2在开启并提交事务，事务1回滚，导致事务2的提交被覆盖；
  事务1开启事务，事务2在开启并提交事务，事务1提交，导致事务2的提交被覆盖；）
脏读：事务1读取到了事务2已修改但未提交的数据。(如果事务2回滚,则事务1读取的数据就是脏数据)
不可重复读：相同事务，读取结果(数据本身)不一样。(事务1读取数据并未结束，事务2更新数据并提交，事务1再次读取数据，两次读取的数据就不一样了。)
幻读：相同事务，读取结果(数据条数)不一样。(事务1读取数据并未结束，事务2插入或删除数据并提交，事务1再次读取数据，两次读取的数据就不一样了。)
</code></pre>
<p>如何避免事务的并发问题？</p>
<p>==对于mysql来说，通常采用前三种隔离级别加上相应的并发锁的机制来控制对数据的访问==</p>
<p><strong>事务隔离级别</strong></p>
<p>丢失更新只能通过并发锁来实现</p>
<table>
<thead>
<tr>
<th></th>
<th>说明</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody><tr>
<td>READ UNCOMMITTED</td>
<td></td>
<td>允许</td>
<td>允许</td>
<td>允许</td>
</tr>
<tr>
<td>READ COMMITTED</td>
<td>事务的更新操作结果只有在该事务提交之后，才能对另一个事务可见</td>
<td>不允许</td>
<td>允许</td>
<td>允许</td>
</tr>
<tr>
<td>REPEATABLE READ</td>
<td>保证在整个事务的过程中，对同一笔数据的读取结果是相同的</td>
<td>不允许</td>
<td>不允许</td>
<td>允许</td>
</tr>
<tr>
<td>SERIALIZABLE</td>
<td>所有事务必须依次执行，性能差</td>
<td>不允许</td>
<td>不允许</td>
<td>不允许</td>
</tr>
</tbody></table>
<ul>
<li>oracle只支持READ COMMITED(默认)、SERIALIZABLE</li>
<li>mysql支持四种，默认REPEATABLE READ</li>
</ul>
<p>设置隔离级别：</p>
<pre><code>set session(当前会话)|global(全局)  transaction isolation level 隔离级别名;
</code></pre>
<p>查看隔离级别：</p>
<pre><code>select @@tx_isolation;
</code></pre>
<h3 id="设置保存点"><a href="#设置保存点" class="headerlink" title="设置保存点"></a>设置保存点</h3><p>savepoint+rollback搭配使用实现回滚到固定位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">set autocommit&#x3D;0;</span><br><span class="line">start transacation;</span><br><span class="line">delete from account where id&#x3D;25;</span><br><span class="line">savepoint a;# 设置保存点</span><br><span class="line">delete from account where id&#x3D;16;</span><br><span class="line">rollback to a;# 回滚到保存点</span><br></pre></td></tr></table></figure>

<h3 id="delete和truncate在事务中区别"><a href="#delete和truncate在事务中区别" class="headerlink" title="delete和truncate在事务中区别"></a>delete和truncate在事务中区别</h3><ul>
<li>delete支持回滚</li>
<li>truncate不支持回滚</li>
</ul>
<h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><p>含义：理解成一张虚拟的表</p>
<h3 id="视图和表的区别"><a href="#视图和表的区别" class="headerlink" title="视图和表的区别"></a>视图和表的区别</h3><table>
<thead>
<tr>
<th></th>
<th>关键字</th>
<th>作用</th>
<th>占用物理空间</th>
</tr>
</thead>
<tbody><tr>
<td>视图</td>
<td>view</td>
<td>用于查询</td>
<td>占用较小，仅仅保存的是sql逻辑</td>
</tr>
<tr>
<td>表</td>
<td>table</td>
<td>增删改查</td>
<td>保存实际数据</td>
</tr>
</tbody></table>
<p>视图的好处：</p>
<ul>
<li>sql语句提高重用性，效率高</li>
<li>和表实现了分离，提高了==安全性==</li>
</ul>
<h3 id="定义视图"><a href="#定义视图" class="headerlink" title="定义视图"></a>定义视图</h3><p><strong>视图结构的查看</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DESC test_v7;</span><br><span class="line">SHOW CREATE VIEW test_v7;</span><br></pre></td></tr></table></figure>

<p><strong>视图的创建</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">	CREATE VIEW 视图名</span><br><span class="line">	AS</span><br><span class="line">	查询语句;</span><br></pre></td></tr></table></figure>

<p><strong>视图的修改</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#方式一：</span><br><span class="line">	CREATE OR REPLACE VIEW test_v7</span><br><span class="line">	AS</span><br><span class="line">	SELECT last_name FROM employees</span><br><span class="line">	WHERE employee_id&gt;100;</span><br><span class="line">#方式二:</span><br><span class="line">	ALTER VIEW test_v7</span><br><span class="line">	AS</span><br><span class="line">	SELECT employee_id FROM employees;</span><br><span class="line">	SELECT * FROM test_v7;</span><br></pre></td></tr></table></figure>

<p><strong>视图的删除</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP VIEW test_v1,test_v2,test_v3;</span><br></pre></td></tr></table></figure>



<h3 id="视图的操作"><a href="#视图的操作" class="headerlink" title="视图的操作"></a>视图的操作</h3><p>对于视图数据的操作，<strong>如果数据变化，会自动同步到原始表中</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、查看视图的数据 ★</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> my_v4;</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> my_v1 <span class="keyword">WHERE</span> last_name<span class="operator">=</span><span class="string">&#x27;Partners&#x27;</span>;</span><br><span class="line"><span class="number">2</span>、插入视图的数据</span><br><span class="line">	<span class="keyword">INSERT</span> <span class="keyword">INTO</span> my_v4(last_name,department_id) <span class="keyword">VALUES</span>(<span class="string">&#x27;虚竹&#x27;</span>,<span class="number">90</span>);</span><br><span class="line"><span class="number">3</span>、修改视图的数据</span><br><span class="line">	UPDATE my_v4 <span class="keyword">SET</span> last_name <span class="operator">=</span><span class="string">&#x27;梦姑&#x27;</span> <span class="keyword">WHERE</span> last_name<span class="operator">=</span><span class="string">&#x27;虚竹&#x27;</span>;</span><br><span class="line"><span class="number">4</span>、删除视图的数据</span><br><span class="line">	<span class="keyword">DELETE</span> <span class="keyword">FROM</span> my_v4;</span><br></pre></td></tr></table></figure>

<p><strong>某些视图数据不能操作</strong>(几乎所有视图都不允许操作)</p>
<ol>
<li>包含以下关键字的sql语句：分组函数、distinct、group  by、having、union或者union all</li>
<li>常量视图</li>
<li>Select中包含子查询</li>
<li>join</li>
<li>from一个不能更新的视图</li>
<li>where子句的子查询引用了from子句中的表</li>
</ol>
<p>==按照规范来讲，视图就是用于查询，所以应该是只读的，对于一些可以更新的视图，应该给视图加上权限，防止对原始表修改==</p>
<p><strong>案例</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 创建视图emp_v2,查询最高工资高于<span class="number">12000</span>的部门信息</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> emp_v2</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> department.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> department</span><br><span class="line"><span class="keyword">where</span> Id <span class="keyword">in</span> (</span><br><span class="line">	<span class="keyword">select</span> DepartmentId</span><br><span class="line">    <span class="keyword">from</span> employees</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> DepartmentId</span><br><span class="line">    <span class="keyword">having</span> <span class="built_in">max</span>(Salary)<span class="operator">&gt;</span><span class="number">12000</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><h3 id="系统变量"><a href="#系统变量" class="headerlink" title="系统变量"></a>系统变量</h3><p><strong>全局变量</strong></p>
<p>作用域：针对于所有会话（连接）有效，但<strong>重启后，配置失效</strong></p>
<pre><code>查看所有全局变量
    SHOW GLOBAL VARIABLES;
查看满足条件的部分系统变量
    SHOW GLOBAL VARIABLES LIKE &#39;%char%&#39;;
查看指定的系统变量的值
    SELECT @@global.autocommit;
为某个系统变量赋值
    SET @@global.autocommit=0;
    SET GLOBAL autocommit=0;
</code></pre>
<p><strong>会话变量</strong></p>
<p>作用域：针对于当前会话（连接）有效</p>
<pre><code>如果不写SESSION，默认为当前会话
查看所有会话变量
    SHOW [SESSION] VARIABLES;
查看满足条件的部分会话变量
    SHOW [SESSION] VARIABLES LIKE &#39;%char%&#39;;
查看指定的会话变量的值
    SELECT @@[session].tx_isolation;
为某个会话变量赋值
    SET @@[session].tx_isolation=&#39;read-uncommitted&#39;;
    SET SESSION tx_isolation=&#39;read-committed&#39;;
</code></pre>
<h3 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h3><p><strong>用户变量–@变量名</strong></p>
<p>声明并初始化</p>
<pre><code>SET @变量名=值;
SET @变量名:=值;
SELECT @变量名:=值;
</code></pre>
<p>赋值</p>
<pre><code>方式一：一般用于赋简单的值
    SET @变量名=值;
    SET @变量名:=值;
    SELECT @变量名:=值;
方式二：一般用于赋表中的字段值(只能是标量子查询)
    SELECT 字段名或表达式 INTO @变量名
    FROM 表;
</code></pre>
<p>用户变量赋值没有固定类型，即该变量类型定义为弱定义</p>
<p><strong>局部变量–变量名</strong></p>
<p>声明并初始化</p>
<pre><code>declare 变量名 类型 【default 值】;
</code></pre>
<p>赋值</p>
<pre><code>方式一：一般用于赋简单的值
    SET 变量名=值;
    SET 变量名:=值;
    SELECT 变量名:=值;
方式二：一般用于赋表 中的字段值
    SELECT 字段名或表达式 INTO 变量名
    FROM 表;
</code></pre>
<p><strong>用户变量与局部变量的区别</strong></p>
<table>
<thead>
<tr>
<th></th>
<th>作用域</th>
<th>定义位置</th>
<th>语法</th>
</tr>
</thead>
<tbody><tr>
<td>用户变量</td>
<td>当前会话</td>
<td>会话的任何地方</td>
<td>@变量名，不用指定类型</td>
</tr>
<tr>
<td>局部变量</td>
<td>定义它的BEGIN END中</td>
<td>BEGIN END的第一句话</td>
<td>一般不用加@，需要指定类型</td>
</tr>
</tbody></table>
<p><strong>案例</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 声明两个变量并赋初值，求和并打印</span><br><span class="line"># 用户变量</span><br><span class="line">set @m&#x3D;1;</span><br><span class="line">set @n&#x3D;2;</span><br><span class="line">set @sum&#x3D;@m+@n;</span><br><span class="line">select @sum;</span><br></pre></td></tr></table></figure>



<h2 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>一组经过预先编译的sql语句的集合，类似java中的方法</p>
<p><strong>作用</strong></p>
<ul>
<li>提高了sql语句的重用性，减少了开发程序员的压力</li>
<li>提高效率<ul>
<li>减少编译次数（初次编译，之后使用无需重复编译）</li>
<li>减少数据库服务器连接次数（将sql语句进行打包，在一次连接中执行）</li>
</ul>
</li>
</ul>
<h3 id="创建存储过程"><a href="#创建存储过程" class="headerlink" title="创建存储过程"></a>创建存储过程</h3><p><strong>语法</strong></p>
<pre><code>create procedure 存储过程名(参数模式 参数名  参数类型,...)
begin
    存储过程体
end
</code></pre>
<p><strong>参数模式</strong></p>
<ul>
<li>in：该参数作为传入参数，调用时需要传参</li>
<li>out：该参数作为返回参数</li>
<li>inout：该参数即作为传入参数，又作为返回参数</li>
<li>==这些参数就是局部变量，赋值方式参考局部变量赋值方式==</li>
</ul>
<p><strong>注意</strong></p>
<ul>
<li>存储过程体中只有一条sql语句，则可以省略begin end</li>
<li>存储过程体中每条sql语句结果必须加分号</li>
</ul>
<h3 id="结束标记delimiter"><a href="#结束标记delimiter" class="headerlink" title="结束标记delimiter"></a>结束标记delimiter</h3><p>使用delimiter关键字来设置结束标记</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">语法:</span><br><span class="line">	delimiter 新的结束标记</span><br><span class="line">示例:</span><br><span class="line">	delimiter $</span><br><span class="line">    CREATE PROCEDURE 存储过程名(IN|OUT|INOUT 参数名  参数类型,...)</span><br><span class="line">    BEGIN</span><br><span class="line">        sql语句1;</span><br><span class="line">        sql语句2;</span><br><span class="line">        ...</span><br><span class="line">    END $</span><br></pre></td></tr></table></figure>



<h3 id="调用存储过程"><a href="#调用存储过程" class="headerlink" title="调用存储过程"></a>调用存储过程</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">语法:</span><br><span class="line">	<span class="keyword">call</span> 存储过程名(实参列表) 结束标记</span><br><span class="line">示例:</span><br><span class="line"><span class="comment">---------------------------------------------------------</span></span><br><span class="line"># 空参类型存储过程</span><br><span class="line">	# 创建</span><br><span class="line">	delimiter $</span><br><span class="line">	# 功能:数据插入</span><br><span class="line">    <span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> store1()</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">    	<span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">    	# 关闭自动提交</span><br><span class="line">    	<span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    	REPEAT</span><br><span class="line">    		<span class="keyword">set</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span></span><br><span class="line">    		<span class="keyword">insert</span> <span class="keyword">into</span> admin(username,<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">   			<span class="keyword">values</span>(<span class="string">&#x27;John&#x27;</span>,<span class="string">&#x27;0001&#x27;</span>),(<span class="string">&#x27;Mary&#x27;</span>,<span class="string">&#x27;0002&#x27;</span>),(<span class="string">&#x27;Tom&#x27;</span>,<span class="string">&#x27;0003&#x27;</span>),(<span class="string">&#x27;Alice&#x27;</span>,<span class="string">&#x27;004&#x27;</span>);</span><br><span class="line">        UNTIL i <span class="operator">=</span> max_num</span><br><span class="line">        <span class="keyword">END</span> REPEAT;</span><br><span class="line">        <span class="keyword">COMMIT</span>;</span><br><span class="line">    <span class="keyword">END</span> $</span><br><span class="line">    </span><br><span class="line">    # 调用</span><br><span class="line">    <span class="keyword">call</span> myp1()$</span><br><span class="line"> <span class="comment">----------------------------------------------------------   </span></span><br><span class="line">#  带<span class="keyword">in</span>模式参数的存储过程</span><br><span class="line">	# 创建</span><br><span class="line">	delimiter $</span><br><span class="line">	# 功能:查询选课的学生信息</span><br><span class="line">	<span class="keyword">create</span> <span class="keyword">procedure</span> store2(<span class="keyword">in</span> majorName <span class="type">varchar</span>(<span class="number">20</span>))</span><br><span class="line">	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line">		<span class="keyword">from</span> student</span><br><span class="line">		<span class="keyword">where</span> majorId <span class="operator">=</span> (</span><br><span class="line">        	<span class="keyword">select</span> id</span><br><span class="line">            <span class="keyword">from</span> major</span><br><span class="line">            <span class="keyword">where</span> name<span class="operator">=</span>majorName</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">end</span> $</span><br><span class="line">    </span><br><span class="line">    # 调用</span><br><span class="line">    <span class="keyword">call</span> store2(<span class="string">&#x27;计算机体系结构&#x27;</span>)$</span><br><span class="line">    </span><br><span class="line"># 创建存储过程实现，用户是否登录成功</span><br><span class="line">	<span class="keyword">create</span> <span class="keyword">procedure</span> store3(<span class="keyword">in</span> username <span class="type">varchar</span>(<span class="number">20</span>),<span class="keyword">in</span> password <span class="type">varchar</span>(<span class="number">20</span>))</span><br><span class="line">	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">declare</span> <span class="keyword">result</span> <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">		<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">into</span> <span class="keyword">result</span></span><br><span class="line">		<span class="keyword">from</span> admin</span><br><span class="line">		<span class="keyword">where</span> admin.username<span class="operator">=</span>username</span><br><span class="line">		<span class="keyword">and</span> admin.password<span class="operator">=</span>password;</span><br><span class="line">		<span class="keyword">select</span> if(<span class="keyword">result</span><span class="operator">&gt;</span><span class="number">0</span>,<span class="string">&#x27;成功&#x27;</span>,<span class="string">&#x27;失败&#x27;</span>);</span><br><span class="line">    <span class="keyword">end</span> $</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">call</span> store3$</span><br><span class="line"><span class="comment">-------------------------------------------------------------</span></span><br><span class="line"># 创建带<span class="keyword">out</span>模式的存储过程</span><br><span class="line">	<span class="keyword">create</span> <span class="keyword">procedure</span> store4(<span class="keyword">in</span> studentName <span class="type">varchar</span>(<span class="number">20</span>),<span class="keyword">out</span> majorName <span class="type">varchar</span>(<span class="number">20</span>),<span class="keyword">out</span> majorCredit <span class="type">int</span>)</span><br><span class="line">	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">select</span> major.Name,major.credit <span class="keyword">into</span> majorName,majorCredit</span><br><span class="line">		<span class="keyword">from</span> student</span><br><span class="line">		<span class="keyword">join</span> major <span class="keyword">on</span> student.majorId<span class="operator">=</span>major.id</span><br><span class="line">		<span class="keyword">where</span> student.name<span class="operator">=</span>studentName;</span><br><span class="line">	<span class="keyword">end</span> $</span><br><span class="line">	# 使用用户变量来接受局部变量</span><br><span class="line">	<span class="keyword">call</span> store4(<span class="string">&#x27;张三&#x27;</span>,<span class="variable">@majorName</span>,<span class="variable">@majorCredit</span>)$</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<p><strong>删除存储过程</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop procedure 存储过程名;</span><br></pre></td></tr></table></figure>

<p><strong>查看存储过程</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show create procedure 存储过程名;</span><br></pre></td></tr></table></figure>

<p><strong>修改存储过程</strong></p>
<p>不能修改</p>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="函数和存储过程的区别"><a href="#函数和存储过程的区别" class="headerlink" title="函数和存储过程的区别"></a>函数和存储过程的区别</h3><table>
<thead>
<tr>
<th></th>
<th>关键字</th>
<th>调用语法</th>
<th>返回值</th>
<th>应用场景</th>
</tr>
</thead>
<tbody><tr>
<td>函数</td>
<td>function</td>
<td>select</td>
<td>有且仅有一个</td>
<td>查询结果为一个值</td>
</tr>
<tr>
<td>存储过程</td>
<td>procedure</td>
<td>call</td>
<td>0个或多个</td>
<td>更新</td>
</tr>
</tbody></table>
<p>存储过程中可以直接使用函数</p>
<h3 id="创建函数"><a href="#创建函数" class="headerlink" title="创建函数"></a>创建函数</h3><p>学过的函数：LENGTH、SUBSTR、CONCAT等<br>语法：</p>
<pre><code>delimiter $
CREATE FUNCTION 函数名(参数名 参数类型,...) RETURNS 返回类型
BEGIN
    函数体,必须包含return语句
END
select 函数名(参数)$
</code></pre>
<p>当函数体只有一条语句时，BEGIN END可以省略</p>
<h3 id="调用函数"><a href="#调用函数" class="headerlink" title="调用函数"></a>调用函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 函数名（实参列表）</span><br><span class="line"></span><br><span class="line"><span class="comment">---------------------</span></span><br><span class="line"># 无参函数</span><br><span class="line">delimiter $</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> countEmp() <span class="keyword">returns</span> <span class="type">int</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">return</span>(</span><br><span class="line">    	<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>)</span><br><span class="line">        <span class="keyword">from</span> employees</span><br><span class="line">    );</span><br><span class="line"><span class="keyword">end</span> $</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> countEmp()$</span><br></pre></td></tr></table></figure>

<p>查看函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show create function 函数名;</span><br></pre></td></tr></table></figure>

<p>删除函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop function 函数名;</span><br></pre></td></tr></table></figure>

<p>==函数和存储过程的定义，实际存储在数据库名为mysql数据库中proc表下==</p>
<h2 id="流程控制结构"><a href="#流程控制结构" class="headerlink" title="流程控制结构"></a>流程控制结构</h2><h3 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h3><p><strong>分类</strong></p>
<ul>
<li>if函数，简单双分支</li>
<li>case结构，等值判断的多分支</li>
<li>if elseif结构，区间判断的多分支</li>
</ul>
<p><strong>if</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">	if(条件，值1，值2)</span><br><span class="line">特点</span><br><span class="line">	可以用在任何位置</span><br></pre></td></tr></table></figure>

<p><strong>case</strong></p>
<pre><code>语法
    情况一：类似于switch
        case 表达式
        when 值1 then 结果1或语句1(如果是语句，需要加分号) 
        when 值2 then 结果2或语句2(如果是语句，需要加分号)
        ...
        else 结果n或语句n(如果是语句，需要加分号)
        end 【case】（如果是放在begin end中需要加上case，如果放在select后面不需要）

        select (case
        when id%2=0 then id-1
        when id=(select max(id) from seat) then id
        else id+1 end) as id ,student
        from seat 
        order by id;

    情况二：类似于多重if
        case 
        when 条件1 then 结果1或语句1(如果是语句，需要加分号) 
        when 条件2 then 结果2或语句2(如果是语句，需要加分号)
        ...
        else 结果n或语句n(如果是语句，需要加分号)
        end 【case】（如果是放在begin end中需要加上case，如果放在select后面不需要）
特点
    then 后面结果是值时，可以在任何地方使用
    then 后面结果是语句时，只能在begin-end作用范围内使用
</code></pre>
<p><strong>if elseif</strong></p>
<pre><code>语法
    if 情况1 then 语句1;
    elseif 情况2 then 语句2;
    ...
    else 语句n;
    end if;
特点：
    只能在begin-end作用范围内使用
</code></pre>
<p><strong>案例</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">delimater $</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> judge_grade(score <span class="type">int</span>) <span class="keyword">returns</span> <span class="type">char</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	if(score<span class="operator">&gt;=</span><span class="number">90</span>) <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">	elseif(score<span class="operator">&gt;=</span><span class="number">80</span>) <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">&#x27;B&#x27;</span>;</span><br><span class="line">	elseif(score<span class="operator">&gt;=</span><span class="number">70</span>) <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">&#x27;C&#x27;</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">return</span> <span class="string">&#x27;D&#x27;</span>;</span><br><span class="line">	<span class="keyword">end</span> if;</span><br><span class="line"><span class="keyword">end</span> $</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> judge_grade(<span class="number">80</span>)$</span><br></pre></td></tr></table></figure>



<h3 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h3><p>循环结构只能在begin-end作用范围内使用</p>
<p><strong>分类</strong></p>
<ul>
<li>loop 死循环</li>
<li>while 类似java中while</li>
<li>repeat 类似java中do-while</li>
</ul>
<p><strong>循环控制语句关键字</strong></p>
<ul>
<li>iterate 类似java中continue</li>
<li>leave 类似java中break</li>
</ul>
<p><strong>loop</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">	【标签:】 loop</span><br><span class="line">            循环体</span><br><span class="line">    end loop 【标签】;</span><br></pre></td></tr></table></figure>

<p><strong>while</strong></p>
<pre><code>语法
    【标签:】 WHILE 循环条件 DO
        循环体
        【iterate 标签】
    END WHILE 【标签】;
</code></pre>
<p>repeat</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">语法:</span><br><span class="line">    【名称:】repeat</span><br><span class="line">            循环体</span><br><span class="line">    until 结束条件 </span><br><span class="line">    end repeat 【名称】</span><br></pre></td></tr></table></figure>

<p><strong>案例</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># 根据传入的参数n，批量插入n次</span><br><span class="line">delimiter $</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> <span class="keyword">insert</span>(<span class="keyword">in</span> <span class="type">time</span> <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">	while i<span class="operator">&lt;</span><span class="type">time</span> do</span><br><span class="line">		<span class="keyword">insert</span> <span class="keyword">into</span> admin(<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;password&#x27;</span>) <span class="keyword">values</span>(concat(<span class="string">&#x27;admin&#x27;</span>,i),<span class="string">&#x27;1234&#x27;</span>);</span><br><span class="line">		<span class="keyword">set</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line">	<span class="keyword">end</span> while;</span><br><span class="line"><span class="keyword">end</span> $</span><br><span class="line"><span class="keyword">call</span> <span class="keyword">insert</span>(<span class="number">5</span>)$</span><br><span class="line"></span><br><span class="line"># 根据传入的参数n，批量插入n次，批量插入最多允许<span class="number">20</span>次</span><br><span class="line">delimiter $</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> <span class="keyword">insert</span>(<span class="keyword">in</span> <span class="type">time</span> <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">	a:while i<span class="operator">&lt;</span><span class="type">time</span> do</span><br><span class="line">		<span class="keyword">insert</span> <span class="keyword">into</span> admin(<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;password&#x27;</span>) <span class="keyword">values</span>(concat(<span class="string">&#x27;admin&#x27;</span>,i),<span class="string">&#x27;1234&#x27;</span>);</span><br><span class="line">		<span class="keyword">set</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line">		if i<span class="operator">=</span><span class="operator">=</span><span class="number">20</span> <span class="keyword">then</span> leave a;</span><br><span class="line">	<span class="keyword">end</span> while;</span><br><span class="line"><span class="keyword">end</span> $</span><br><span class="line"><span class="keyword">call</span> <span class="keyword">insert</span>(<span class="number">21</span>)$</span><br><span class="line"></span><br><span class="line"># 已知表stringcontent</span><br><span class="line"># 其中字段:</span><br><span class="line"># id 自增长</span><br><span class="line"># content <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line"># 向该表插入指定长度的随机字符串</span><br><span class="line">delimiter $</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> insert_random_str(<span class="keyword">in</span> length <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;# 循环变量</span><br><span class="line">	<span class="keyword">declare</span> idx <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;# 随机值</span><br><span class="line">	<span class="keyword">declare</span> str <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">default</span> &quot;&quot;;# 插入字符串</span><br><span class="line">	while i<span class="operator">&lt;</span>length do</span><br><span class="line">		<span class="keyword">set</span> idx<span class="operator">=</span><span class="built_in">floor</span>(rand()<span class="operator">*</span><span class="number">26</span><span class="operator">+</span><span class="number">1</span>)<span class="operator">+</span><span class="number">97</span>;# ascii码</span><br><span class="line">		<span class="keyword">set</span> str<span class="operator">=</span>concat(str,<span class="type">char</span>(idx));</span><br><span class="line">	<span class="keyword">end</span> while;</span><br><span class="line">	<span class="keyword">insert</span> <span class="keyword">into</span> stringcontent(content) <span class="keyword">values</span>(str);</span><br><span class="line"><span class="keyword">end</span> $</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> insert_random_str(<span class="number">20</span>)$</span><br></pre></td></tr></table></figure>



<h1 id="Mysql高级"><a href="#Mysql高级" class="headerlink" title="Mysql高级"></a>Mysql高级</h1><h2 id="Mysql逻辑架构图"><a href="#Mysql逻辑架构图" class="headerlink" title="Mysql逻辑架构图"></a>Mysql逻辑架构图</h2><p>和其它数据库相比， MySQL 有点与众不同， 它的架构可以在<strong>多种不同场景</strong>中应用并发挥良好作用。 主要体现在存储引擎的架构上， <strong>插件式的存储引擎架构</strong>将查询处理和其它的系统任务以及数据的存储提取相分离。 这种架构可以根据业务的需求和实际需要选择合适的存储引擎  </p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200710225810242.png" alt="image-20200710225810242"></p>
<h3 id="连接层"><a href="#连接层" class="headerlink" title="连接层"></a>连接层</h3><p>最上层是一些客户端和连接服务， 包含本地 sock 通信和大多数基于客户端/服务端工具实现的类似于 tcp/ip 的通信。 主要完成一些类似于连接处理、 授权认证、 及相关的安全方案。 在该层上引入了线程池的概念， 为通过认证安全接入的客户端提供线程。 同样在该层上可以实现基于 SSL 的安全链接。 服务器也会为安全接入的每个客户端验证它所具有的操作权限。  </p>
<h3 id="服务层"><a href="#服务层" class="headerlink" title="服务层"></a>服务层</h3><table>
<thead>
<tr>
<th>组件</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>Management Serveices &amp; Utilities</td>
<td>系统管理和控制工具</td>
</tr>
<tr>
<td>SQL Interface:</td>
<td>SQL 接口。 接受用户的 SQL 命令， 并且返回用户需要查询的结果。 比如 select from 就是调用 SQL Interface</td>
</tr>
<tr>
<td>Parser</td>
<td>解析器。 SQL 命令传递到解析器的时候会被解析器进行语法规则验证和解析</td>
</tr>
<tr>
<td>Optimizer</td>
<td>查询优化器。 SQL 语句在查询之前会使用查询优化器对查询进行优化， 比如有 where 条件时， 优化器来决定先投影还是先过滤。</td>
</tr>
<tr>
<td>Cache 和 Buffer</td>
<td>查询缓存。 如果查询缓存有命中的查询结果， 查询语句就可以直接去查询缓存中取 数据。 这个缓存机制是由一系列小缓存组成的。 比如表缓存， 记录缓存， key 缓存， 权限缓存等</td>
</tr>
</tbody></table>
<h3 id="引擎层"><a href="#引擎层" class="headerlink" title="引擎层"></a>引擎层</h3><p>存储引擎层， 存储引擎真正的负责了 MySQL 中数据的存储和提取， 服务器通过 API 与存储引擎进行通信。 不同的存储引擎具有的功能不同， 这样我们可以根据自己的实际需要进行选取。 </p>
<h3 id="MyISAM引擎和InnoDB引擎区别"><a href="#MyISAM引擎和InnoDB引擎区别" class="headerlink" title="MyISAM引擎和InnoDB引擎区别"></a>MyISAM引擎和InnoDB引擎区别</h3><p><strong>InnoDB 的数据是按数据页为单位来进行读写的</strong></p>
<p>InnDB索引不只是B+树，InnoDB引擎有一个特殊的功能叫做“自适应哈希索引(adaptive hash index)”。 当InnoDB注意到某些索引值被使用得非常频繁时，它会在内存中基于B-Tree索引之上再创建-一个哈希索引，这样就让B-Tree索引也具有哈希索引的一些优点，比如快速的哈希查找。这是一个完全自动的、内部的行为，用户无法控制或者配置，不过如果有必要,完全可以关闭该功能。<a target="_blank" rel="noopener" href="https://blog.csdn.net/dkingyaoyao/article/details/90373581?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.channel_param&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.channel_param">参考网址</a></p>
<table>
<thead>
<tr>
<th>对比项</th>
<th>MyISAM</th>
<th>InnoDB</th>
</tr>
</thead>
<tbody><tr>
<td>外键</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>事务</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>行表锁</td>
<td>表锁， 即使操作一条记录也会锁住整个表， 不适合高并发的操作</td>
<td>行锁,操作时只锁某一行， 不对其它行有影响， 适合<strong>高并发</strong>的操作</td>
</tr>
<tr>
<td>缓存</td>
<td>只缓存索引， 不缓存真实数据</td>
<td>不仅缓存索引还要缓存真实数据， 对内存要求较高， 而且内 存大小对性能有决定性的影响</td>
</tr>
<tr>
<td>关注点</td>
<td>读<strong>性能</strong></td>
<td>并发写、 事务、 资源</td>
</tr>
<tr>
<td>默认安装</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>默认使用</td>
<td>N</td>
<td>Y</td>
</tr>
<tr>
<td>自 带 系 统 表 使用</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td>是否支持MVCC</td>
<td>N</td>
<td>支持应对高并发事务, MVCC比单纯的加锁更高效;MVCC只在 <code>READ COMMITTED</code> 和 <code>REPEATABLE READ</code> 两个隔离级别下工作;MVCC可以使用 乐观(optimistic)锁 和 悲观(pessimistic)锁来实现</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 查看所有数据库引擎</span><br><span class="line"><span class="keyword">show</span> engines</span><br><span class="line"># 查看默认数据库引擎</span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%storage_engine%&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="存储层"><a href="#存储层" class="headerlink" title="存储层"></a>存储层</h3><p>数据存储层， 主要是将数据存储在运行于裸设备的文件系统之上， 并完成与存储引擎的交互。</p>
<h2 id="Mysql查询与执行流程"><a href="#Mysql查询与执行流程" class="headerlink" title="Mysql查询与执行流程"></a>Mysql查询与执行流程</h2><h3 id="查询流程"><a href="#查询流程" class="headerlink" title="查询流程"></a>查询流程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A[&quot;mysql客户端&quot;]--&quot;1、通过协议，建立连接&quot;--&gt;B[&quot;mysql服务器&quot;]</span><br><span class="line">A--&quot;2、查询语言&quot;--&gt;B</span><br><span class="line">B--&quot;3、检查缓存，&quot;--&gt;C[&quot;缓存&quot;]</span><br><span class="line">C--&quot;命中，返回结果&quot;--&gt;A</span><br><span class="line">B--&quot;未命中&quot;--&gt;D[&quot;解析器&quot;]</span><br><span class="line">D--&quot;解析树&quot;--&gt;E[&quot;优化器&quot;]</span><br><span class="line">E--&quot;最优执行计划&quot;--&gt;F[&quot;引擎层&quot;]</span><br></pre></td></tr></table></figure>



<h3 id="mysql执行顺序"><a href="#mysql执行顺序" class="headerlink" title="mysql执行顺序"></a>mysql执行顺序</h3><p>sql编码顺序</p>
<img src="MySQL基础.assets/image-20200711073654105.png" alt="image-20200711073654105" style="zoom:67%;" />

<p>sql执行顺序</p>
<img src="MySQL基础.assets/image-20200711073725523.png" alt="image-20200711073725523" style="zoom:67%;" />

<img src="MySQL基础.assets/image-20200711073826886.png" alt="image-20200711073826886" style="zoom: 80%;" />



<h2 id="常见低性能原因及处理"><a href="#常见低性能原因及处理" class="headerlink" title="常见低性能原因及处理"></a>常见低性能原因及处理</h2><p><strong>常见原因</strong></p>
<ul>
<li>查询数据过多</li>
<li>关联过多的表，即使用太多Join</li>
<li>没有利用索引，或没有利用好索引</li>
<li>服务器调优及各个参数设置没有设置适当<ul>
<li>top，free，iostat，vmstat查看系统性能状态</li>
</ul>
</li>
<li>内存不足，导致产生大量IO操作</li>
<li>锁设置不适当<ul>
<li>线程阻塞</li>
<li>死锁</li>
</ul>
</li>
</ul>
<p><strong>发现解决问题步骤</strong></p>
<ol>
<li>观察，至少跑1天，看看生产的慢SQL情况</li>
<li>开启慢查询日志，设置阈值，比如超过5s的就是慢SQL，记录在日志中</li>
<li>使用Explain分析</li>
<li>show profile 查询SQL在Mysql服务器中的执行细节和生命周期情况</li>
<li>运维或DBA，进行数据库服务器的参数调优</li>
</ol>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p>帮助Mysql高效获取数据的<strong>数据结构</strong></p>
<p>一般而言，对于数据库索引都是B树索引。聚集索引、次要索引、复合索引、前缀索引、唯一索引都默认使用B+树索引。</p>
<p>除B树索引外，也有Hash索引</p>
<p>==虽然可以在表上建立很多个索引，但是查询时，只会使用表中的一个索引==</p>
<h3 id="索引的优缺点"><a href="#索引的优缺点" class="headerlink" title="索引的优缺点"></a>索引的优缺点</h3><p><strong>优点</strong></p>
<ul>
<li>降低数据库的IO成本，提高数据<strong>检索</strong>的效率</li>
<li>索引列对数据进行排序， 降低数据<strong>排序</strong>的成本， 降低了CPU的消耗</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>数据<strong>更新</strong>时，索引需要重新建立，增加时间开销</li>
<li>索引以文件方式存储在磁盘，带来额外空间开销</li>
</ul>
<h3 id="索引分类"><a href="#索引分类" class="headerlink" title="索引分类"></a>索引分类</h3><ul>
<li>单值索引：一个索引只包含一个列</li>
<li>复合索引：一个索引包含多个列，符合索引优先与单值索引</li>
<li>唯一索引：值必须唯一，允许有空值。自动在添加唯一约束的列上建立</li>
<li>主键索引：设置主键后，默认在主键上建立主键索引。innodb中主键索引为<strong>聚集索引</strong></li>
</ul>
<h3 id="普通索引和唯一索引的区别"><a href="#普通索引和唯一索引的区别" class="headerlink" title="普通索引和唯一索引的区别"></a>普通索引和唯一索引的区别</h3><ul>
<li>对于<strong>普通索引</strong>来说，查找到满足条件的第一个记录后，<strong>需要查找下一个记录</strong>，直到碰到第一个不满足条件的记录；（可能存在跨页的情况，但是影响几乎可以忽而略）</li>
<li>对于<strong>唯一索引</strong>来说，由于索引定义了唯一性，<strong>查找到第一个满足条件的记录后，就会停止继续检索</strong>。</li>
<li><strong>唯一索引的更新就不能使用 change buffer，实际上也只有普通索引才可以使用</strong></li>
</ul>
<p><strong>唯一索引的劣势</strong></p>
<p>对于唯一索引来说，<strong>所有的操作都要先判断这个操作是否违反了唯一性约束</strong>。比如：要插入（4，400）这个记录，就要先判断现在表中是否已经存在 k = 4 的记录，而这必须将数据页读入内存才能判断。如果已经读入到内存了，那就直接更新内存会更快，就没有必要使用 change buffer 了。</p>
<h3 id="数据更新过程"><a href="#数据更新过程" class="headerlink" title="数据更新过程"></a>数据更新过程</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/pcwl1206/article/details/86594705?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-7.channel_param&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-7.channel_param">参考网址</a></p>
<p>当需要一个数据页的时候</p>
<ul>
<li>如果数据页在内存中就直接更新</li>
<li>如果这个数据页还没有在内存中的话，在不影响数据一致性的前提下，<strong>InnoDB 会将这些更新操作缓存在 change buffer 中，这样就不需要从磁盘中读入这个数据页了。在下次查询需要访问这个数据页的时候，将数据页读入内存，然后执行 change buffer 中与这个页有关的操作</strong>。<ul>
<li>需要说明的是，虽然名字叫作 change buffer，实际上它是可以持久化的数据。也就是说，change buffer 在内存中有拷贝，也会被写入到磁盘上。</li>
<li>将 change buffer 中的操作应用到原数据页，得到最新的结果的过程称为：<strong>merge</strong>。除了访问这个数据页会触发 merge 外，系统有后台线程会定期 merge。在数据库正常关闭（shutdown）的过程中，也会执行 merge 操作。</li>
</ul>
</li>
</ul>
<p><strong>好处</strong></p>
<ul>
<li><strong>将更新操作先记录在 change buffer，减少读磁盘，语句的执行速度会得到明显的提升。而且，数据读入内存是需要占用 buffer pool 的，所以这种方式还能够避免占用内存，提高内存利用率。</strong></li>
</ul>
<p><strong>使用条件</strong></p>
<ul>
<li><strong>唯一索引的更新就不能使用 change buffer，实际上也只有普通索引才可以使用</strong></li>
</ul>
<p><strong>适用场景</strong></p>
<p>因为 merge 的时候是真正进行数据更新的时刻，而 change buffer 的主要目的就是将记录的变更动作缓存下来，所以在一个数据页做 merge 之前，change buffer 记录的变更越多（也就是这个页面上更新的次数越多），收益就越大。</p>
<ul>
<li><strong>因此，对于写多读少的业务来说，页面在写完以后马上被访问到的概率比较小，此时 change buffer 的使用效果最好。这种业务模型常见的就是账单类、日志类的系统。</strong></li>
</ul>
<h3 id="索引操作"><a href="#索引操作" class="headerlink" title="索引操作"></a>索引操作</h3><table>
<thead>
<tr>
<th>操作</th>
<th>命令</th>
</tr>
</thead>
<tbody><tr>
<td>创建</td>
<td>CREATE [UNIQUE ] INDEX [indexName] ON table_name(column))</td>
</tr>
<tr>
<td>删除</td>
<td>DROP INDEX [indexName] ON mytable;</td>
</tr>
<tr>
<td>查看</td>
<td>SHOW INDEX FROM table_name</td>
</tr>
<tr>
<td>使 用 Alter 命令</td>
<td>ALTER TABLE tbl_name ADD PRIMARY KEY (column_list) : 该语句添加一个主键， 这意味着索引值必须是唯一 的， 且不能为 NULL。</td>
</tr>
<tr>
<td></td>
<td>ALTER TABLE tbl_name ADD UNIQUE index_name (column_list)</td>
</tr>
<tr>
<td></td>
<td>ALTER TABLE tbl_name ADD INDEX index_name (column_list): 添加普通索引， 索引值可出现多次。</td>
</tr>
<tr>
<td></td>
<td>ALTER TABLE tbl_name ADD FULLTEXT index_name (column_list):该语句指定了索引为 FULLTEXT ， 用于全文索 引。</td>
</tr>
</tbody></table>
<p><strong>创建索引</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 创建表时添加索引</span><br><span class="line"># 以列级方式</span><br><span class="line">CREATE TABLE customer (</span><br><span class="line">    id INT(10) UNSIGNED AUTO_INCREMENT PRIMARY KEY,</span><br><span class="line">    customer_no VARCHAR(200) UNIQUE,</span><br><span class="line">    customer_name VARCHAR(200),</span><br><span class="line">    customer_age int,</span><br><span class="line">);</span><br><span class="line"># 以表级方式</span><br><span class="line">CREATE TABLE customer (</span><br><span class="line">    id INT(10) UNSIGNED AUTO_INCREMENT ,</span><br><span class="line">    customer_no VARCHAR(200),</span><br><span class="line">    customer_name VARCHAR(200),</span><br><span class="line">    customer_age int,</span><br><span class="line">    # 对于普通索引还是以表级方式建立</span><br><span class="line">    # 普通索引--单值索引</span><br><span class="line">    KEY(customer_name),</span><br><span class="line">    # 普通索引--复合索引</span><br><span class="line">    KEY(customer_name,customer_age),</span><br><span class="line">    # 唯一索引</span><br><span class="line">    UNIQUE (customer_no)</span><br><span class="line">    # 主键索引</span><br><span class="line">    PRIMARY KEY(id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<h3 id="索引结构"><a href="#索引结构" class="headerlink" title="索引结构"></a>索引结构</h3><h4 id="BTree索引"><a href="#BTree索引" class="headerlink" title="BTree索引"></a>BTree索引</h4><p>数据存储在所有节点</p>
<p>MyISAM引擎使用</p>
<img src="https://images2015.cnblogs.com/blog/249993/201705/249993-20170517160113541-995629282.png" alt="img" style="zoom: 50%;" />

<h4 id="B-Tree索引"><a href="#B-Tree索引" class="headerlink" title="B+Tree索引"></a>B+Tree索引</h4><p>真实数据值存储在叶子节点</p>
<p><strong>InnoDB引擎使用</strong></p>
<img src="https://images2015.cnblogs.com/blog/249993/201705/249993-20170518153741385-231278940.png" alt="img" style="zoom: 67%;" />

<p>B+树相比B树的优势</p>
<ol>
<li>磁盘读写代价更低<ul>
<li>非叶子节点不存储数据，只有索引，所以一个盘块中能存储的索引更多，B+树的高度减小，IO次数更少</li>
</ul>
</li>
<li>查询效率更加稳定<ul>
<li>每次查询都要经历等于B+树高度的IO次数，时间一致</li>
</ul>
</li>
</ol>
<h4 id="Hash索引"><a href="#Hash索引" class="headerlink" title="Hash索引"></a>Hash索引</h4><p>键值对方式，Memory和NDB引擎支持，Nosql采用此种索引结构</p>
<h4 id="RTree索引"><a href="#RTree索引" class="headerlink" title="RTree索引"></a>RTree索引</h4><p>相比BTree，RTree优势在于范围查找。</p>
<p>RTree在mysql中很少使用，仅支持geometry数据类型。支持该数据类型的存储引擎有：MyISAM、InnbDB、BDB、NDB、Archive</p>
<h4 id="full-text索引"><a href="#full-text索引" class="headerlink" title="full-text索引"></a>full-text索引</h4><p>全文检索，支持分词技术</p>
<p>这种方式不再使用，目前都是用专门的搜索引擎代替，如ElasticSearch，Solr</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE article (</span><br><span class="line">    id INT(10) UNSIGNED AUTO_INCREMENT ,</span><br><span class="line">    title VARCHAR(200),</span><br><span class="line">    content VARCHAR(200),</span><br><span class="line">   	PRIMARY KEY(id),</span><br><span class="line">   	FULLTEXT KEY()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># 传统方式</span><br><span class="line">select * from article where content like &quot;%要查询的字符串%&quot;</span><br><span class="line"># 全文索引查询方式</span><br><span class="line">select * from article where match(title,content) against (&quot;要查询的字符串&quot;)</span><br></pre></td></tr></table></figure>



<h4 id="聚集索引和非聚集索引"><a href="#聚集索引和非聚集索引" class="headerlink" title="聚集索引和非聚集索引"></a>聚集索引和非聚集索引</h4><p><strong>聚簇索引</strong></p>
<p>聚簇索引中<strong>主键索引与行记录是存储在一起</strong>。因此聚集索引不仅是索引，它也是一种数据存储方式。</p>
<p><strong>特点</strong></p>
<ul>
<li><p>对于聚集索引而言，数据行在<strong>磁盘上的排列方式和在索引上排序一致</strong>。</p>
</li>
<li><p>聚集索引字段可以不唯一</p>
</li>
<li><p>聚集索引，有且只能有一个</p>
</li>
</ul>
<p>InnoDB 的表必须要有聚集索引：</p>
<ul>
<li>如果表定义了 PK，则 PK 就是聚集索引；</li>
<li>如果表没有定义 PK，则第一个非空 unique 列是聚集索引；</li>
<li>否则，InnoDB 会创建一个隐藏的 row-id 作为聚集索引；</li>
</ul>
<p><strong>非聚簇索引</strong></p>
<ul>
<li><p>非聚集索引，也就是普通索引，辅助索引。</p>
<p>如果给表中多个字段加上非聚集索引 ， 那么就会出现多个独立的索引结构，每个索引（非聚集索引）互相之间不存在关联</p>
</li>
</ul>
<p><strong>聚集索引与非聚集索引的区别</strong></p>
<p>==通过聚集索引可以查到需要查找的数据 而通过非聚集索引可以查到记录对应的主键值 ， 再使用主键的值通过聚集索引查找到需要的数据==</p>
<p>通过主键值找真正数据的过程叫做<strong>回表</strong></p>
<img src="MySQL基础.assets/image-20200711122028372.png" alt="image-20200711122028372" style="zoom: 80%;" />

<p><strong>总结</strong></p>
<p>==不管以任何方式查询表， 最终都会利用主键通过聚集索引来定位到数据， 聚集索引（主键）是通往真实数据所在的唯一路径。==</p>
<h5 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h5><p><strong>特殊情况</strong></p>
<p>有一种例外可以不使用聚集索引就能查询出所需要的数据， 这种非主流的方法 称之为「<strong>覆盖索引</strong>」查询， 也就是平时所说的<strong>复合索引</strong>或者<strong>多字段索引</strong>查询。</p>
<p>由于复合索引会将多个字段添加到索引中，那检索一个字段，不仅会得到主键id，还会得到其他字段的值，如果结果就是这些字段，则不需要再使用主键进行检索</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 建立索引</span><br><span class="line">create index index_birthday on user_info(birthday);</span><br><span class="line"># 查询生日在1991年11月1日出生用户的用户名</span><br><span class="line">select user_name from user_info where birthday &#x3D; &#39;1991-11-1&#39;</span><br><span class="line"></span><br><span class="line">首先，通过非聚集索引 index_birthday 查找 birthday 等于1991-11-1的所有记录的主键ID值</span><br><span class="line">然后，通过得到的主键ID值执行聚集索引查找，找到主键ID值对就的真实数据（数据行）存储的位置</span><br><span class="line">最后，从得到的真实数据中取得user_name字段的值返回，也就是取得最终的结果</span><br><span class="line"></span><br><span class="line"># 复合索引</span><br><span class="line">create index index_birthday_and_user_name on user_info(birthday, user_name);</span><br><span class="line">select user_name from user_info where birthday &#x3D; &#39;1991-11-1&#39;</span><br><span class="line">直接通过非聚集索引 index_birthday 查找 birthday 等于1991-11-1的所有记录的user_name字段的值并返回</span><br></pre></td></tr></table></figure>



<h3 id="索引创建条件"><a href="#索引创建条件" class="headerlink" title="索引创建条件"></a>索引创建条件</h3><p><strong>索引适合的情况</strong></p>
<ol>
<li>主键自动建立唯一索引</li>
<li>频繁作为查询条件的字段应该创建索引</li>
<li>查询中与其它表关联的字段，外键自动建立索引</li>
<li>单键/组合索引的选择问题，组合索引性价比更高</li>
<li>查询中排序的字段，排序字段若通过索引去访问将大大提高排序速度<ul>
<li>group by 和order by后面的字段，并且组合索引字段顺序应该和排序字段顺序一致</li>
</ul>
</li>
<li>查询中统计或者分组字段  </li>
</ol>
<p><strong>不需要创建索引的情况</strong></p>
<ol>
<li>表记录很少</li>
<li>经常修改的表</li>
<li>数据重复且分布平均的表字段<ul>
<li>例如：性别、国籍，这些字段重复率很高</li>
<li><strong>索引的选择性</strong>：索引列中不同值的数目/总列数。索引值越接近1，这个索引的效率就越高</li>
</ul>
</li>
</ol>
<h3 id="Explain性能分析"><a href="#Explain性能分析" class="headerlink" title="Explain性能分析"></a>Explain性能分析</h3><p>使用 EXPLAIN 关键字可以模拟优化器执行 SQL 查询语句， 从而知道 MySQL 是如何处理你的 SQL 语句的。 分析你的查询语句或是表结构的性能瓶颈。  </p>
<h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><ul>
<li>表的读取顺序–explain结果字段id</li>
<li>数据读取操作的操作类型–explain结果字段select_type</li>
<li>哪些索引可以使用–explain结果字段possible_keys</li>
<li>哪些索引被实际使用–explain结果字段key</li>
<li>表之间的引用–explain结果字段ref</li>
<li>每张表有多少行被优化器查询</li>
</ul>
<h4 id="Explain使用"><a href="#Explain使用" class="headerlink" title="Explain使用"></a>Explain使用</h4><p><strong>语法</strong></p>
<p>Explain + SQL语句</p>
<p><strong>返回结果</strong></p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200711155821807.png" alt="image-20200711155821807"></p>
<h5 id="字段说明"><a href="#字段说明" class="headerlink" title="字段说明"></a>字段说明</h5><ul>
<li><p><strong>id</strong>：select 查询的序列号，包含一组数字，表示查询中执行 select 子句或操作表的顺序。  </p>
<ul>
<li>id 相同， 执行顺序由上至下 ，t1-&gt;t2-&gt;t3</li>
</ul>
<img src="MySQL基础.assets/image-20200711160310180.png" alt="image-20200711160310180" style="zoom:125%;" />

<ul>
<li><p>id 不同， 如果是子查询， id 的序号会递增， id 值越大优先级越高， 越先被执行，t3-&gt;t2-&gt;t1</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200711160340474.png" alt="image-20200711160340474"></p>
</li>
<li><p>id 如果相同，从上往下顺序执行；id 值越大， 优先级越高， 越先执行,t3-&gt;==derived2（由id为2的查询衍生得到的一张虚表）==-&gt;t2</p>
<img src="MySQL基础.assets/image-20200711160906372.png" alt="image-20200711160906372" style="zoom:120%;" /></li>
</ul>
</li>
<li><p><strong>select_type</strong>：用于区别普通查询、 联合查询、 子查询等的复杂查询  </p>
</li>
</ul>
<table>
<thead>
<tr>
<th>select_type 属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>SIMPLE</td>
<td>简单的 select 查询,查询中不包含子查询或者 UNION，即单表查询</td>
</tr>
<tr>
<td>PRIMARY</td>
<td>查询中若包含任何复杂的子部分， 最外层查询则被标记为 Primary</td>
</tr>
<tr>
<td>DERIVED</td>
<td>在 FROM 列表中包含的子查询被标记为 DERIVED(衍生) MySQL 会递归执行这些子查询, 把结果放在临时表里。</td>
</tr>
<tr>
<td>SUBQUERY</td>
<td>在SELECT或WHERE列表中包含了子查询</td>
</tr>
<tr>
<td>DEPEDENT SUBQUERY</td>
<td>在SELECT或WHERE列表中包含了子查询,子查询基于外层</td>
</tr>
<tr>
<td>UNCACHEABLE SUBQUERY</td>
<td>无法使用缓存的子查询</td>
</tr>
<tr>
<td>UNION</td>
<td>若第二个SELECT出现在UNION之后， 则被标记为UNION； 若UNION包含在FROM子句的子查询中,外层SELECT将被标记为： DERIVED</td>
</tr>
<tr>
<td>UNION RESULT</td>
<td>从UNION表获取结果的SELECT</td>
</tr>
</tbody></table>
<ul>
<li><strong>table</strong>：这个数据是基于哪个表</li>
<li><strong>type</strong>：查询的访问类型<ul>
<li>结果值从最好到最坏依次是：  </li>
<li><strong>system</strong> &gt; <strong>const</strong> &gt; <strong>eq_ref</strong> &gt; <strong>ref</strong> &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; <strong>range</strong> &gt; index &gt; <strong>ALL</strong>  </li>
<li>==一般来说， 得保证查询至少达到 range 级别， 最好能达到 ref。==</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>type</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>system</td>
<td>表只有<strong>一行记录</strong>（等于系统表）， 这是 const 类型的特列， 平时不会出现， 这个也可以忽略不计</td>
</tr>
<tr>
<td>const</td>
<td>通常情况下，如果将一个主键（唯一键）放置到where后面作为条件查询，mysql优化器就能把这次查询优化转化为一个常量<br />select * from department where id = 1;</td>
</tr>
<tr>
<td>eq_ref</td>
<td>主键唯一性索引扫描， 对于每个索引键， 表中<strong>只有一条记录</strong>与之匹配，常出现在<strong>多表连接</strong>中，外表只有一条数据的情况。对于单表，优化器直接转化成const<br />select stu.name,sc.grade from student stu,score sc where stu.sid= sc.id;每个学生只有一条成绩信息</td>
</tr>
<tr>
<td>ref</td>
<td>查找条件列使用了索引而且不为主键和unique，即<strong>索引查询结果不唯一</strong><br />select * from person department where name=’张三’;叫张三的人可能有很多</td>
</tr>
<tr>
<td>range</td>
<td>指的是有范围的<strong>索引扫描</strong>(对于表上的扫描不是range)，相对于index的全索引扫描，它有范围限制，因此要优于index。<br />一般就是where后面条件在key上使用了between，and以及’&gt;’,’&lt;’外，in和or等方式扫描</td>
</tr>
<tr>
<td>index</td>
<td>在<strong>索引上进行全表扫描</strong>，没有在索引进行过滤</td>
</tr>
<tr>
<td>all</td>
<td>直接<strong>进行全表扫描</strong></td>
</tr>
</tbody></table>
<ul>
<li><p><strong>possible_keys</strong>：查询涉及到的字段上若存在索引，则该索引将被列出，<strong>但不一定被查询实际使用</strong>。</p>
</li>
<li><p><strong>key</strong>：实际使用的索引，如果为NULL，则表示没有索引或索引没使用(索引失效)。只会选择一个</p>
<ul>
<li>possible_keys中mysql推测使用的索引和key中实际使用的索引并没有任何关系</li>
<li>这里mysql认为是全表扫描，并没有使用key，但是实际上使用了主键索引</li>
</ul>
</li>
</ul>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200711180610660.png" alt="image-20200711180610660"></p>
<ul>
<li><p><strong>key_len</strong>：where后面的筛选字段命中复合索引的长度。<strong>长度越长，索引利用率越大，效率越高</strong>。可以用来检查是否充分利用索引</p>
<ul>
<li><p>对于复合索引(deptno,ename)，下面分别为全命中和部分命中的情况</p>
</li>
<li><p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200711234355239.png" alt="image-20200711234355239"></p>
</li>
<li><p>计算长度</p>
</li>
<li><p>类型长度int=4B，varchar(20)=20，varchar和char字符串类型，长度需要考虑具体字符集，utf8 要乘3，GBK要乘2，varchar作为动态字符串类型还需要额外添加2B，允许为空的类型需要额外加上1B</p>
</li>
<li><p>所以5=4+1，67=(20*3+2)+5</p>
</li>
</ul>
</li>
<li><p><strong>ref</strong>：查询时索引匹配的字段或者常量。当在索引列上进行<strong>等值匹配</strong>时，也就是type字段是const、eq_ref、ref、ref_or_null、unique_subquery、index-subquery其中之一时，ref列展示的是与索引列作等值匹配的<strong>条件</strong>，如常数或者某个字段</p>
<ul>
<li>根据sql语句，在emp表上与ename索引列做等值匹配的是”AvDEjl”，即一个常量，所以ref为const</li>
<li>在dept表上与deptno索引列做等值匹配的是emp.’deptno’，即emp中的一个字段，所以ref为mytest.emp.deptno，即数据库名.表名.字段名</li>
<li><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200712000621185.png" alt="image-20200712000621185"></li>
</ul>
</li>
<li><p><strong>rows</strong>：rows 列显示 MySQL 认为它执行查询时必须检查的行数。 越少越好！  </p>
</li>
<li><p><strong>Extra</strong></p>
</li>
</ul>
<table>
<thead>
<tr>
<th>Extra</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>Using filesort</td>
<td><strong>排序时，MySQL 中无法利用索引或字段上没有索引</strong>，会对数据使用一个外部的索引排序。 这种不是基于已建立索引的外部索引排序操作称为“文件排序”。<strong>需要优化</strong></td>
</tr>
<tr>
<td>Using temporary</td>
<td>MySQL 在对查询结果<strong>排序</strong>时使用<strong>临时表</strong>。<strong>需要优化</strong></td>
</tr>
<tr>
<td>Using index</td>
<td>表示相应的 select 操作中使用了<strong>覆盖索引</strong>(Covering Index)， 避免访问了表的数据行，即<strong>查询的数据都在辅助索引中，没有再根据主键id查找实际数据</strong><br/>如果同时出现 using where， 表明索引被用来执行索引键值的查找;<br />如果没有同时出现 using where， 表明索引只是用来读取数据而非利用索引执行查找。</td>
</tr>
<tr>
<td>Using where</td>
<td>表明使用了 where 过滤</td>
</tr>
<tr>
<td>Using join buffer</td>
<td>多表连接时使用了连接缓存</td>
</tr>
<tr>
<td>impossible where</td>
<td>where 子句的值总是 false， 不能用来获取任何元组。</td>
</tr>
<tr>
<td>select tables optimized away</td>
<td>在没有 GROUPBY 子句的情况下，对一些多行函数进行优化</td>
</tr>
<tr>
<td>distinct</td>
<td>优化distinct操作，找到第一个匹配的元组就停止</td>
</tr>
</tbody></table>
<h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select d1.name,(select id from t3) d2</span><br><span class="line">from (select id,name from t1 where other_column&#x3D;&#39;&#39;) d1</span><br><span class="line">union</span><br><span class="line">(select name,id from t2)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>PRIMARY</td>
<td>derived 3</td>
<td>system<br />临时表只有一行数据</td>
<td>NULL</td>
<td>NULL<br />临时表上没有索引</td>
<td>NULL</td>
<td>NULL</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>DERIVED</td>
<td>t1</td>
<td>ALL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL<br />没有索引匹配</td>
<td>1</td>
<td>Using where</td>
</tr>
<tr>
<td>2</td>
<td>SUBQUERY</td>
<td>t3</td>
<td>index</td>
<td>NULL</td>
<td>PRIMARY</td>
<td>4（id为主键）</td>
<td>NULL</td>
<td>1</td>
<td>Using index</td>
</tr>
<tr>
<td>4</td>
<td>UNION</td>
<td>t2</td>
<td>ALL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>NULL</td>
<td>UNION RESULT</td>
<td>&lt;union1,4&gt;<br />操作1和4的结果</td>
<td>ALL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td></td>
</tr>
</tbody></table>
<h3 id="索引失效原因及解决"><a href="#索引失效原因及解决" class="headerlink" title="索引失效原因及解决"></a>索引失效原因及解决</h3><p>建表sql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE staffs (</span><br><span class="line">  id INT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">  NAME VARCHAR (24)  NULL DEFAULT &#39;&#39; COMMENT &#39;姓名&#39;,</span><br><span class="line">  age INT NOT NULL DEFAULT 0 COMMENT &#39;年龄&#39;,</span><br><span class="line">  pos VARCHAR (20) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;职位&#39;,</span><br><span class="line">  add_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;入职时间&#39;</span><br><span class="line">) CHARSET utf8 COMMENT &#39;员工记录表&#39; ;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">INSERT INTO staffs(NAME,age,pos,add_time) VALUES(&#39;z3&#39;,22,&#39;manager&#39;,NOW());</span><br><span class="line">INSERT INTO staffs(NAME,age,pos,add_time) VALUES(&#39;July&#39;,23,&#39;dev&#39;,NOW());</span><br><span class="line">INSERT INTO staffs(NAME,age,pos,add_time) VALUES(&#39;2000&#39;,23,&#39;dev&#39;,NOW());</span><br><span class="line">INSERT INTO staffs(NAME,age,pos,add_time) VALUES(null,23,&#39;dev&#39;,NOW());</span><br><span class="line">SELECT * FROM staffs;</span><br><span class="line"> </span><br><span class="line">ALTER TABLE staffs ADD INDEX idx_staffs_nameAgePos(name, age, pos);</span><br></pre></td></tr></table></figure>



<h4 id="全值匹配"><a href="#全值匹配" class="headerlink" title="全值匹配"></a>全值匹配</h4><p>按照复合索引顺序进行匹配</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713112111054.png" alt="image-20200713112111054"></p>
<p>删除第一个条件</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713112217844.png" alt="image-20200713112217844"></p>
<p>原因：使用复合索引，查询字段与索引字段顺序的不同会导致， 索引无法充分使用， 甚至索引失效。</p>
<p>==解决：应遵从最左前缀原则==</p>
<p>==注意:mysql5.5.62实测，where后面条件是不需要满足最左前缀==</p>
<h5 id="最左前缀原则"><a href="#最左前缀原则" class="headerlink" title="最左前缀原则"></a>最左前缀原则</h5><p>查询时，过滤条件应该<strong>从索引的最左前列开始</strong>并且<strong>不跳过索引中的列</strong>。  </p>
<h4 id="在索引列上操作"><a href="#在索引列上操作" class="headerlink" title="在索引列上操作"></a>在索引列上操作</h4><p>在索引列上进行操作后，索引列会失效</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713113310184.png" alt="image-20200713113310184"></p>
<p>==解决：解决不了，尽量少使用吧==</p>
<h4 id="在复合索引上进行范围查找"><a href="#在复合索引上进行范围查找" class="headerlink" title="在复合索引上进行范围查找"></a>在复合索引上进行范围查找</h4><p>若有索引则能使用到索引，范围条件右边的索引(复合索引)会失效</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713115753385.png" alt="image-20200713115753385"></p>
<p>==解决：避免将要进行范围查找的索引列添加到复合索引中，或者将其放在复合索引的最后一项中==</p>
<p><strong>范围查找导致索引失效的原因</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">举例</span><br><span class="line">下面是按照三个字段（id,comments,type）建立的索引排序</span><br><span class="line">1 1 1</span><br><span class="line">1 2 2</span><br><span class="line">2 1 3</span><br><span class="line">2 1 4</span><br><span class="line">2 2 1</span><br><span class="line">2 2 4</span><br><span class="line">2 3 0</span><br><span class="line">2 4 1</span><br><span class="line">先查找id&#x3D;2的，得到</span><br><span class="line">2 1 3</span><br><span class="line">2 1 4</span><br><span class="line">2 2 1</span><br><span class="line">2 2 4</span><br><span class="line">2 3 0</span><br><span class="line">2 4 1</span><br><span class="line">在查找comments&gt;1的，得到</span><br><span class="line">2 2 1</span><br><span class="line">2 2 4</span><br><span class="line">2 3 0</span><br><span class="line">2 4 1</span><br><span class="line">此时第三个索引项中数据是无序的</span><br></pre></td></tr></table></figure>

<p><strong>结论</strong></p>
<p>对于复合索引而言，后一项索引有效的基础是前一项索引值唯一</p>
<h4 id="使用不等于进行过滤"><a href="#使用不等于进行过滤" class="headerlink" title="使用不等于进行过滤"></a>使用不等于进行过滤</h4><p>使用 != 和 &lt;&gt; 的字段索引失效（!= 针对数值类型。 &lt;&gt; 针对字符类型）</p>
<p>原因：对于索引而言，就是一些有序的数据结构，而<strong>不等于就是排除了指定条件的范围查找</strong>，上面说明了范围查找导致索引失效的原因。</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713121235428.png" alt="image-20200713121235428"></p>
<p>==解决：解决不了，尽量少使用吧==</p>
<h4 id="不为空判断"><a href="#不为空判断" class="headerlink" title="不为空判断"></a>不为空判断</h4><p>is not null无法使用索引，is null可以使用索引</p>
<p>is not null也相当于使用了不等于</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713121959283.png" alt="image-20200713121959283"></p>
<p>==解决：解决不了，尽量少使用吧==</p>
<h4 id="通配符匹配以-开头"><a href="#通配符匹配以-开头" class="headerlink" title="通配符匹配以%开头"></a>通配符匹配以%开头</h4><p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713123647170.png" alt="image-20200713123647170"></p>
<p>可以看出，如果%在正则表达式最前面，会导致索引失效。</p>
<p>==解决：==</p>
<ol>
<li>==使用reverse反转函数，将索引中字段反转，然后查询时也使用reverse将条件反转，这样就可以将’%s’变成’s%’==</li>
<li>==使用覆盖索引。将条件中的字段和要查询的字段联合，建立复合索引==</li>
</ol>
<h4 id="数据隐形转换"><a href="#数据隐形转换" class="headerlink" title="数据隐形转换"></a>数据隐形转换</h4><p>存在索引列的数据类型隐形转换，则用不上索引。比如列类型是字符串，那一定要在条件中将数据使用引号引用起来,否则不使用索引</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713132540818.png" alt="image-20200713132540818"></p>
<h4 id="条件中有or"><a href="#条件中有or" class="headerlink" title="条件中有or"></a>条件中有or</h4><p>使用or连接时，如果其中一个字段没有索引，则不会使用索引</p>
<p>==解决：要想使用or，又想让索引生效，只能将or条件中的每个列都加上索引==</p>
<h3 id="案例-1"><a href="#案例-1" class="headerlink" title="案例"></a>案例</h3><p><strong>案例1</strong></p>
<p>假设 index(a,b,c)；  </p>
<table>
<thead>
<tr>
<th>Where 语句</th>
<th>索引是否被使用</th>
</tr>
</thead>
<tbody><tr>
<td>where a = 3</td>
<td>Y,使用到 a</td>
</tr>
<tr>
<td>where a = 3 and b = 5</td>
<td>Y,使用到 a， b</td>
</tr>
<tr>
<td>where a = 3 and b = 5 and c = 4</td>
<td>Y,使用到 a,b,c</td>
</tr>
<tr>
<td>where b = 3 或者 where b = 3 and c = 4 或者 where c = 4</td>
<td>N，不符合最左原则。</td>
</tr>
<tr>
<td>where a = 3 and c = 5</td>
<td>使用到 a， 但是 c 不可以， b 中间断了(mysql5.5.62是可以的)</td>
</tr>
<tr>
<td>where a = 3 and b &gt; 4 and c = 5</td>
<td>使用到 a 和 b， c 不能用在范围之后， b 断了</td>
</tr>
<tr>
<td>where a is null and b is not null</td>
<td>is null 支持索引 但是 is not null 不支持,所 以 a 可以使用索引,但是 b 不可以使用</td>
</tr>
<tr>
<td>where a &lt;&gt; 3</td>
<td>不能使用索引</td>
</tr>
<tr>
<td>where abs(a) =3</td>
<td>在索引列上操作，不能使用 索引</td>
</tr>
<tr>
<td>where a = 3 and b like ‘kk%’ and c = 4</td>
<td>Y,使用到 a,b,c</td>
</tr>
<tr>
<td>where a = 3 and b like ‘%kk’ and c = 4</td>
<td>Y,只用到 a</td>
</tr>
<tr>
<td>where a = 3 and b like ‘%kk%’ and c = 4</td>
<td>Y,只用到 a</td>
</tr>
<tr>
<td>where a = 3 and b like ‘k%kk%’ and c = 4</td>
<td>Y,使用到 a,b,c</td>
</tr>
</tbody></table>
<p><strong>案例2</strong></p>
<p>建表sql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">create table test03(</span><br><span class="line"> id int primary key not null auto_increment,</span><br><span class="line"> c1 char(10),</span><br><span class="line"> c2 char(10),</span><br><span class="line"> c3 char(10),</span><br><span class="line"> c4 char(10),</span><br><span class="line"> c5 char(10)</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">insert into test03(c1,c2,c3,c4,c5) values(&#39;a1&#39;,&#39;a2&#39;,&#39;a3&#39;,&#39;a4&#39;,&#39;a5&#39;);</span><br><span class="line">insert into test03(c1,c2,c3,c4,c5) values(&#39;b1&#39;,&#39;b2&#39;,&#39;b3&#39;,&#39;b4&#39;,&#39;b5&#39;);</span><br><span class="line">insert into test03(c1,c2,c3,c4,c5) values(&#39;c1&#39;,&#39;c2&#39;,&#39;c3&#39;,&#39;c4&#39;,&#39;c5&#39;);</span><br><span class="line">insert into test03(c1,c2,c3,c4,c5) values(&#39;d1&#39;,&#39;d2&#39;,&#39;d3&#39;,&#39;d4&#39;,&#39;d5&#39;);</span><br><span class="line">insert into test03(c1,c2,c3,c4,c5) values(&#39;e1&#39;,&#39;e2&#39;,&#39;e3&#39;,&#39;e4&#39;,&#39;e5&#39;);</span><br></pre></td></tr></table></figure>

<p>建索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create index idx_test03_c1234 on test03(c1,c2,c3,c4);</span><br><span class="line">show index from test03;</span><br></pre></td></tr></table></figure>



<p>查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">1）explain select * from test03 where c1&#x3D;&#39;a1&#39; and c2&#x3D;&#39;a2&#39; and c3&#x3D;&#39;a3&#39; and c4&#x3D;&#39;a4&#39;; </span><br><span class="line">使用复合索引全部字段</span><br><span class="line">2）explain select * from test03 where c1&#x3D;&#39;a1&#39; and c2&#x3D;&#39;a2&#39; and c4&#x3D;&#39;a4&#39; and c3&#x3D;&#39;a3&#39;; </span><br><span class="line">使用符合索引全部字段，mysql会根据复合索引顺序进行优化</span><br><span class="line">3）explain select * from test03 where c1&#x3D;&#39;a1&#39; and c2&#x3D;&#39;a2&#39; and c3&gt;&#39;a3&#39; and c4&#x3D;&#39;a4&#39;;</span><br><span class="line">使用复合索引前三个字段</span><br><span class="line">4）explain select * from test03 where c1&#x3D;&#39;a1&#39; and c2&#x3D;&#39;a2&#39; and c4&gt;&#39;a4&#39; and c3&#x3D;&#39;a3&#39;;</span><br><span class="line">使用复合索引全部字段，Mysql优化顺序select * from test03 where c1&#x3D;&#39;a1&#39; and c2&#x3D;&#39;a2&#39; and c3&#x3D;&#39;a3&#39; and c4&gt;&#39;a4&#39;;</span><br><span class="line">5）explain select * from test03 where c1&#x3D;&#39;a1&#39; and c2&#x3D;&#39;a2&#39; and c4&#x3D;&#39;a4&#39; order by c3;</span><br><span class="line">使用c1,c2,c3字段索引</span><br><span class="line">6） explain select * from test03 where c1&#x3D;&#39;a1&#39; and c2&#x3D;&#39;a2&#39; order by c3;</span><br><span class="line">使用c1,c2字段索引，但是c3用于排序,无filesort</span><br><span class="line">7） explain select * from test03 where c1&#x3D;&#39;a1&#39; and c2&#x3D;&#39;a2&#39; order by c4;</span><br><span class="line">出现了filesort</span><br><span class="line">8） </span><br><span class="line">8.1 explain select * from test03 where c1&#x3D;&#39;a1&#39; and c5&#x3D;&#39;a5&#39; order by c2,c3; </span><br><span class="line"> 只用c1一个字段索引，但是c2、c3用于排序,无filesort</span><br><span class="line">8.2 explain select * from test03 where c1&#x3D;&#39;a1&#39; and c5&#x3D;&#39;a5&#39; order by c3,c2;</span><br><span class="line"> 只用c1一个字段索引，出现了filesort，我们建的索引是1234，它没有按照顺序来，3 2 颠倒了</span><br><span class="line">9） explain select * from test03 where c1&#x3D;&#39;a1&#39; and c2&#x3D;&#39;a2&#39; order by c2,c3;</span><br><span class="line"> 使用c1,c2字段索引，但是c2、c3用于排序,无filesort</span><br><span class="line">10）</span><br><span class="line"> explain select * from test03 where c1&#x3D;&#39;a1&#39; and c2&#x3D;&#39;a2&#39; and c5&#x3D;&#39;a5&#39; order by c2,c3;       </span><br><span class="line"> 用c1、c2两个字段索引，但是c2、c3用于排序,无filesort。c2已经在where部分匹配固定值，order by后再根据c2排序，其实是没用的，忽略</span><br><span class="line"> explain select * from test03 where c1&#x3D;&#39;a1&#39; and c2&#x3D;&#39;a2&#39; and c5&#x3D;&#39;a5&#39; order by c3,c2;             </span><br><span class="line"> 用c1、c2两个字段索引，但是c2、c3用于排序,无filesort。c2已经在where部分匹配固定值，order by后再根据c2排序，其实是没用的，忽略</span><br><span class="line"> explain select * from test03 where c1&#x3D;&#39;a1&#39; and c5&#x3D;&#39;a5&#39; order by c3,c2;</span><br><span class="line"> filesort。这里只有c1字段索引，order by 部分和索引顺序不匹配</span><br><span class="line">11）explain select * from test03 where c1&#x3D;&#39;a1&#39; and c4&#x3D;&#39;a4&#39; group by c2,c3;</span><br><span class="line"> 用c1索引，但是c2、c3用于排序,</span><br><span class="line">12）explain select * from test03 where c1&#x3D;&#39;a1&#39; and c4&#x3D;&#39;a4&#39; group by c3,c2;</span><br><span class="line"> 用c1索引，有Use temporary,filesort</span><br><span class="line"> Using where; Using temporary; Using filesort </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h2><h3 id="使用覆盖索引"><a href="#使用覆盖索引" class="headerlink" title="使用覆盖索引"></a>使用覆盖索引</h3><p>查询时应该避免使用select *</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713120608468.png" alt="image-20200713120608468"></p>
<p>可以看出，第二条查询Extra字段多了Using index，即覆盖索引</p>
<h3 id="单表查询优化"><a href="#单表查询优化" class="headerlink" title="单表查询优化"></a>单表查询优化</h3><p><strong>建表sql</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE IF NOT EXISTS &#96;article&#96; (</span><br><span class="line">&#96;id&#96; INT(10) UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">&#96;author_id&#96; INT(10) UNSIGNED NOT NULL,</span><br><span class="line">&#96;category_id&#96; INT(10) UNSIGNED NOT NULL,</span><br><span class="line">&#96;views&#96; INT(10) UNSIGNED NOT NULL,</span><br><span class="line">&#96;comments&#96; INT(10) UNSIGNED NOT NULL,</span><br><span class="line">&#96;title&#96; VARBINARY(255) NOT NULL,</span><br><span class="line">&#96;content&#96; TEXT NOT NULL</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">INSERT INTO &#96;article&#96;(&#96;author_id&#96;, &#96;category_id&#96;, &#96;views&#96;, &#96;comments&#96;, &#96;title&#96;, &#96;content&#96;) VALUES</span><br><span class="line">(1, 1, 1, 1, &#39;1&#39;, &#39;1&#39;),</span><br><span class="line">(2, 2, 2, 2, &#39;2&#39;, &#39;2&#39;),</span><br><span class="line">(1, 1, 3, 3, &#39;3&#39;, &#39;3&#39;);</span><br><span class="line"> </span><br><span class="line">SELECT * FROM article;</span><br></pre></td></tr></table></figure>

<p><strong>查询</strong></p>
<p><code>EXPLAIN SELECT id,author_id FROM article WHERE category_id = 1 AND comments &gt; 1 ORDER BY views DESC LIMIT 1;</code></p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200712222235244.png" alt="image-20200712222235244"></p>
<p>type=ALL，Extra中Using filesort都需要优化</p>
<p><strong>第一步：建立索引</strong></p>
<p>建立三个字段复合索引<code>create index idx_article_ccv on article(category_id,comments,views);</code></p>
<p>此时查询分析</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200712222156186.png" alt="image-20200712222156186"></p>
<p>可以发现虽然使用了复合索引，但是type是range，且Extra中还有Using filesort</p>
<p>==原因：范围查找会导致索引失效。后面的索引只能建立在前面索引列的<strong>单条数据</strong>基础上==</p>
<p><strong>第二步：修改索引</strong></p>
<p>只建立两个字段的复合索引<code>create index idx_article_cv on article(category_id,views);</code>，舍弃了范围查找对应的索引</p>
<p>此时查询分析</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200712230254020.png" alt="image-20200712230254020"></p>
<p>可以看出type已经是ref，且Extra中filesort消失</p>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><p>不要在要进行范围查询的字段上建立复合索引，不然会导致后面的索引字段失效</p>
<h3 id="多表查询优化"><a href="#多表查询优化" class="headerlink" title="多表查询优化"></a>多表查询优化</h3><p>建表sql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE IF NOT EXISTS &#96;class&#96; (</span><br><span class="line">&#96;id&#96; INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,</span><br><span class="line">&#96;card&#96; INT(10) UNSIGNED NOT NULL,</span><br><span class="line">PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">);</span><br><span class="line">CREATE TABLE IF NOT EXISTS &#96;book&#96; (</span><br><span class="line">&#96;bookid&#96; INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,</span><br><span class="line">&#96;card&#96; INT(10) UNSIGNED NOT NULL,</span><br><span class="line">PRIMARY KEY (&#96;bookid&#96;)</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">INSERT INTO class(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO class(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line"> </span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br></pre></td></tr></table></figure>

<p><strong>查询</strong></p>
<p><code>EXPLAIN SELECT * FROM class LEFT JOIN book ON class.card = book.card;</code><br><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713101850899.png" alt="image-20200713101850899"></p>
<p>两个查询type都是ALL</p>
<p><strong>第一步：尝试给右表建索引</strong></p>
<p><code>alter table book add index idx_card(card)</code></p>
<p>此时查询分析</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713104521260.png" alt="image-20200713104521260"></p>
<p>可以看到在book上使用到了索引，总共查询行数21行</p>
<p><strong>第二步：尝试给左表建索引</strong></p>
<p>删除右表索引，然后在左表上建立索引 <code>drop index idx_card on book </code> <code>create index on class(card)</code></p>
<p>此时查询分析</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200713104937740.png" alt="image-20200713104937740"></p>
<p>可以看到class表上查询type是index，也就是对索引进行全局扫描，总共查询行数和未加索引之前一样，40行</p>
<p>==原因：左连接会对左表进行全局扫描，所以不管有没有索引，都会遍历。==</p>
<h4 id="方法-1"><a href="#方法-1" class="headerlink" title="方法"></a>方法</h4><ul>
<li><p>多表查询时，在从表建立索引</p>
</li>
<li><p>主表为小表，从表尾大表。小表驱动大表</p>
<ul>
<li>```kotlin<br>for(i in 0…1000){<pre><code>主表
for(i in 0...5)&#123;
    从表
&#125;
</code></pre>
}<br>//————<br>for(i in 0…5){<pre><code>主表
for(i in 0...1000)&#123;
    从表
&#125;
</code></pre>
}<br>//上面两种方式虽然执行次数都是5000次，但是对于mysql而言，二者效率是不一样的<br>外层循环其实就相当于连接join操作，内存循环就是遍历操作<br>而连接操作往往都是十分耗时的，所以这就是小表驱动大表的原因<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">- 优先优化内层循环，即子查询这些</span><br><span class="line"></span><br><span class="line">- 多表查询时，可以设置较大的JoinBuffer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### Order By优化</span><br><span class="line"></span><br><span class="line">建表</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;mysql</span><br><span class="line">CREATE TABLE tblA(</span><br><span class="line">  id int primary key not null auto_increment,</span><br><span class="line">  age INT,</span><br><span class="line">  birth TIMESTAMP NOT NULL,</span><br><span class="line">  name varchar(200)</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">INSERT INTO tblA(age,birth,name) VALUES(22,NOW(),&#39;abc&#39;);</span><br><span class="line">INSERT INTO tblA(age,birth,name) VALUES(23,NOW(),&#39;bcd&#39;);</span><br><span class="line">INSERT INTO tblA(age,birth,name) VALUES(24,NOW(),&#39;def&#39;);</span><br><span class="line"> </span><br><span class="line">CREATE INDEX idx_A_ageBirth ON tblA(age,birth,name);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>查询</p>
<img src="MySQL基础.assets/image-20200714003335546.png" alt="image-20200714003335546" style="zoom: 80%;" />

<img src="MySQL基础.assets/image-20200714011629886.png" alt="image-20200714011629886" style="zoom: 80%;" />

<p>说明：</p>
<ol>
<li><p><strong>MySQL在查询时最多只能使用一个索引。因此，如果WHERE条件已经占用了索引，那么在排序中就不使用索引了。</strong></p>
<p>上面查询中 <code>where age &gt; 20</code> 已经使用了索引 <code>idx_A_ageBirth</code></p>
</li>
<li><p><strong>Where和Order by子句组合满足最佳左前缀原则</strong></p>
<p>如果左边在某一列上使用范围查询，则order by就要从该列开始；</p>
<p>如果左边在某一列上使用精确查询，则order by就要从下一列开始；</p>
</li>
<li><p>Order by子句<strong>所有列的排序方向（升序或者降序）应该一样</strong></p>
</li>
</ol>
<p><strong>如果order by后面列不在索引列中，使用filesort时有两种排序方式</strong></p>
<ul>
<li>双路排序<ul>
<li>Mysql4.1之前仅支持双路排序，两次IO操作</li>
<li>过程：从表中读取行指针和ORDER BY列，对他们进行排序，一次IO；然后根据排好序的ORDER BY列，从表中读取所需要的字段，返回，一次IO。</li>
</ul>
</li>
<li>单路排序<ul>
<li>MySQL4.1之后，主要通过比较我们所设定的系统参数 max_length_for_sort_data的大小和Query 语句所取出的字段类型大小总和来判定需要使用哪一种排序算法。如果 max_length_for_sort_data更大，则使用第二种优化后的算法，反之使用第一种算法。</li>
<li>过程：一次性取出满足条件行的所有字段，然后在sort buffer中进行排序，直接返回，一次IO。</li>
</ul>
</li>
</ul>
<h3 id="Group-BY优化"><a href="#Group-BY优化" class="headerlink" title="Group BY优化"></a>Group BY优化</h3><ul>
<li>Group By实质是先排序后分组，分组部分没有太大影响，重要的还是排序。所以其实Group By优化和Order By优化类似</li>
<li>对于能放在where后面的条件，就不要放在having后面。</li>
</ul>
<h3 id="limit优化"><a href="#limit优化" class="headerlink" title="limit优化"></a>limit优化</h3><h2 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h2><h3 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h3><p>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句，具体指运行时间超过(大于)<strong>long_query_time</strong>值的SQL，则会被记录到慢查询日志中。long_query_time的默认值为10s</p>
<h4 id="开启慢查询日志"><a href="#开启慢查询日志" class="headerlink" title="开启慢查询日志"></a>开启慢查询日志</h4><p>默认情况下，MySQL数据库没有开启慢查询日志，需要我们手动来设置这个参数。</p>
<p>注意：如果不是调优需要的话，一般不建议启动该参数，因为开启慢查询日志会或多或少带来一定的性能影响。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 查看慢查询日志配置信息</span><br><span class="line">SHOW VARIABLES LIKE &#39;%slow_query_log%&#39;;</span><br><span class="line"># 修改全局变量，重启后失效</span><br><span class="line">set global slow_query_log&#x3D;1</span><br><span class="line"># 永久生效：linux下修改my.cnf，windows下修改my.ini</span><br><span class="line"># 在[mysqld]下增加或修改参数</span><br><span class="line">slow_query_log &#x3D;1</span><br><span class="line"># 如果没有指定参数slow_query_log_file的话，系统默认会给一个缺省的文件host_name-slow.log</span><br><span class="line">slow_query_log_file&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;atguigu-slow.log</span><br><span class="line"></span><br><span class="line"># 查看阈值时间</span><br><span class="line">SHOW VARIABLES LIKE &#39;long_query_time%&#39;;</span><br><span class="line"># 修改阈值</span><br><span class="line">set global long_query_time&#x3D;5</span><br><span class="line"># 或在配置文件中添加</span><br><span class="line">long_query_time&#x3D;5</span><br></pre></td></tr></table></figure>

<p>模拟查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select sleep(4);</span><br></pre></td></tr></table></figure>

<p>然后打开日志文件，就可以看到记录</p>
<p>直接查询慢日志条数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show global status like &#39;%Slow_queries%&#39;;</span><br></pre></td></tr></table></figure>



<h4 id="慢日志分析工具"><a href="#慢日志分析工具" class="headerlink" title="慢日志分析工具"></a>慢日志分析工具</h4><p>mysql提供慢日志分析工具mysqldumpslow</p>
<img src="MySQL基础.assets/image-20200714093801832.png" alt="image-20200714093801832" style="zoom:80%;" />

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">常用命令</span><br><span class="line">得到返回记录集最多的10个SQL</span><br><span class="line">mysqldumpslow -s r -t 10 &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;atguigu-slow.log</span><br><span class="line"> </span><br><span class="line">得到访问次数最多的10个SQL</span><br><span class="line">mysqldumpslow -s c -t 10 &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;atguigu-slow.log</span><br><span class="line"> </span><br><span class="line">得到按照时间排序的前10条里面含有左连接的查询语句</span><br><span class="line">mysqldumpslow -s t -t 10 -g &quot;left join&quot; &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;atguigu-slow.log</span><br><span class="line"> </span><br><span class="line">另外建议在使用这些命令时结合 | 和more 使用 ，否则有可能出现爆屏情况</span><br><span class="line">mysqldumpslow -s r -t 10 &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;atguigu-slow.log | more</span><br></pre></td></tr></table></figure>



<h3 id="批量数据脚本"><a href="#批量数据脚本" class="headerlink" title="批量数据脚本"></a>批量数据脚本</h3><p>使用存储过程实现</p>
<p><strong>建表</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 新建库</span><br><span class="line">create database bigData;</span><br><span class="line">use bigData;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#1 建表dept</span><br><span class="line">CREATE TABLE dept(  </span><br><span class="line">id INT UNSIGNED PRIMARY KEY AUTO_INCREMENT,  </span><br><span class="line">deptno MEDIUMINT UNSIGNED NOT NULL DEFAULT 0,   </span><br><span class="line">dname VARCHAR(20) NOT NULL DEFAULT &quot;&quot;,  </span><br><span class="line">loc VARCHAR(13) NOT NULL DEFAULT &quot;&quot;  </span><br><span class="line">) ENGINE&#x3D;INNODB DEFAULT CHARSET&#x3D;UTF8 ;  </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#2 建表emp</span><br><span class="line">CREATE TABLE emp  </span><br><span class="line">(  </span><br><span class="line">id INT UNSIGNED PRIMARY KEY AUTO_INCREMENT,  </span><br><span class="line">empno MEDIUMINT UNSIGNED NOT NULL DEFAULT 0, &#x2F;*编号*&#x2F;  </span><br><span class="line">ename VARCHAR(20) NOT NULL DEFAULT &quot;&quot;, &#x2F;*名字*&#x2F;  </span><br><span class="line">job VARCHAR(9) NOT NULL DEFAULT &quot;&quot;,&#x2F;*工作*&#x2F;  </span><br><span class="line">mgr MEDIUMINT UNSIGNED NOT NULL DEFAULT 0,&#x2F;*上级编号*&#x2F;  </span><br><span class="line">hiredate DATE NOT NULL,&#x2F;*入职时间*&#x2F;  </span><br><span class="line">sal DECIMAL(7,2) NOT NULL,&#x2F;*薪水*&#x2F;  </span><br><span class="line">comm DECIMAL(7,2) NOT NULL,&#x2F;*红利*&#x2F;  </span><br><span class="line">deptno MEDIUMINT UNSIGNED NOT NULL DEFAULT 0 &#x2F;*部门编号*&#x2F;  </span><br><span class="line">)ENGINE&#x3D;INNODB DEFAULT CHARSET&#x3D;UTF8 ; </span><br></pre></td></tr></table></figure>



<p><strong>创建函数</strong></p>
<p>可能会报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">“ERROR 1418 (HY000): This function has none of DETERMINISTIC, NO SQL, or READS SQL DATA in its declaration and binary logging is enabled (you *might* want to use the less safe log_bin_trust_function_creators variable)”</span><br></pre></td></tr></table></figure>

<p>这是由于启动了二进制日志，mysql会根据log_bin_trust_function_creators变量来表示是否可以信任存储函数创建者，不会创建写入二进制日志引起不安全事件的存储函数。默认值为0，用户不得创建或修改存储函数。因此，需要修改该变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global log_bin_trust_function_creators&#x3D;1;</span><br></pre></td></tr></table></figure>

<p>创建函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"># 生成指定长度的随机字符串，用于ename</span><br><span class="line">CREATE FUNCTION rand_string(n INT) RETURNS VARCHAR(255)</span><br><span class="line">BEGIN    ##方法开始</span><br><span class="line"> DECLARE chars_str VARCHAR(100) DEFAULT &#39;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#39;; </span><br><span class="line"> ##声明一个 字符串长度为 100 的变量 chars_str ,默认值 </span><br><span class="line"> DECLARE return_str VARCHAR(255) DEFAULT &#39;&#39;;</span><br><span class="line"> DECLARE i INT DEFAULT 0;</span><br><span class="line"> ##循环开始</span><br><span class="line"> WHILE i &lt; n DO</span><br><span class="line">  ##concat 连接函数  ，substring(a,index,length) 从index处开始截取</span><br><span class="line">  # mysql字符串索引从1开始</span><br><span class="line">  SET return_str &#x3D;CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52),1));</span><br><span class="line">  SET i &#x3D; i + 1;</span><br><span class="line"> END WHILE;</span><br><span class="line"> RETURN return_str;</span><br><span class="line">END $$</span><br><span class="line"></span><br><span class="line"># 生成随机101-110的数字，用于部门标号</span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE FUNCTION rand_num() RETURNS INT(5)  </span><br><span class="line">BEGIN   </span><br><span class="line"> DECLARE i INT DEFAULT 0;  </span><br><span class="line"> SET i &#x3D; FLOOR(101+RAND()*10);</span><br><span class="line"> RETURN i;  </span><br><span class="line">END $$</span><br></pre></td></tr></table></figure>

<p>创建存储过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 从empno&#x3D;START开始，向emp表插入max_num条数据</span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE PROCEDURE insert_emp(IN START INT(10),IN max_num INT(10))  </span><br><span class="line">BEGIN  </span><br><span class="line"> DECLARE i INT DEFAULT 0;   </span><br><span class="line"> #把当前会话的autocommit设置成0  ；提高执行效率</span><br><span class="line"> SET autocommit &#x3D; 0;    </span><br><span class="line"> REPEAT  ##重复</span><br><span class="line">  # 存储过程中可以直接使用函数</span><br><span class="line">  INSERT INTO emp10000 (empno, ename ,job ,mgr ,hiredate ,sal ,comm ,deptno ) VALUES ((START+i)     ,rand_string(6),&#39;SALESMAN&#39;,0001,CURDATE(),FLOOR(1+RAND()*20000),FLOOR(1+RAND()*1000),rand_num());</span><br><span class="line">  SET i &#x3D; i + 1;</span><br><span class="line"> UNTIL i &#x3D; max_num   ##循环max_num次</span><br><span class="line"> END REPEAT;  ##满足条件后结束循环</span><br><span class="line"> COMMIT;   ##执行完成后一起提交</span><br><span class="line">END $$</span><br><span class="line"></span><br><span class="line"># 从deptno&#x3D;START开始，向dept表插入max_num条数据</span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE PROCEDURE insert_dept(IN START INT(10),IN max_num INT(10))  </span><br><span class="line">BEGIN  </span><br><span class="line">DECLARE i INT DEFAULT 0;   </span><br><span class="line"> SET autocommit &#x3D; 0;    </span><br><span class="line"> REPEAT    </span><br><span class="line">  INSERT INTO dept (deptno ,dname,loc) VALUES (START +i ,rand_string(10),rand_string(8));</span><br><span class="line">  SET i &#x3D; i + 1;</span><br><span class="line"> UNTIL i &#x3D; max_num  </span><br><span class="line"> END REPEAT;  </span><br><span class="line"> COMMIT;  </span><br><span class="line">END $$</span><br></pre></td></tr></table></figure>

<p>使用存储过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 员工编号100001-600001</span><br><span class="line">CALL insert_emp(100001,500000);</span><br><span class="line"># 部门编号101-110</span><br><span class="line">CALL insert_dept(101,10); </span><br></pre></td></tr></table></figure>



<h3 id="Show-Profile"><a href="#Show-Profile" class="headerlink" title="Show Profile"></a>Show Profile</h3><p>mysql提供用来分析当前会话中语句执行的资源消耗情况，用于SQL调优的测量。相比于慢查询日志设置阈值，profile可以查看一段时间sql查询情况。</p>
<p>默认处于关闭状态。</p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 查看状态</span><br><span class="line">Show  variables like &#39;profiling&#39;;</span><br><span class="line"># 开启当前会话的profiles，默认保存最近15条记录</span><br><span class="line">set profiling&#x3D;1;</span><br><span class="line"></span><br><span class="line"># 运行sql</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># 查看结果</span><br><span class="line">show profiles;</span><br><span class="line"># 根据query_id查看单条记录具体信息(cpu,io)</span><br><span class="line">show profile cpu,block io for query n</span><br></pre></td></tr></table></figure>

<p>查询时参数</p>
<table>
<thead>
<tr>
<th>parameters</th>
<th>function</th>
</tr>
</thead>
<tbody><tr>
<td>ALL</td>
<td>显示所有的开销信息</td>
</tr>
<tr>
<td>BLOCK IO</td>
<td>显示块IO相关开销</td>
</tr>
<tr>
<td>CONTEXT SWITCHES</td>
<td>上下文切换相关开销</td>
</tr>
<tr>
<td>CPU</td>
<td>显示CPU相关开销信息</td>
</tr>
<tr>
<td>IPC</td>
<td>显示发送和接收相关开销信息</td>
</tr>
<tr>
<td>MEMORY</td>
<td>显示内存相关开销信息</td>
</tr>
<tr>
<td>PAGE FAULTS</td>
<td>显示页面错误相关开销信息</td>
</tr>
<tr>
<td>SOURCE</td>
<td>显示和Source_function，Source_file，Source_line相关的开销信息</td>
</tr>
<tr>
<td>SWAPS</td>
<td>显示交换次数相关开销的信息</td>
</tr>
</tbody></table>
<p>所有结果</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200714105046057.png" alt="image-20200714105046057"></p>
<p>单条查询</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200714105419116.png" alt="image-20200714105419116"></p>
<h4 id="需要注意的状态"><a href="#需要注意的状态" class="headerlink" title="需要注意的状态"></a>需要注意的状态</h4><ul>
<li><code>converting HEAP to MyISAM</code> 查询结果过大，内存不足，将堆转移到磁盘</li>
<li><code>Creating temp table</code> 创建临时表</li>
<li><code>Copying to tmp table on disk</code> 把内存中临时表复制到磁盘。<strong>十分耗时</strong></li>
<li><code>locked</code> 锁</li>
</ul>
<h3 id="全局查询日志"><a href="#全局查询日志" class="headerlink" title="全局查询日志"></a>全局查询日志</h3><p>不要用于生产环境。<strong>了解即可，使用上面的profiles可以更好地分析</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">set global general_log&#x3D;1;</span><br><span class="line"># 直接存放到Mysql系统数据库的general_log表中</span><br><span class="line">set global log_output&#x3D;&#39;TABLE&#39;</span><br><span class="line"># 或者修改配置文件my.inf，在[mysqld]下添加</span><br><span class="line">general_log&#x3D;1</span><br><span class="line"># 存放在文件中，性能更好</span><br><span class="line">general_log_file&#x3D;&#x2F;path&#x2F;logfile</span><br><span class="line">log_output&#x3D;TABLE</span><br><span class="line"></span><br><span class="line"># 从表中查看日志</span><br><span class="line">select * from mysql.general_log;</span><br></pre></td></tr></table></figure>

<p>查询结果</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200714111915664.png" alt="image-20200714111915664"></p>
<h2 id="Mysql锁"><a href="#Mysql锁" class="headerlink" title="Mysql锁"></a>Mysql锁</h2><p>锁是计算机协调多个进程或线程并发访问某一资源的机制。</p>
<p>在数据库中，除传统的计算资源（如CPU、RAM、I/O等）的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂。</p>
<h3 id="数据库锁的分类"><a href="#数据库锁的分类" class="headerlink" title="数据库锁的分类"></a>数据库锁的分类</h3><h4 id="按数据操作类型分类"><a href="#按数据操作类型分类" class="headerlink" title="按数据操作类型分类"></a>按数据操作类型分类</h4><ul>
<li>读锁（共享锁）：针对同一份数据，多个会话的读操作可以同时进行，但不允许写操作</li>
<li>写锁（排它锁）：当前会话写操作未完成前，不允许其他会话同时进行其他操作</li>
</ul>
<h4 id="按操作粒度分类"><a href="#按操作粒度分类" class="headerlink" title="按操作粒度分类"></a>按操作粒度分类</h4><p>粒度使用越细，锁住的数据越少，并发度越高</p>
<ul>
<li>行锁</li>
<li>表锁</li>
</ul>
<h3 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h3><p>偏向<strong>MyISAM存储引擎</strong>，开销小，加锁快，无死锁，锁定粒度大，<strong>发生锁冲突的概率最高</strong>，并发度低。</p>
<h4 id="案例说明"><a href="#案例说明" class="headerlink" title="案例说明"></a>案例说明</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 建表</span><br><span class="line">drop table if exists mylock;</span><br><span class="line">CREATE TABLE mylock (</span><br><span class="line">    id INT PRIMARY KEY auto_increment,</span><br><span class="line">    name VARCHAR (20) NOT NULL</span><br><span class="line">) ENGINE MyISAM DEFAULT charset &#x3D; utf8;</span><br><span class="line">insert into mylock (name) values (&#39;a&#39;);</span><br><span class="line">insert into mylock (name) values (&#39;b&#39;);</span><br><span class="line">insert into mylock (name) values (&#39;c&#39;);</span><br><span class="line">insert into mylock (name) values (&#39;d&#39;);</span><br><span class="line">insert into mylock (name) values (&#39;e&#39;);</span><br><span class="line"># 增加表锁(读锁或写锁)</span><br><span class="line">lock table tablename1 read(write),tablename2 read(write);</span><br><span class="line"># 查看所有表上的锁</span><br><span class="line">show open tables;</span><br><span class="line"># 释放所有表上的锁</span><br><span class="line">unlock tables;</span><br></pre></td></tr></table></figure>

<p><strong>情况1：</strong>会话A上给表A上加读锁</p>
<p>会话A只能在表A上进行<strong>读</strong>操作，<strong>写</strong>操作会<strong>报错</strong>。如果要对其他表操作，必须先释放锁。</p>
<p>会话B可以在表A上进行<strong>读</strong>操作，<strong>写</strong>操作会<strong>阻塞</strong>，当会话A释放表锁，写操作才能执行。</p>
<p><strong>情况2：</strong>会话A上给表A上加写锁</p>
<p>会话A可以在表A上进行<strong>读写</strong>操作。如果要对其他表操作，必须先释放锁。</p>
<p>会话B对于表A的<strong>读写</strong>操作都<strong>阻塞</strong>。如果操作成功，可能是mysql缓存原因，修改下sql语句即可。</p>
<p><strong>分析表锁</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show status like &#39;table%&#39;;</span><br></pre></td></tr></table></figure>

<img src="MySQL基础.assets/image-20200714125910179.png" alt="image-20200714125910179" style="zoom:67%;" />

<ol>
<li>Table_locks_immediate：立即获取锁的查询次数</li>
<li>Table_locks_waited：不能获取表锁而发生等待的次数，此值高则说明存在较严重的表级锁争用情况。</li>
</ol>
<p>MyISAM的读写锁调度是写优先，这也是MyISAM不适合做<strong>写为主</strong>的表的引擎，因为写锁后，其他线程不能做任何操作，大量的更新会使查询很难得到锁，从而造成长时间阻塞。</p>
<h3 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h3><p>偏向<strong>InnoDB存储引擎</strong>，开销大，加锁慢，会出现死锁，锁定粒度小，发生锁冲突的概率低，但并发度高。</p>
<p>InnoDB与MyISAM的最大不同：</p>
<ol>
<li>支持事务</li>
<li>==采用行锁(写操作时默认加锁)==。 InnoDB行锁是<strong>通过索引上的索引项来实现的</strong>，这一点ＭySQL与Oracle不同，后者是通过在数据中对相应数据行加锁来实现的。InnoDB这种行锁实现特点意味者：只有通过索引条件检索数据，InnoDB才会使用行级锁。<strong>没有索引或者索引失效</strong>，InnoDB将使用表锁！</li>
</ol>
<p>建表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists test_innodb_lock;</span><br><span class="line"># 使用innodb引擎创建数据库</span><br><span class="line">CREATE TABLE test_innodb_lock (</span><br><span class="line">    a INT (11),</span><br><span class="line">    b VARCHAR (20) </span><br><span class="line">) ENGINE INNODB DEFAULT charset &#x3D; utf8;</span><br><span class="line">insert into test_innodb_lock values (1,&#39;a&#39;);</span><br><span class="line">insert into test_innodb_lock values (2,&#39;b&#39;);</span><br><span class="line">insert into test_innodb_lock values (3,&#39;c&#39;);</span><br><span class="line">insert into test_innodb_lock values (4,&#39;d&#39;);</span><br><span class="line">insert into test_innodb_lock values (5,&#39;e&#39;);</span><br><span class="line"></span><br><span class="line">create index idx_lock_a on test_innodb_lock(a);</span><br><span class="line">create index idx_lock_b on test_innodb_lock(b);</span><br></pre></td></tr></table></figure>

<h4 id="案例1-innodb默认事务级别"><a href="#案例1-innodb默认事务级别" class="headerlink" title="案例1-innodb默认事务级别"></a>案例1-innodb默认事务级别</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 关闭自动commit</span><br><span class="line">set autocommit&#x3D;0</span><br></pre></td></tr></table></figure>

<p>可以看到</p>
<ul>
<li>左边事务修改但未提交，右边事务并不能获取到左边事务未提交的数据。</li>
<li>左边事务commit之后，右边事务还是不能获取左边事务提交的数据</li>
<li>因为innodb默认支持的事务级别REPEATABLE READ，避免了脏读和不可重复读</li>
</ul>
<p><img src="MySQL基础.assets/image-20200714152756130.png" alt="image-20200714152756130" style="zoom: 50%;" /><img src="MySQL%E5%9F%BA%E7%A1%80.assets/image-20200714154245129.png" alt="image-20200714154245129"></p>
<img src="MySQL基础.assets/image-20200714154322988.png" alt="image-20200714154322988" style="zoom: 50%;" />

<p>必须要在右边事务commit之后，才能获取左边事务提交的新数据</p>
<img src="MySQL基础.assets/image-20200714154508848.png" alt="image-20200714154508848" style="zoom: 80%;" />

<h4 id="案例2-行锁"><a href="#案例2-行锁" class="headerlink" title="案例2-行锁"></a>案例2-行锁</h4><p>可以看到使用行锁后(写操作时Innodb引擎默认加锁)</p>
<ul>
<li>不同事务对于同一张表同一数据行的操作进行加锁。右边事务必须等待左边事务提交后，才能提交</li>
</ul>
<img src="MySQL基础.assets/image-20200714160456238.png" alt="image-20200714160456238" style="zoom:67%;" />



<h4 id="案例3-行锁失效"><a href="#案例3-行锁失效" class="headerlink" title="案例3-行锁失效"></a>案例3-行锁失效</h4><p>可以看到虽然AB两个事务操作的是不同的数据行</p>
<ul>
<li>由于A事务发生了隐式数据转换（字符串没有加引号），<strong>导致索引失效，锁的级别从行锁升级为表锁</strong></li>
</ul>
<img src="MySQL基础.assets/image-20200714161847506.png" alt="image-20200714161847506" style="zoom:67%;" />



<h4 id="案例4-间隙锁"><a href="#案例4-间隙锁" class="headerlink" title="案例4-间隙锁"></a>案例4-间隙锁</h4><p>当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁，对于键值在条件范围内但不存在的记录，叫作“间隙（GAP）”。</p>
<p>间隙锁是为了解决幻读而产生的。当进行范围查询时，为了不产生幻读，即两次读取数据条数不一致，对范围内所有数据加锁。</p>
<p>对于事务A，where条件匹配数据库中的项应该是a=3,a=4,a=5</p>
<p>但是事务B在插入a=2时，依然会被锁住。</p>
<p>因为间隙锁实际锁住了a∈[2,5]，即使a=2并不存在，此时a=2就叫“间隙”</p>
<img src="MySQL基础.assets/image-20200714163036965.png" alt="image-20200714163036965" style="zoom: 67%;" />

<img src="MySQL基础.assets/image-20200714162953374.png" alt="image-20200714162953374" style="zoom:67%;" />



<h4 id="案例5-主动添加行锁"><a href="#案例5-主动添加行锁" class="headerlink" title="案例5-主动添加行锁"></a>案例5-主动添加行锁</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 添加共享锁</span><br><span class="line">SELECT * FROM table_name WHERE ... LOCK IN SHARE MODE</span><br><span class="line"># 锁住sno&#x3D;1的行</span><br><span class="line">select * from student where sno&#x3D;1 lock in share mode;</span><br><span class="line"># 添加排它锁</span><br><span class="line">SELECT * FROM table_name WHERE ... FOR UPDATE</span><br></pre></td></tr></table></figure>



<h4 id="案例6-行锁分析"><a href="#案例6-行锁分析" class="headerlink" title="案例6-行锁分析"></a>案例6-行锁分析</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show status like &#39;innodb_row_lock%&#39;;</span><br></pre></td></tr></table></figure>

<p>各个状态量说明：</p>
<ol>
<li>Innodb_row_lock_current_waits：当前正在等待锁定的数量。</li>
<li><strong>Innodb_row_lock_time</strong>：从系统启动到现在锁定的时长。</li>
<li><strong>Innodb_row_lock_time_avg</strong>：每次等待锁所花平均时间。</li>
<li>Innodb_row_lock_time_max：从系统启动到现在锁等待最长的一次所花的时间。</li>
<li><strong>Innodb_row_lock_waits</strong>：系统启动后到现在总共等待锁的次数。</li>
</ol>
<p>这个五个状态量中，比较重要的是：</p>
<p>Innodb_row_lock_time、Innodb_row_lock_time_avg和Innodb_row_lock_waits。尤其是等待次数很高，而且每次等待时长不小时，就可以使用profiles进行分析。</p>
<img src="MySQL基础.assets/image-20200714165832912.png" alt="image-20200714165832912" style="zoom:67%;" />

<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>innodb使用更细粒度的行锁，更加适合高并发的场景，但是如果使用不当，当时行锁失效，转换表锁，效率可能比MyISAM更低。</p>
<h4 id="优化建议"><a href="#优化建议" class="headerlink" title="优化建议"></a>优化建议</h4><ol>
<li>尽可能让所有数据都通过索引来完成，避免无索引行升级为表锁。</li>
<li>合理设计索引，尽量缩小锁的范围。</li>
<li>尽可能使用较少的检索条件，避免间隙锁。</li>
<li>尽量控制事务大小，减少锁定资源量和时间长度。</li>
<li>尽可能降低事务隔离级别</li>
</ol>
<h3 id="页锁"><a href="#页锁" class="headerlink" title="页锁"></a>页锁</h3><ul>
<li><p>锁的粒度介于表锁和行锁之间，开销和加锁时间介于表锁和行锁之间，并发度一般</p>
</li>
<li><p>会出现死锁</p>
</li>
</ul>
<h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><h3 id="基本步骤"><a href="#基本步骤" class="headerlink" title="基本步骤"></a>基本步骤</h3><p>slave会从master读取binlog来进行数据同步。主要有以下三个步骤：</p>
<ol>
<li>master将改变记录到二进制日志（binary log），这些记录过程叫做二进制日志事件（binary log events）。</li>
<li>slave开启一个I/O Thread，将master的binary log events拷贝到中继日志（relay log）。</li>
<li>slave重做中继日志中的事件，将改变应用到自己的数据库中。MySQL的复制是<strong>异步且串行化</strong>的。</li>
</ol>
<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/706569-20180630100101056-666555235.png" alt="img"></p>
<h3 id="原则"><a href="#原则" class="headerlink" title="原则"></a>原则</h3><ol>
<li>每个slave只能有一个master。（一对一）</li>
<li>每个slave只能有一个唯一的服务器ID。</li>
<li>每个master可以有多个slave。（一对多）</li>
</ol>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>在主从复制过程中，最大的问题就是延时。</p>
<h3 id="一主一从的常见配置"><a href="#一主一从的常见配置" class="headerlink" title="一主一从的常见配置"></a>一主一从的常见配置</h3><h4 id="基本要求"><a href="#基本要求" class="headerlink" title="基本要求"></a>基本要求</h4><ul>
<li>MySQL版本最好一致且后台以服务运行。</li>
<li>保证主机与从机互相ping通。</li>
<li>主从配置都在配置文件的[mysqld]结点下，都是小写</li>
<li>修改配置文件之后，要重启服务</li>
<li>主机和从机都要关闭防火墙，其实也可以配置ip规则。<ul>
<li>windows，手动关闭</li>
<li>linux，使用命令 <code>service iptables stop</code> </li>
</ul>
</li>
</ul>
<h4 id="主机配置"><a href="#主机配置" class="headerlink" title="主机配置"></a>主机配置</h4><p>修改my.ini配置文件(windows)</p>
<ol>
<li><p>设置主机服务器id，<code>server-id=1</code> （必须）</p>
</li>
<li><p>启用二进制文件。（必须）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log-bin&#x3D;&quot;D:&#x2F;MySQL&#x2F;MySQL Server 5.5&#x2F;data&#x2F;mysqlbin&quot;</span><br></pre></td></tr></table></figure>

<p><img src="MySQL%E5%9F%BA%E7%A1%80.assets/706569-20180630103727168-1004774476.png" alt="img"></p>
</li>
<li><p>启动错误日志（optional)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_error &#x3D;&quot;D:&#x2F;MySQL&#x2F;MySQL Server 5.5&#x2F;data&#x2F;mysqlerr&quot;</span><br></pre></td></tr></table></figure></li>
<li><p>设置根目录、数据目录(optional)</p>
<p>修改数据文件位置会导致启动报错，解决方式就是将原先的data文件夹中文件全部拷贝到当前data目录中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#mysql安装根目录</span><br><span class="line">basedir&#x3D;&quot;D:&#x2F;MySQL&#x2F;MySQL Server 5.5&#x2F;&quot;</span><br><span class="line"> </span><br><span class="line">#mysql数据文件所在位置</span><br><span class="line">datadir&#x3D;&quot;D:&#x2F;MySQL&#x2F;MySQL Server 5.5&#x2F;data&#x2F;&quot;</span><br><span class="line"></span><br><span class="line">#mysql临时目录</span><br><span class="line">tmpdir  &#x3D;&quot;D:&#x2F;MySQL&#x2F;MySQL Server 5.5&#x2F;&quot;</span><br></pre></td></tr></table></figure></li>
<li><p>关闭只读(optional)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read-only&#x3D;0</span><br></pre></td></tr></table></figure></li>
<li><p>设置不需要复制的数据库（optional)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binlog-ignore-db&#x3D;mysql</span><br></pre></td></tr></table></figure></li>
<li><p>设置需要复制的数据库（optional)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binlog-do-db&#x3D;databasename</span><br></pre></td></tr></table></figure></li>
<li><p>重启服务，使用管理员方式执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net stop mysql</span><br><span class="line">net restart mysql</span><br></pre></td></tr></table></figure></li>
<li><p>关闭防火墙</p>
</li>
</ol>
<h4 id="从机配置"><a href="#从机配置" class="headerlink" title="从机配置"></a>从机配置</h4><p>修改my.cnf配置文件(linux)</p>
<ol>
<li><p>设置从服务器ID（necessary）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#linux中 存在该项配置，只需要取消注释，同时注释掉server-id&#x3D;1</span><br><span class="line">server-id&#x3D;2</span><br></pre></td></tr></table></figure></li>
<li><p>启用二进制日志（necessary)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 配置中已经存在，不需要修改</span><br><span class="line">log-bin&#x3D;mysql-bin</span><br></pre></td></tr></table></figure></li>
<li><p>关闭防火墙</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 检查防火墙状态</span><br><span class="line">service iptables status</span><br><span class="line"># 关闭防火墙</span><br><span class="line">service iptables stop</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="主机建立账户并授权给slave"><a href="#主机建立账户并授权给slave" class="headerlink" title="主机建立账户并授权给slave"></a>主机建立账户并授权给slave</h4><ol>
<li><p>创建一个有复制权限的用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT REPLICATION SLAVE ON *.* TO &#x27;slaveaccount（用户名）&#x27;@&#x27;从机数据库ip&#x27; IDENTIFIED BY &#x27;密码&#x27;</span><br></pre></td></tr></table></figure></li>
<li><p>再次刷新权限表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 在windows中mysql命令行中执行</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure></li>
<li><p>查询主机状态(要保证是最新的)</p>
<p>File告诉从机需要从哪个文件进行复制，Position告诉从机从文件的哪个位置开始复制，在从机上配置时需用到。</p>
<p>执行完此操作后，尽量不要在操作主服务器MySQL，防止主服务器状态变化（File和Position状态变化）。</p>
<p><img src="https://images2018.cnblogs.com/blog/706569/201806/706569-20180630111240913-127840494.png" alt="img"></p>
</li>
</ol>
<h4 id="从机连接主机"><a href="#从机连接主机" class="headerlink" title="从机连接主机"></a>从机连接主机</h4><ol>
<li><p>从机中配置主机信息(上一步中账户信息和主机状态）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 在mysql命令中执行</span><br><span class="line">CHANGE MASTER TO MASTER_HOST&#x3D;&#39;主机IP&#39;,</span><br><span class="line">MASTER_USER&#x3D;&#39;salveaccount&#39;,</span><br><span class="line">MASTER_PASSWORD&#x3D;&#39;密码&#39;,</span><br><span class="line">MASTER_LOG_FILE&#x3D;&#39;File名字&#39;,</span><br><span class="line">MASTER_LOG_POS&#x3D;Position数字;</span><br></pre></td></tr></table></figure></li>
<li><p>启动从机复制功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#启动复制</span><br><span class="line">start slave;</span><br><span class="line"># 关闭复制</span><br><span class="line">stop slave;</span><br></pre></td></tr></table></figure></li>
<li><p>查看复制状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show slave status\G;</span><br></pre></td></tr></table></figure>

<p>只有当Slave_IO_Running:Yes和Slave_SQL_Running:Yes，这两个都为Yes的时候，主从复制配置才成功。</p>
<img src="MySQL基础.assets/image-20200714190044468.png" alt="image-20200714190044468" style="zoom:67%;" /></li>
</ol>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>在主机建立数据库并插入数据</p>
<img src="MySQL基础.assets/image-20200714190451967.png" alt="image-20200714190451967" style="zoom:67%;" />

<p>检查从机是否包含刚刚创建的数据库</p>
<img src="MySQL基础.assets/image-20200714190547373.png" alt="image-20200714190547373" style="zoom:67%;" />







<h1 id="MySQL之MVVC简介"><a href="#MySQL之MVVC简介" class="headerlink" title="MySQL之MVVC简介"></a>MySQL之MVVC简介</h1><h2 id="一丶什么是MVCC？"><a href="#一丶什么是MVCC？" class="headerlink" title="一丶什么是MVCC？"></a>一丶什么是MVCC？</h2><p>　　MVCC (Multi-Version Concurrency Control) (注：与MVCC相对的，是基于锁的并发控制，Lock-Based Concurrency Control)是一种基于多版本的并发控制协议，只有在InnoDB引擎下存在。MVCC是为了实现事务的隔离性，通过版本号，避免同一数据在不同事务间的竞争，你可以把它当成基于多版本号的一种乐观锁。当然，这种乐观锁只在事务级别未提交锁和已提交锁时才会生效。MVCC最大的好处，相信也是耳熟能详：读不加锁，读写不冲突。在读多写少的OLTP应用中，读写不冲突是非常重要的，极大的增加了系统的并发性能。具体见下面介绍。</p>
<h2 id="二丶MVCC的实现机制"><a href="#二丶MVCC的实现机制" class="headerlink" title="二丶MVCC的实现机制"></a>二丶MVCC的实现机制</h2><p>　　InnoDB在每行数据都增加两个隐藏字段，一个记录创建的版本号，一个记录删除的版本号。</p>
<p>　　在多版本并发控制中，为了保证数据操作在多线程过程中，保证事务隔离的机制，降低锁竞争的压力，保证较高的并发量。在每开启一个事务时，会生成一个事务的版本号，被操作的数据会生成一条新的数据行（临时），但是在提交前对其他事务是不可见的，对于数据的更新（包括增删改）操作成功，会将这个版本号更新到数据的行中，事务提交成功，将新的版本号更新到此数据行中，这样保证了每个事务操作的数据，都是互不影响的，也不存在锁的问题。</p>
<h2 id="三丶MVCC下的CRUD"><a href="#三丶MVCC下的CRUD" class="headerlink" title="三丶MVCC下的CRUD"></a>三丶MVCC下的CRUD</h2><p><strong>SELECT：</strong><br>　　当隔离级别是REPEATABLE READ时select操作，InnoDB必须每行数据来保证它符合两个条件：<br>　　1、InnoDB必须找到一个行的创建记录版本，它至少要和事务的版本一样老(也即它的版本号不大于事务的版本号)。这保证了不管是事务开始之前，或者事务创建时，或者修改了这行数据的时候，这行数据是存在的。<br>　　2、这行数据的删除版本必须是未定义的或者比事务版本要大。这可以保证在事务开始之前这行数据没有被删除。<br>符合这两个条件的行可能会被当作查询结果而返回。</p>
<p><strong>INSERT：</strong></p>
<p>　　InnoDB为这个新行记录当前的系统版本号。<br><strong>DELETE：</strong></p>
<p>　　InnoDB将当前的系统版本号设置为这一行的删除ID。<br><strong>UPDATE：</strong></p>
<p>　　InnoDB会写一个这行数据的新拷贝，这个拷贝的版本为当前的系统版本号。它同时也会将这个版本号写到旧行的删除版本里。</p>
<p>　　这种额外的记录所带来的结果就是对于大多数查询来说根本就不需要获得一个锁。他们只是简单地以最快的速度来读取数据，确保只选择符合条件的行。这个方案的缺点在于存储引擎必须为每一行存储更多的数据，做更多的检查工作，处理更多的善后操作。<br>　　MVCC只工作在REPEATABLE READ和READ COMMITED隔离级别下。READ UNCOMMITED不是MVCC兼容的，因为查询不能找到适合他们事务版本的行版本；它们每次都只能读到最新的版本。SERIABLABLE也不与MVCC兼容，因为读操作会锁定他们返回的每一行数据。</p>
<h1 id="数据库的redo-undo"><a href="#数据库的redo-undo" class="headerlink" title="数据库的redo,undo"></a>数据库的redo,undo</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/shenjian58/article/details/102547903?utm_medium=distribute.pc_relevant.none-task-blog-baidujs-1&spm=1001.2101.3001.4242">参考网址</a></p>
<h4 id="redo"><a href="#redo" class="headerlink" title="redo"></a>redo</h4><p> <strong>Redo是物理日志，记录的是数据页的物理变化</strong>。而逻辑Redo日志，不是记录页面的实际修改，而是记录修改页面的一类操作</p>
<h4 id="使用redo-log原因"><a href="#使用redo-log原因" class="headerlink" title="使用redo log原因"></a>使用redo log原因</h4><ul>
<li>事务提交后，必须将事务对数据页的修改刷(fsync)到磁盘上，才能保证事务的ACID特性。</li>
<li>这个刷盘，是一个随机写，随机写性能较低，如果每次事务提交都刷盘，会极大影响数据库的性能。</li>
</ul>
<p>架构设计中有两个常见的优化方法：</p>
<p>（1）先写日志(write log first)，将随机写<strong>优化为</strong>顺序写；</p>
<p>（2）将每次写<strong>优化为</strong>批量写；</p>
<p>第一条就是redo，某一时刻，数据库崩溃，还没来得及将数据页刷盘，数据库重启时，会重做redo log里的内容，以保证已提交事务对数据的影响被刷到磁盘上。</p>
<p>log是为了保证已提交事务的ACID特性，同时能够提高数据库性能的技术。</p>
<h4 id="使用redo-log，数据库崩溃，导致数据丢失原因"><a href="#使用redo-log，数据库崩溃，导致数据丢失原因" class="headerlink" title="使用redo log，数据库崩溃，导致数据丢失原因"></a>使用redo log，数据库崩溃，导致数据丢失原因</h4><p>redo的三层架构</p>
<p><img src="MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7.assets/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9ZcmV6eGNraFlPeHcya3MxQ2xOSzNqM21JUElqOVB5SEJYUHZiSFd3R0toWkV5dzd6YWpQejdpYkw0M2wyQ3BaVm9laWNRTVdMaWFLeENpY2I1b09EazZLU1EvNjQw" alt="img"></p>
<p><em><strong>*redo log*</strong>***</em>*最终落盘的步骤如何？****</p>
<ul>
<li><p><strong>首先</strong>，事务提交的时候，会写入Log Buffer，这里调用的是MySQL自己的函数WriteRedoLog；</p>
</li>
<li><p><strong>接着</strong>，只有当MySQL发起系统调用写文件write时，Log Buffer里的数据，才会写到OS cache。注意，==MySQL系统调用完write之后，就认为文件已经写完，如果不flush，什么时候落盘，是操作系统决定的==；</p>
<ul>
<li>画外音：<strong>有时候打日志，明明</strong>printf<strong>了，</strong>tail -f**却看不到，就是这个原因，这个细节在《<a target="_blank" rel="noopener" href="https://blog.csdn.net/shenjian58/article/details/89850428">明明打印到文件了，为啥tail -f看不到</a>》一文里说过，此处不再展开。</li>
</ul>
</li>
<li><p><strong>最后</strong>，由操作系统（当然，MySQL也可以主动flush）将OS cache里的数据，最终fsync到磁盘上；</p>
</li>
</ul>
<p><em><strong>*操作系统为什么要缓冲数据到*</strong>***</em>*OS cache****<em><strong>*里，而不直接刷盘呢？*</strong></em></p>
<p>这里就是将“每次写”优化为“批量写”，以提高操作系统性能。</p>
<p><em><strong>*数据库为什么要缓冲数据到*</strong>***</em>*Log Buffer*<strong><strong><strong>*里，而不是直接*</strong></strong></strong>*write****<em><strong>*呢？*</strong></em></p>
<p>这也是“每次写”优化为“批量写”思路的体现，以提高数据库性能。</p>
<p><em>画外音：**这个优化思路，非常常见，高并发的MQ落盘，高并发的业务数据落盘，都可以使用。</em></p>
<p>redo log的三层架构，MySQL做了一次批量写优化，OS做了一次批量写优化，确实能极大提升性能，<strong>但有什么副作用吗？</strong></p>
<p><em>画外音：**有优点，必有缺点。</em></p>
<p>这个<strong>副作用</strong>，就是可能丢失数据：</p>
<p>（1）事务提交时，将redo log写入Log Buffer，就会认为事务提交成功；</p>
<p>（2）如果写入Log Buffer的数据，write入OS cache之前，数据库崩溃，就会出现数据丢失；</p>
<p>（3）如果写入OS cache的数据，fsync入磁盘之前，操作系统奔溃，也可能出现数据丢失；</p>
<p><em>画外音：<strong>如上文所说，应用程序系统调用完</strong>write<strong>之后（不可能每次</strong>write<strong>后都立刻</strong>flush<strong>，这样写日志很蠢），就认为写成功了，操作系统何时</strong>fsync**，应用程序并不知道，如果操作系统崩溃，数据可能丢失。</em></p>
<h4 id="undo"><a href="#undo" class="headerlink" title="undo"></a>undo</h4><p>undo log主要记录的是数据的逻辑变化，为了在发生错误时回滚之前的操作，需要将之前的操作都记录下来，然后在发生错误时才可以回滚。</p>
<h3 id="undo-log的作用"><a href="#undo-log的作用" class="headerlink" title="undo log的作用"></a>undo log的作用</h3><p>undo是一种逻辑日志，有两个作用：</p>
<ul>
<li>用于事务的回滚</li>
<li>MVCC</li>
</ul>
<p>关于MVCC(多版本并发控制)的内容这里就不多说了，本文重点关注undo log用于事务的回滚。</p>
<p>undo日志，只将数据库逻辑地恢复到原来的样子，在回滚的时候，它实际上是做的相反的工作，比如一条INSERT ，对应一条 DELETE，对于每个UPDATE,对应一条相反的 UPDATE,将修改前的行放回去。undo日志用于事务的回滚操作进而保障了事务的原子性。</p>
<h3 id="undo-log的写入时机"><a href="#undo-log的写入时机" class="headerlink" title="undo log的写入时机"></a>undo log的写入时机</h3><ul>
<li>DML操作修改聚簇索引前，记录undo日志</li>
<li>二级索引记录的修改，不记录undo日志</li>
</ul>
<p>需要注意的是，undo页面的修改，同样需要记录redo日志。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">假设有A、B两个数据，值分别为1,2.</span><br><span class="line">1. 事务开始</span><br><span class="line">2. 记录A=1到undo <span class="built_in">log</span></span><br><span class="line">3. 修改A=3</span><br><span class="line">4. 记录A=3到 redo <span class="built_in">log</span></span><br><span class="line">5. 记录B=2到 undo <span class="built_in">log</span></span><br><span class="line">6. 修改B=4</span><br><span class="line">7. 记录B=4到redo <span class="built_in">log</span></span><br><span class="line">8. 将redo <span class="built_in">log</span>写入磁盘</span><br><span class="line">9. 事务提交</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    
      <div>
        <div class="wechat_OA">
    <span>欢迎关注我们的公众号</span>
    <br>
    <!-- 这里添加你的二维码图片 -->
    <img src ="https://ae01.alicdn.com/kf/U0c820fb8af0f4a6a84fde221b4177520e.jpg">
</div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:</strong>
    xhj
  </li>
  <li class="post-copyright-link">
    <strong>Post link:</strong>
    <a href="http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/" title="MySQL基础与高级">http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice: </strong>
    All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MySQL/" rel="tag"># MySQL</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2024/04/04/Maven/" rel="next" title="Maven">
                <i class="fa fa-chevron-left"></i> Maven
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2024/05/05/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%8F%8AUML%E7%B1%BB%E5%9B%BE/" rel="prev" title="Java设计模式及UML类图">
                Java设计模式及UML类图 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">109</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">102</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/hzhzxfs" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://wcy111.github.io/" title="Yaoguo Wang" target="_blank">Yaoguo Wang</a>
                  </li>
                
              </ul>
            </div>
          

          
        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-number">1.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Mysql%E5%9F%BA%E7%A1%80"><span class="nav-number">2.</span> <span class="nav-text">Mysql基础</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-number">2.1.</span> <span class="nav-text">数据库相关概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%A5%BD%E5%A4%84"><span class="nav-number">2.1.1.</span> <span class="nav-text">数据库的好处</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B8%B8%E8%A7%81%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="nav-number">2.1.2.</span> <span class="nav-text">数据库常见名词解释</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E7%9A%84%E7%89%B9%E7%82%B9"><span class="nav-number">2.1.3.</span> <span class="nav-text">数据库存储数据的特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">2.1.4.</span> <span class="nav-text">常见数据库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL%E4%BA%A7%E5%93%81%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E5%AE%89%E8%A3%85"><span class="nav-number">2.2.</span> <span class="nav-text">MySQL产品的介绍和安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL%E8%83%8C%E6%99%AF"><span class="nav-number">2.2.1.</span> <span class="nav-text">MySQL背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL%E7%9A%84%E4%BC%98%E7%82%B9"><span class="nav-number">2.2.2.</span> <span class="nav-text">MySQL的优点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Windows%E4%B8%8A%E4%BD%BF%E7%94%A8"><span class="nav-number">2.2.3.</span> <span class="nav-text">Windows上使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">2.2.3.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%8D%B8%E8%BD%BD"><span class="nav-number">2.2.3.2.</span> <span class="nav-text">MySQL数据库管理系统的卸载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MySQL%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%90%AF%E5%8A%A8%E5%92%8C%E5%81%9C%E6%AD%A2"><span class="nav-number">2.2.3.3.</span> <span class="nav-text">MySQL服务的启动和停止</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%99%BB%E5%BD%95%E5%92%8C%E9%80%80%E5%87%BA"><span class="nav-number">2.2.3.4.</span> <span class="nav-text">登录和退出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89MySQL%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-number">2.2.3.5.</span> <span class="nav-text">自定义MySQL的配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux%E4%B8%8A%E4%BD%BF%E7%94%A8"><span class="nav-number">2.2.4.</span> <span class="nav-text">Linux上使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-1"><span class="nav-number">2.2.4.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E5%92%8C%E5%85%B3%E9%97%AD%E6%9C%8D%E5%8A%A1"><span class="nav-number">2.2.4.2.</span> <span class="nav-text">启动和关闭服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%99%BB%E5%BD%95%E5%92%8C%E9%80%80%E5%87%BA-1"><span class="nav-number">2.2.4.3.</span> <span class="nav-text">登录和退出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Mysql%E9%85%8D%E7%BD%AE"><span class="nav-number">2.2.4.4.</span> <span class="nav-text">自定义Mysql配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL%E7%9A%84%E5%B8%B8%E8%A7%81%E5%91%BD%E4%BB%A4"><span class="nav-number">2.2.5.</span> <span class="nav-text">MySQL的常见命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL%E7%9A%84%E8%AF%AD%E6%B3%95%E8%A7%84%E8%8C%83"><span class="nav-number">2.2.6.</span> <span class="nav-text">MySQL的语法规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL%E7%9A%84%E8%AF%AD%E8%A8%80%E5%88%86%E7%B1%BB"><span class="nav-number">2.2.7.</span> <span class="nav-text">SQL的语言分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL%E7%9A%84%E5%B8%B8%E8%A7%81%E5%91%BD%E4%BB%A4"><span class="nav-number">2.2.8.</span> <span class="nav-text">SQL的常见命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DQL%E8%AF%AD%E8%A8%80%E7%9A%84%E5%AD%A6%E4%B9%A0"><span class="nav-number">2.3.</span> <span class="nav-text">DQL语言的学习</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E9%98%B61%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.1.</span> <span class="nav-text">进阶1：基础查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E9%98%B62%EF%BC%9A%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.2.</span> <span class="nav-text">进阶2：条件查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E9%98%B63%EF%BC%9A%E6%8E%92%E5%BA%8F%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.3.</span> <span class="nav-text">进阶3：排序查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E9%98%B64%EF%BC%9A%E5%B8%B8%E8%A7%81%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.4.</span> <span class="nav-text">进阶4：常见函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E8%A1%8C%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.4.1.</span> <span class="nav-text">单行函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E8%A1%8C%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.4.2.</span> <span class="nav-text">多行函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E9%98%B65%EF%BC%9A%E5%88%86%E7%BB%84%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.5.</span> <span class="nav-text">进阶5：分组查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E9%98%B66%EF%BC%9A%E5%A4%9A%E8%A1%A8%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.6.</span> <span class="nav-text">进阶6：多表连接查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E9%98%B67%EF%BC%9A%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.7.</span> <span class="nav-text">进阶7：子查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#in%E5%92%8Cexists%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">2.3.7.1.</span> <span class="nav-text">in和exists的区别</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E9%98%B68%EF%BC%9A%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.8.</span> <span class="nav-text">进阶8：分页查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E9%98%B69%EF%BC%9A%E8%81%94%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.9.</span> <span class="nav-text">进阶9：联合查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E5%BC%95%E5%8F%B7%E5%92%8C%E5%8F%8C%E5%BC%95%E5%8F%B7%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">2.3.10.</span> <span class="nav-text">单引号和双引号的区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DML%E8%AF%AD%E8%A8%80"><span class="nav-number">2.4.</span> <span class="nav-text">DML语言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%92%E5%85%A5"><span class="nav-number">2.4.1.</span> <span class="nav-text">插入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9"><span class="nav-number">2.4.2.</span> <span class="nav-text">修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4"><span class="nav-number">2.4.3.</span> <span class="nav-text">删除</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DDL%E8%AF%AD%E8%A8%80"><span class="nav-number">2.5.</span> <span class="nav-text">DDL语言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E8%A1%A8"><span class="nav-number">2.5.1.</span> <span class="nav-text">定义数据库和表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">2.5.2.</span> <span class="nav-text">数据类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%BA%A6%E6%9D%9F"><span class="nav-number">2.5.3.</span> <span class="nav-text">常见约束</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E7%BA%A6%E6%9D%9F"><span class="nav-number">2.5.4.</span> <span class="nav-text">定义约束</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%A2%9E%E9%95%BF%E5%88%97"><span class="nav-number">2.5.5.</span> <span class="nav-text">自增长列</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DTL%E8%AF%AD%E8%A8%80"><span class="nav-number">2.6.</span> <span class="nav-text">DTL语言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AB%E4%B9%89"><span class="nav-number">2.6.1.</span> <span class="nav-text">含义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E7%82%B9-ACID"><span class="nav-number">2.6.2.</span> <span class="nav-text">特点(ACID)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%88%86%E7%B1%BB"><span class="nav-number">2.6.3.</span> <span class="nav-text">事务的分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%88%B0%E7%9A%84%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-number">2.6.4.</span> <span class="nav-text">使用到的关键字</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-number">2.6.5.</span> <span class="nav-text">事务的隔离级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E4%BF%9D%E5%AD%98%E7%82%B9"><span class="nav-number">2.6.6.</span> <span class="nav-text">设置保存点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#delete%E5%92%8Ctruncate%E5%9C%A8%E4%BA%8B%E5%8A%A1%E4%B8%AD%E5%8C%BA%E5%88%AB"><span class="nav-number">2.6.7.</span> <span class="nav-text">delete和truncate在事务中区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%86%E5%9B%BE"><span class="nav-number">2.7.</span> <span class="nav-text">视图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%86%E5%9B%BE%E5%92%8C%E8%A1%A8%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">2.7.1.</span> <span class="nav-text">视图和表的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E8%A7%86%E5%9B%BE"><span class="nav-number">2.7.2.</span> <span class="nav-text">定义视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%86%E5%9B%BE%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="nav-number">2.7.3.</span> <span class="nav-text">视图的操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%98%E9%87%8F"><span class="nav-number">2.8.</span> <span class="nav-text">变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F"><span class="nav-number">2.8.1.</span> <span class="nav-text">系统变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="nav-number">2.8.2.</span> <span class="nav-text">自定义变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">2.9.</span> <span class="nav-text">存储过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89"><span class="nav-number">2.9.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">2.9.2.</span> <span class="nav-text">创建存储过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9D%9F%E6%A0%87%E8%AE%B0delimiter"><span class="nav-number">2.9.3.</span> <span class="nav-text">结束标记delimiter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">2.9.4.</span> <span class="nav-text">调用存储过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0"><span class="nav-number">2.10.</span> <span class="nav-text">函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E5%92%8C%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">2.10.1.</span> <span class="nav-text">函数和存储过程的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%87%BD%E6%95%B0"><span class="nav-number">2.10.2.</span> <span class="nav-text">创建函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0"><span class="nav-number">2.10.3.</span> <span class="nav-text">调用函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E7%BB%93%E6%9E%84"><span class="nav-number">2.11.</span> <span class="nav-text">流程控制结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%94%AF"><span class="nav-number">2.11.1.</span> <span class="nav-text">分支</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF"><span class="nav-number">2.11.2.</span> <span class="nav-text">循环</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Mysql%E9%AB%98%E7%BA%A7"><span class="nav-number">3.</span> <span class="nav-text">Mysql高级</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Mysql%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-number">3.1.</span> <span class="nav-text">Mysql逻辑架构图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E5%B1%82"><span class="nav-number">3.1.1.</span> <span class="nav-text">连接层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%B1%82"><span class="nav-number">3.1.2.</span> <span class="nav-text">服务层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E6%93%8E%E5%B1%82"><span class="nav-number">3.1.3.</span> <span class="nav-text">引擎层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MyISAM%E5%BC%95%E6%93%8E%E5%92%8CInnoDB%E5%BC%95%E6%93%8E%E5%8C%BA%E5%88%AB"><span class="nav-number">3.1.4.</span> <span class="nav-text">MyISAM引擎和InnoDB引擎区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%B1%82"><span class="nav-number">3.1.5.</span> <span class="nav-text">存储层</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mysql%E6%9F%A5%E8%AF%A2%E4%B8%8E%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">3.2.</span> <span class="nav-text">Mysql查询与执行流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B"><span class="nav-number">3.2.1.</span> <span class="nav-text">查询流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mysql%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="nav-number">3.2.2.</span> <span class="nav-text">mysql执行顺序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E4%BD%8E%E6%80%A7%E8%83%BD%E5%8E%9F%E5%9B%A0%E5%8F%8A%E5%A4%84%E7%90%86"><span class="nav-number">3.3.</span> <span class="nav-text">常见低性能原因及处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95"><span class="nav-number">3.4.</span> <span class="nav-text">索引</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-number">3.4.1.</span> <span class="nav-text">索引的优缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E5%88%86%E7%B1%BB"><span class="nav-number">3.4.2.</span> <span class="nav-text">索引分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E7%B4%A2%E5%BC%95%E5%92%8C%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">3.4.3.</span> <span class="nav-text">普通索引和唯一索引的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E8%BF%87%E7%A8%8B"><span class="nav-number">3.4.4.</span> <span class="nav-text">数据更新过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E6%93%8D%E4%BD%9C"><span class="nav-number">3.4.5.</span> <span class="nav-text">索引操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84"><span class="nav-number">3.4.6.</span> <span class="nav-text">索引结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#BTree%E7%B4%A2%E5%BC%95"><span class="nav-number">3.4.6.1.</span> <span class="nav-text">BTree索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-Tree%E7%B4%A2%E5%BC%95"><span class="nav-number">3.4.6.2.</span> <span class="nav-text">B+Tree索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hash%E7%B4%A2%E5%BC%95"><span class="nav-number">3.4.6.3.</span> <span class="nav-text">Hash索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RTree%E7%B4%A2%E5%BC%95"><span class="nav-number">3.4.6.4.</span> <span class="nav-text">RTree索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#full-text%E7%B4%A2%E5%BC%95"><span class="nav-number">3.4.6.5.</span> <span class="nav-text">full-text索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%81%9A%E9%9B%86%E7%B4%A2%E5%BC%95%E5%92%8C%E9%9D%9E%E8%81%9A%E9%9B%86%E7%B4%A2%E5%BC%95"><span class="nav-number">3.4.6.6.</span> <span class="nav-text">聚集索引和非聚集索引</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95"><span class="nav-number">3.4.6.6.1.</span> <span class="nav-text">覆盖索引</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E5%88%9B%E5%BB%BA%E6%9D%A1%E4%BB%B6"><span class="nav-number">3.4.7.</span> <span class="nav-text">索引创建条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Explain%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="nav-number">3.4.8.</span> <span class="nav-text">Explain性能分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%9C%E7%94%A8"><span class="nav-number">3.4.8.1.</span> <span class="nav-text">作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Explain%E4%BD%BF%E7%94%A8"><span class="nav-number">3.4.8.2.</span> <span class="nav-text">Explain使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E8%AF%B4%E6%98%8E"><span class="nav-number">3.4.8.2.1.</span> <span class="nav-text">字段说明</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B"><span class="nav-number">3.4.8.3.</span> <span class="nav-text">案例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E5%8E%9F%E5%9B%A0%E5%8F%8A%E8%A7%A3%E5%86%B3"><span class="nav-number">3.4.9.</span> <span class="nav-text">索引失效原因及解决</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A8%E5%80%BC%E5%8C%B9%E9%85%8D"><span class="nav-number">3.4.9.1.</span> <span class="nav-text">全值匹配</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E5%8E%9F%E5%88%99"><span class="nav-number">3.4.9.1.1.</span> <span class="nav-text">最左前缀原则</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E7%B4%A2%E5%BC%95%E5%88%97%E4%B8%8A%E6%93%8D%E4%BD%9C"><span class="nav-number">3.4.9.2.</span> <span class="nav-text">在索引列上操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%E4%B8%8A%E8%BF%9B%E8%A1%8C%E8%8C%83%E5%9B%B4%E6%9F%A5%E6%89%BE"><span class="nav-number">3.4.9.3.</span> <span class="nav-text">在复合索引上进行范围查找</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%8D%E7%AD%89%E4%BA%8E%E8%BF%9B%E8%A1%8C%E8%BF%87%E6%BB%A4"><span class="nav-number">3.4.9.4.</span> <span class="nav-text">使用不等于进行过滤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8D%E4%B8%BA%E7%A9%BA%E5%88%A4%E6%96%AD"><span class="nav-number">3.4.9.5.</span> <span class="nav-text">不为空判断</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6%E5%8C%B9%E9%85%8D%E4%BB%A5-%E5%BC%80%E5%A4%B4"><span class="nav-number">3.4.9.6.</span> <span class="nav-text">通配符匹配以%开头</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E9%9A%90%E5%BD%A2%E8%BD%AC%E6%8D%A2"><span class="nav-number">3.4.9.7.</span> <span class="nav-text">数据隐形转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E4%B8%AD%E6%9C%89or"><span class="nav-number">3.4.9.8.</span> <span class="nav-text">条件中有or</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B-1"><span class="nav-number">3.4.10.</span> <span class="nav-text">案例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="nav-number">3.5.</span> <span class="nav-text">查询优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95"><span class="nav-number">3.5.1.</span> <span class="nav-text">使用覆盖索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="nav-number">3.5.2.</span> <span class="nav-text">单表查询优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95"><span class="nav-number">3.5.2.1.</span> <span class="nav-text">方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="nav-number">3.5.3.</span> <span class="nav-text">多表查询优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95-1"><span class="nav-number">3.5.3.1.</span> <span class="nav-text">方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Group-BY%E4%BC%98%E5%8C%96"><span class="nav-number">3.5.4.</span> <span class="nav-text">Group BY优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#limit%E4%BC%98%E5%8C%96"><span class="nav-number">3.5.5.</span> <span class="nav-text">limit优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="nav-number">3.6.</span> <span class="nav-text">日志分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="nav-number">3.6.1.</span> <span class="nav-text">慢查询日志</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="nav-number">3.6.1.1.</span> <span class="nav-text">开启慢查询日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%85%A2%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7"><span class="nav-number">3.6.1.2.</span> <span class="nav-text">慢日志分析工具</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E6%95%B0%E6%8D%AE%E8%84%9A%E6%9C%AC"><span class="nav-number">3.6.2.</span> <span class="nav-text">批量数据脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Show-Profile"><span class="nav-number">3.6.3.</span> <span class="nav-text">Show Profile</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">3.6.3.1.</span> <span class="nav-text">使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E7%8A%B6%E6%80%81"><span class="nav-number">3.6.3.2.</span> <span class="nav-text">需要注意的状态</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="nav-number">3.6.4.</span> <span class="nav-text">全局查询日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mysql%E9%94%81"><span class="nav-number">3.7.</span> <span class="nav-text">Mysql锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%94%81%E7%9A%84%E5%88%86%E7%B1%BB"><span class="nav-number">3.7.1.</span> <span class="nav-text">数据库锁的分类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%89%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C%E7%B1%BB%E5%9E%8B%E5%88%86%E7%B1%BB"><span class="nav-number">3.7.1.1.</span> <span class="nav-text">按数据操作类型分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%89%E6%93%8D%E4%BD%9C%E7%B2%92%E5%BA%A6%E5%88%86%E7%B1%BB"><span class="nav-number">3.7.1.2.</span> <span class="nav-text">按操作粒度分类</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A8%E9%94%81"><span class="nav-number">3.7.2.</span> <span class="nav-text">表锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E8%AF%B4%E6%98%8E"><span class="nav-number">3.7.2.1.</span> <span class="nav-text">案例说明</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%8C%E9%94%81"><span class="nav-number">3.7.3.</span> <span class="nav-text">行锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B1-innodb%E9%BB%98%E8%AE%A4%E4%BA%8B%E5%8A%A1%E7%BA%A7%E5%88%AB"><span class="nav-number">3.7.3.1.</span> <span class="nav-text">案例1-innodb默认事务级别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B2-%E8%A1%8C%E9%94%81"><span class="nav-number">3.7.3.2.</span> <span class="nav-text">案例2-行锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B3-%E8%A1%8C%E9%94%81%E5%A4%B1%E6%95%88"><span class="nav-number">3.7.3.3.</span> <span class="nav-text">案例3-行锁失效</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B4-%E9%97%B4%E9%9A%99%E9%94%81"><span class="nav-number">3.7.3.4.</span> <span class="nav-text">案例4-间隙锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B5-%E4%B8%BB%E5%8A%A8%E6%B7%BB%E5%8A%A0%E8%A1%8C%E9%94%81"><span class="nav-number">3.7.3.5.</span> <span class="nav-text">案例5-主动添加行锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B6-%E8%A1%8C%E9%94%81%E5%88%86%E6%9E%90"><span class="nav-number">3.7.3.6.</span> <span class="nav-text">案例6-行锁分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">3.7.3.7.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">3.7.3.8.</span> <span class="nav-text">优化建议</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B5%E9%94%81"><span class="nav-number">3.7.4.</span> <span class="nav-text">页锁</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">3.8.</span> <span class="nav-text">主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%AD%A5%E9%AA%A4"><span class="nav-number">3.8.1.</span> <span class="nav-text">基本步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E5%88%99"><span class="nav-number">3.8.2.</span> <span class="nav-text">原则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-number">3.8.3.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E%E7%9A%84%E5%B8%B8%E8%A7%81%E9%85%8D%E7%BD%AE"><span class="nav-number">3.8.4.</span> <span class="nav-text">一主一从的常见配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%A6%81%E6%B1%82"><span class="nav-number">3.8.4.1.</span> <span class="nav-text">基本要求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE"><span class="nav-number">3.8.4.2.</span> <span class="nav-text">主机配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8E%E6%9C%BA%E9%85%8D%E7%BD%AE"><span class="nav-number">3.8.4.3.</span> <span class="nav-text">从机配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E5%BB%BA%E7%AB%8B%E8%B4%A6%E6%88%B7%E5%B9%B6%E6%8E%88%E6%9D%83%E7%BB%99slave"><span class="nav-number">3.8.4.4.</span> <span class="nav-text">主机建立账户并授权给slave</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8E%E6%9C%BA%E8%BF%9E%E6%8E%A5%E4%B8%BB%E6%9C%BA"><span class="nav-number">3.8.4.5.</span> <span class="nav-text">从机连接主机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">3.8.4.6.</span> <span class="nav-text">测试</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL%E4%B9%8BMVVC%E7%AE%80%E4%BB%8B"><span class="nav-number">4.</span> <span class="nav-text">MySQL之MVVC简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%B8%B6%E4%BB%80%E4%B9%88%E6%98%AFMVCC%EF%BC%9F"><span class="nav-number">4.1.</span> <span class="nav-text">一丶什么是MVCC？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E4%B8%B6MVCC%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6"><span class="nav-number">4.2.</span> <span class="nav-text">二丶MVCC的实现机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E4%B8%B6MVCC%E4%B8%8B%E7%9A%84CRUD"><span class="nav-number">4.3.</span> <span class="nav-text">三丶MVCC下的CRUD</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84redo-undo"><span class="nav-number">5.</span> <span class="nav-text">数据库的redo,undo</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#redo"><span class="nav-number">5.0.0.1.</span> <span class="nav-text">redo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8redo-log%E5%8E%9F%E5%9B%A0"><span class="nav-number">5.0.0.2.</span> <span class="nav-text">使用redo log原因</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8redo-log%EF%BC%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B4%A9%E6%BA%83%EF%BC%8C%E5%AF%BC%E8%87%B4%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1%E5%8E%9F%E5%9B%A0"><span class="nav-number">5.0.0.3.</span> <span class="nav-text">使用redo log，数据库崩溃，导致数据丢失原因</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undo"><span class="nav-number">5.0.0.4.</span> <span class="nav-text">undo</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undo-log%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">5.0.1.</span> <span class="nav-text">undo log的作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undo-log%E7%9A%84%E5%86%99%E5%85%A5%E6%97%B6%E6%9C%BA"><span class="nav-number">5.0.2.</span> <span class="nav-text">undo log的写入时机</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2021 &mdash; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">true</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">328.5k</span>
  
</div>


  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>


  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://example.com/2024/04/16/MySQL%E5%9F%BA%E7%A1%80%E4%B8%8E%E9%AB%98%E7%BA%A7/';
          this.page.identifier = '2024/04/16/MySQL基础与高级/';
          this.page.title = 'MySQL基础与高级';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

  <script type="text/javascript" src="/lib/clipboard/clipboard.js"></script>

  
    <script src="/js/cursor/fireworks.js"></script>
  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"model":{"jsonPath":"/live2dw/assets/hibiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body>
</html>
